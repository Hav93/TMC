# 更新日志

本文档记录 TMC 项目的所有重要更改。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，  
版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

---

## [1.3.0-test] - 2025-10-19 🎉

**CloudDrive2 集成 - Web 配置界面**

### ✨ 新增
- **CloudDrive2 配置界面** - 在设置页面新增 CloudDrive2 标签页
  - Web 界面友好配置，无需手动编辑环境变量
  - 支持主机地址、端口、认证信息配置
  - 挂载点路径可视化设置
  - 实时表单验证和错误提示
- **连接测试功能** - 一键测试 CloudDrive2 连接
  - 验证 gRPC 服务可用性
  - 实时显示测试结果和错误信息
  - 帮助用户快速排查配置问题
- **配置管理 API** - 新增后端配置管理接口
  - `GET /api/settings/clouddrive2/` 获取配置
  - `PUT /api/settings/clouddrive2/` 更新配置
  - `POST /api/settings/clouddrive2/test` 测试连接

### 🔧 优化
- **115网盘上传方案优化** - 完全移除不稳定的直接上传实现
  - 删除 Python ECDH 加密实现（不稳定）
  - 删除 Go 二进制外部调用方案（维护困难）
  - 统一采用 CloudDrive2 方案（稳定可靠）
- **环境变量管理** - 改进配置持久化
  - 支持通过 Web 界面更新环境变量
  - 密码字段安全处理（显示为 ***）
  - 配置更新后提示重启生效

### 📚 文档
- 新增 `CLOUDDRIVE2_CONFIG_GUIDE.md` - 详细配置指南
- 新增 `CLOUDDRIVE2_QUICK_START.md` - 3分钟快速开始
- 新增 `CLOUDDRIVE2_SETTINGS_ADDED.md` - 功能说明文档
- 更新 `env.example` - 添加配置示例和说明

### 🗑️ 清理
- 删除 18 个失败的上传实现相关文件
  - `app/backend/utils/ecdh_cipher.py`
  - `app/backend/utils/upload115.py`
  - `app/backend/services/fake115uploader_wrapper.py`
  - 相关文档和测试脚本

---

## [1.1.2] - 2025-10-08 🚀

**登录系统全面优化**

### ✨ 新增
- **自动登出机制** - Token 过期时自动跳转到登录页
  - 全局 401 拦截器，自动清除状态并跳转
  - 防止重复触发（1秒时间窗口）
  - 手动登出后自动跳转
- **JWT 自动配置** - JWT_SECRET 支持自动生成
  - 不配置时自动生成随机密钥
  - 配置固定值可保持用户登录状态
  - 适配开发和生产环境

### 🔧 优化
- **Telegram 登录流程优化**
  - 使用 `SessionPasswordNeededError` 精准检测二步验证
  - 新增 `LoginErrorHandler` 统一处理所有登录错误
  - Session 超时自动重连，无需重新发送验证码
  - 完善登录状态清理机制
  - 验证码倒计时（60秒冷却）防止频繁发送
  - Session 预加载，避免重复登录
- **前端认证优化**
  - 使用 `useCallback` 稳定回调函数引用
  - 改进 `refreshUser` 错误处理，避免竞态条件
  - 解决 ESLint 依赖警告

### 🔧 修复
- **登录错误提示优化** - 支持以下详细错误类型：
  - 验证码错误/过期 (`PhoneCodeInvalidError`/`ExpiredError`)
  - 手机号格式错误/封禁/未注册 (`PhoneNumber*`)
  - 操作频繁限制 (`FloodWaitError`)
  - 网络连接超时
- 修复用户反馈的"机器人启动不了"和"user不存在"问题

### 📚 文档
- 清理临时优化文档（5个 MD 文件）
- 添加 `pyrightconfig.json` 忽略 Python 类型检查警告

---

## [1.1.0] - 2025-10-07 ✨

**功能优化与用户体验提升**

### ✨ 新增
- **详情弹窗优化** - 使用结构化的 `Descriptions` 组件展示聊天和消息详情
  - 聊天详情：带图标、标签、可复制字段，支持长文本折叠展开
  - 消息详情：消息内容/错误信息带背景高亮，字段清晰分组
  - 暗色/亮色主题自适应
- **日志过滤优化** - 过滤掉重复的系统启动日志和 SQLAlchemy SQL 查询日志
  - 不再显示前端目录检查日志
  - 不再显示 SQL 查询详细日志
  - 提升 Web 端日志可读性

### 🔧 修复
- **消息日志可靠性** - 实现日志记录的重试机制和失败队列
  - 添加 3 次重试逻辑，避免临时数据库连接问题导致日志丢失
  - 失败日志保存到队列，后台持续重试
  - 超过 1 小时的日志自动丢弃
- **TypeScript 类型错误** - 修复日期选择器和表格列筛选的类型问题

### 📚 文档
- 清理临时 Markdown 文档，保留核心项目文档（README、CHANGELOG、DEPLOYMENT）
- 归档临时说明性文档到 `_archived/docs/`

---

## [1.0.0] - 2025-10-06 🎉

**首个生产就绪版本发布！**

### ✨ 新增
- 主题系统支持 View Transitions API 动画效果
- 统一的色彩管理系统（`ThemeContext`）
- 容器日志支持 URL query 参数传递认证 token

### 🔧 修复
- **[关键]** 修复主题切换需要页面刷新的问题
- **[关键]** 修复容器日志 401 未授权错误
- **[关键]** 修复系统状态接口认证失败
- **[关键]** 解决 Alembic 数据库迁移"Multiple head revisions"冲突
- 修复 `localStorage` key 不一致问题（`token` vs `access_token`）
- 修复浏览器缓存导致的 JS 文件更新问题

### 🎨 优化
- 重构所有组件使用统一的主题色彩系统
- 移除所有内联样式中的 CSS 变量引用
- 优化主题切换性能，移除不必要的组件重渲染
- 统一 API 认证方式，支持 Header 和 Query 参数
- 改进错误日志输出，便于调试

### 🗂️ 项目管理
- 创建 `_archived` 文件夹归档非生产文件
- 整理项目文档，创建 `PROJECT_STATUS.md`
- 更新 `README.md` 为生产就绪版本
- 创建 `cleanup.ps1` 自动清理脚本

### 📝 文档
- 新增完整的部署指南
- 新增故障排查文档
- 新增系统架构说明
- 更新 API 认证文档

### 🔄 重构
- 统一前端主题系统架构
- 重构中间件认证逻辑
- 优化数据库迁移文件结构

### 🗑️ 移除
- 移除 `key={themeVersion}` 强制重渲染机制
- 清理临时开发文件和测试数据
- 归档开发文档和脚本

---

## [0.3.1] - 2025-10-06 (内部版本)

### ✨ 新增
- 用户头像上传功能
- 个人资料编辑页面
- 密码修改功能
- 用户管理 CRUD 接口

### 🔧 修复
- 修复用户表缺少 `avatar` 字段
- 优化认证流程

### 📝 文档
- 添加 API 类型生成指南
- 完善开发文档

---

## [0.3.0] - 2025-10-05 (内部版本)

### ✨ 新增（重大更新）
- **全面重构为前后端分离架构**
- 使用 FastAPI 替换 Flask
- React + TypeScript 前端
- Docker 容器化部署
- JWT 认证系统
- 实时容器日志流（SSE）
- 增强模式状态监控
- SQLAlchemy 异步 ORM
- Alembic 数据库迁移

### 🎨 界面
- 全新的现代化 UI 设计
- 响应式布局
- 深色/浅色主题支持
- 玻璃态视觉效果

### 🔐 安全
- JWT Token 认证
- 密码哈希存储
- 请求认证中间件
- CORS 配置

### 📊 功能
- 仪表板统计
- 转发规则管理
- 关键词过滤
- 消息替换规则
- 实时日志查看
- 聊天列表管理
- 客户端状态监控

---

## [0.2.x] - 历史版本 (内部开发)

### 功能特性
- 基础的消息转发功能
- 简单的规则配置
- Flask Web 界面
- SQLite 数据库

---

## 版本说明

### 版本号规则
- **主版本号(X)**: 不兼容的 API 修改
- **次版本号(Y)**: 向下兼容的功能性新增
- **修订号(Z)**: 向下兼容的问题修正

### 更新类型标识
- ✨ **新增**: 新功能
- 🔧 **修复**: Bug 修复
- 🎨 **优化**: 改进和优化
- 🗂️ **项目管理**: 项目结构调整
- 📝 **文档**: 文档更新
- 🔄 **重构**: 代码重构
- 🗑️ **移除**: 删除功能或代码
- 🔐 **安全**: 安全相关更新
- ⚡ **性能**: 性能优化

---

## 路线图

### 计划中的功能
- [ ] 消息统计图表增强
- [ ] 规则导入/导出功能
- [ ] 多语言支持（i18n）
- [ ] WebSocket 实时通知
- [ ] 高级过滤规则（正则表达式）
- [ ] 消息队列优化
- [ ] Redis 缓存支持
- [ ] PostgreSQL 支持
- [ ] 移动端 App

### 考虑中的改进
- [ ] 性能监控面板
- [ ] 自动备份功能
- [ ] 消息归档策略
- [ ] 更多主题选项
- [ ] 插件系统

---

**最后更新**: 2025-10-06  
**当前版本**: v1.0.0

