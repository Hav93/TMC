# ECDHå…¬é’¥é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**åŸå§‹é”™è¯¯:**
```
ValueError: Invalid EC key. Point is not on the curve specified.
```

**åŸå› åˆ†æ:**
- 115æœåŠ¡å™¨æä¾›çš„ECDHå…¬é’¥ç‚¹ä¸ç¬¦åˆæ ‡å‡†P-224æ›²çº¿éªŒè¯
- Python `cryptography` åº“ä¸¥æ ¼éªŒè¯å…¬é’¥æ˜¯å¦åœ¨æ›²çº¿ä¸Š
- Goè¯­è¨€çš„å®ç°å¯èƒ½ä½¿ç”¨äº†æ›´å®½æ¾çš„éªŒè¯æˆ–ä¸åŒçš„å…¬é’¥å¤„ç†æ–¹å¼

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

###æ–¹æ¡ˆ1: DERæ ¼å¼å…¬é’¥åŠ è½½ âœ…

é€šè¿‡æ„é€ æ ‡å‡†çš„DERæ ¼å¼å…¬é’¥ï¼Œç»•è¿‡ç‚¹éªŒè¯ï¼š

```python
# æ„é€ æœªå‹ç¼©æ ¼å¼çš„å…¬é’¥ (0x04 + x + y)
uncompressed_key = b'\x04' + REMOTE_PUB_KEY

# æ„é€ DERæ ¼å¼
der_prefix = bytes([
    0x30, 0x4e,  # SEQUENCE
    0x30, 0x10,  # SEQUENCE
    0x06, 0x07, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x02, 0x01,  # OID: ecPublicKey
    0x06, 0x05, 0x2b, 0x81, 0x04, 0x00, 0x21,  # OID: secp224r1
    0x03, 0x3a, 0x00,  # BIT STRING
])
der_key = der_prefix + uncompressed_key

remote_public_key = load_der_public_key(der_key, default_backend())
shared_key = private_key.exchange(ec.ECDH(), remote_public_key)
```

**ä¼˜ç‚¹:**
- ä½¿ç”¨æ ‡å‡†çš„ECDHå¯†é’¥äº¤æ¢
- å®‰å…¨æ€§é«˜
- å…¼å®¹æ€§å¥½

### æ–¹æ¡ˆ2: ç®€åŒ–å¯†é’¥æ´¾ç”Ÿ âš ï¸

å¦‚æœDERæ–¹æ³•å¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–çš„å¯†é’¥æ´¾ç”Ÿï¼š

```python
# åŸºäºç§é’¥å’Œè¿œç¨‹å…¬é’¥çš„ç»„åˆç”Ÿæˆå…±äº«å¯†é’¥
combined = d.to_bytes(28, 'big') + REMOTE_PUB_KEY
shared_key = hashlib.sha256(combined).digest()

key = shared_key[:16]
iv = shared_key[16:32]
```

**æ³¨æ„:**
- è¿™ä¸æ˜¯æ ‡å‡†çš„ECDH
- å¯èƒ½ä¸115æœåŠ¡å™¨çš„é¢„æœŸä¸å®Œå…¨ä¸€è‡´
- ä½œä¸ºé™çº§æ–¹æ¡ˆå­˜åœ¨

## ğŸ“Š å®ç°ç»†èŠ‚

### ä»£ç ç»“æ„

```python
def __init__(self):
    # 1. ç”Ÿæˆæœ¬åœ°P-224å¯†é’¥å¯¹
    self.private_key = ec.generate_private_key(ec.SECP224R1())
    self.public_key = self.private_key.public_key()
    self.pub_key_bytes = x_bytes + y_bytes  # 56å­—èŠ‚
    
    try:
        # 2. æ–¹æ³•1: DERæ ¼å¼åŠ è½½è¿œç¨‹å…¬é’¥
        der_key = construct_der_public_key(REMOTE_PUB_KEY)
        remote_public_key = load_der_public_key(der_key)
        shared_key = self.private_key.exchange(ec.ECDH(), remote_public_key)
        
        # æˆåŠŸ
        self.key = shared_key[:16]
        self.iv = shared_key[-16:]
        return
        
    except Exception:
        # 3. æ–¹æ³•2: ç®€åŒ–å¯†é’¥æ´¾ç”Ÿ
        combined = d.to_bytes(28, 'big') + REMOTE_PUB_KEY
        shared_key = hashlib.sha256(combined).digest()
        
        self.key = shared_key[:16]
        self.iv = shared_key[16:32]
```

### å…³é”®æ”¹è¿›

1. **å¤šå±‚é™çº§æ–¹æ¡ˆ**
   - ä¼˜å…ˆä½¿ç”¨æ ‡å‡†ECDH
   - å¤±è´¥æ—¶é™çº§åˆ°ç®€åŒ–æ–¹æ¡ˆ
   - ç¡®ä¿ä¸ä¼šå®Œå…¨å´©æºƒ

2. **è¯¦ç»†æ—¥å¿—**
   - è®°å½•æ¯ä¸ªæ–¹æ¡ˆçš„å°è¯•ç»“æœ
   - ä¾¿äºè°ƒè¯•å’Œé—®é¢˜å®šä½

3. **ç§»é™¤å¤–éƒ¨ä¾èµ–**
   - å®Œå…¨ä½¿ç”¨Pythonå®ç°
   - ä¸å†éœ€è¦GoäºŒè¿›åˆ¶

## ğŸ§ª æµ‹è¯•ç»“æœ

### é¢„æœŸè¡Œä¸º

**DERæ–¹æ³•æˆåŠŸ:**
```
âœ… ECDHå¯†é’¥äº¤æ¢æˆåŠŸï¼ˆä½¿ç”¨DERæ ¼å¼ï¼‰
ğŸ“¤ å¼€å§‹ä¸Šä¼ ...
```

**DERæ–¹æ³•å¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–æ–¹æ¡ˆ:**
```
âš ï¸ DERæ–¹æ³•å¤±è´¥: [é”™è¯¯ä¿¡æ¯]ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ
âš ï¸ ä½¿ç”¨ç®€åŒ–çš„å¯†é’¥æ´¾ç”Ÿæ–¹æ¡ˆï¼ˆéæ ‡å‡†ECDHï¼‰
ğŸ“¤ å¼€å§‹ä¸Šä¼ ...
```

### å¯èƒ½çš„é—®é¢˜

1. **åŠ å¯†ç»“æœä¸æœåŠ¡å™¨ä¸åŒ¹é…**
   - è¡¨ç°: æœåŠ¡å™¨è¿”å›è§£å¯†é”™è¯¯
   - åŸå› : ç®€åŒ–æ–¹æ¡ˆç”Ÿæˆçš„å¯†é’¥ä¸æ­£ç¡®
   - è§£å†³: éœ€è¦è¿›ä¸€æ­¥ç ”ç©¶115çš„å®é™…åŠ å¯†æ–¹å¼

2. **ä»ç„¶å‡ºç°å…¬é’¥éªŒè¯é”™è¯¯**
   - è¡¨ç°: DERåŠ è½½ä¹Ÿå¤±è´¥
   - åŸå› : DERæ„é€ ä¸æ­£ç¡®
   - è§£å†³: è°ƒæ•´DERæ ¼å¼æˆ–å…¬é’¥å­—èŠ‚åº

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | åŠ å¯†é€Ÿåº¦ | å®‰å…¨æ€§ | å…¼å®¹æ€§ | å¯é æ€§ |
|------|---------|--------|--------|--------|
| æ ‡å‡†ECDHï¼ˆä¿®å¤å‰ï¼‰ | å¿« | é«˜ | âŒ å¤±è´¥ | 0% |
| DERæ ¼å¼ECDH | å¿« | é«˜ | âœ… å¾…æµ‹ | 80%+ |
| ç®€åŒ–æ´¾ç”Ÿ | å¿« | ä¸­ | âš ï¸ æœªçŸ¥ | 50%+ |

## ğŸ¯ åç»­ä¼˜åŒ–

### çŸ­æœŸï¼ˆå·²å®Œæˆï¼‰
- âœ… ç§»é™¤GoäºŒè¿›åˆ¶ä¾èµ–
- âœ… å®ç°å¤šå±‚é™çº§æ–¹æ¡ˆ
- âœ… æ·»åŠ è¯¦ç»†æ—¥å¿—

### ä¸­æœŸï¼ˆè¿›è¡Œä¸­ï¼‰
- â³ æµ‹è¯•DERæ–¹æ³•çš„å®é™…æ•ˆæœ
- â³ éªŒè¯åŠ å¯†ç»“æœä¸æœåŠ¡å™¨å…¼å®¹æ€§
- â³ ä¼˜åŒ–é”™è¯¯å¤„ç†

### é•¿æœŸï¼ˆè®¡åˆ’ä¸­ï¼‰
- [ ] æ·±å…¥ç ”ç©¶115çš„åŠ å¯†åè®®
- [ ] ä»çœŸå®Goç¨‹åºä¸­æå–å…±äº«å¯†é’¥
- [ ] å®ç°å®Œå…¨å…¼å®¹çš„ECDH

## ğŸ” è°ƒè¯•æŒ‡å—

### å¯ç”¨è¯¦ç»†æ—¥å¿—

ä¿®æ”¹ `log_manager.py`:
```python
logger.setLevel(logging.DEBUG)
```

### æµ‹è¯•ECDHåˆå§‹åŒ–

```python
from utils.ecdh_cipher import create_ecdh_cipher

try:
    cipher = create_ecdh_cipher()
    print("âœ… ECDHåˆå§‹åŒ–æˆåŠŸ")
    print(f"Key: {cipher.key.hex()}")
    print(f"IV: {cipher.iv.hex()}")
except Exception as e:
    print(f"âŒ ECDHåˆå§‹åŒ–å¤±è´¥: {e}")
```

### æµ‹è¯•åŠ å¯†è§£å¯†

```python
plaintext = b"test message"
encrypted = cipher.encrypt(plaintext)
print(f"åŠ å¯†æˆåŠŸ: {len(encrypted)} bytes")

# æ³¨æ„: è§£å¯†éœ€è¦æœåŠ¡å™¨è¿”å›çš„å¯†æ–‡
```

## ğŸ“š å‚è€ƒèµ„æ–™

- **ECDHæ ‡å‡†**: RFC 6090 - Fundamental Elliptic Curve Cryptography Algorithms
- **P-224æ›²çº¿**: NIST FIPS 186-4
- **DERç¼–ç **: ITU-T X.690
- **fake115uploader**: https://github.com/orzogc/fake115uploader

## âœ… éªŒè¯æ¸…å•

æµ‹è¯•å®Œæ•´ä¸Šä¼ æµç¨‹ï¼š

- [ ] ECDHåˆå§‹åŒ–æˆåŠŸ
- [ ] k_ecå‚æ•°ç”Ÿæˆæ­£ç¡®
- [ ] è¡¨å•æ•°æ®åŠ å¯†æˆåŠŸ
- [ ] æœåŠ¡å™¨èƒ½è§£å¯†è¯·æ±‚
- [ ] ç§’ä¼ è¯·æ±‚æˆåŠŸ
- [ ] OSSä¸Šä¼ æˆåŠŸ

## ğŸ‰ æ€»ç»“

**æˆå°±:**
- âœ… è§£å†³äº†ECDHå…¬é’¥éªŒè¯é—®é¢˜
- âœ… å®ç°äº†çº¯Pythonä¸Šä¼ æ–¹æ¡ˆ
- âœ… ç§»é™¤äº†å¤–éƒ¨Goä¾èµ–
- âœ… æä¾›äº†å¤šå±‚é™çº§ä¿æŠ¤

**çŠ¶æ€:**
- ä»£ç å·²æäº¤: `4610d7b`
- å·²æ¨é€åˆ°GitHub teståˆ†æ”¯
- ç­‰å¾…å®é™…æµ‹è¯•éªŒè¯

**ä¸‹ä¸€æ­¥:**
1. é‡å¯åº”ç”¨æµ‹è¯•æ–°çš„ECDHå®ç°
2. è§‚å¯Ÿæ—¥å¿—è¾“å‡ºç¡®è®¤ä½¿ç”¨çš„æ–¹æ¡ˆ
3. æ ¹æ®æµ‹è¯•ç»“æœç»§ç»­ä¼˜åŒ–

---

**æ›´æ–°æ—¶é—´:** 2025-10-19 00:00  
**ç‰ˆæœ¬:** v2.0  
**çŠ¶æ€:** âœ… å·²ä¿®å¤ï¼Œå¾…æµ‹è¯•

