# æ··åˆæ¶æ„å¼€å‘å®Œæ•´æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è¿°](#æ¶æ„æ¦‚è¿°)
2. [ç°çŠ¶åˆ†æ](#ç°çŠ¶åˆ†æ)
3. [å¼€å‘è®¡åˆ’](#å¼€å‘è®¡åˆ’)
4. [è¯¦ç»†è®¾è®¡](#è¯¦ç»†è®¾è®¡)
5. [å®æ–½æ­¥éª¤](#å®æ–½æ­¥éª¤)
6. [æµ‹è¯•æ–¹æ¡ˆ](#æµ‹è¯•æ–¹æ¡ˆ)
7. [éƒ¨ç½²æ–¹æ¡ˆ](#éƒ¨ç½²æ–¹æ¡ˆ)
8. [115Botå€Ÿé‰´ä¸ä¼˜åŒ–](#115botå€Ÿé‰´ä¸ä¼˜åŒ–)
9. [é™„å½•](#é™„å½•)

---

## 1. æ¶æ„æ¦‚è¿°

### 1.1 æ ¸å¿ƒæ€æƒ³

**æ··åˆæ¶æ„ = è§„åˆ™ç‹¬ç«‹ + å¤„ç†ç»Ÿä¸€ + åŸºç¡€è®¾æ–½å…±äº«**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å±‚ï¼šè§„åˆ™ç‹¬ç«‹                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ForwardRule   â”‚  â”‚ResourceRule  â”‚  â”‚MediaMonitor  â”‚     â”‚
â”‚  â”‚(å·²æœ‰)        â”‚  â”‚(æ–°å»º)        â”‚  â”‚Rule(å·²æœ‰)    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¸šåŠ¡å±‚ï¼šå¤„ç†ç»Ÿä¸€ï¼ˆæ¶ˆæ¯å¤„ç†å™¨æ¨¡å¼ï¼‰               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            MessageDispatcher (æ¶ˆæ¯åˆ†å‘å™¨)             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚         â–¼                  â–¼                  â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚Forward      â”‚  â”‚Resource     â”‚  â”‚Media        â”‚        â”‚
â”‚  â”‚Processor    â”‚  â”‚Processor    â”‚  â”‚Processor    â”‚        â”‚
â”‚  â”‚(é‡æ„)       â”‚  â”‚(æ–°å»º)       â”‚  â”‚(åŒ…è£…)       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åŸºç¡€è®¾æ–½å±‚ï¼šå…±äº«åŸºç¡€è®¾æ–½ï¼ˆæ–°å»ºï¼‰                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ MessageCacheManager (æ¶ˆæ¯ç¼“å­˜)                       â”‚  â”‚
â”‚  â”‚ â€¢ SharedFilterEngine (å…±äº«è¿‡æ»¤å¼•æ“)                    â”‚  â”‚
â”‚  â”‚ â€¢ SmartRetryQueue (æ™ºèƒ½é‡è¯•é˜Ÿåˆ—)                       â”‚  â”‚
â”‚  â”‚ â€¢ BatchDatabaseWriter (æ‰¹é‡æ•°æ®åº“å†™å…¥)                 â”‚  â”‚
â”‚  â”‚ â€¢ PerformanceMonitor (æ€§èƒ½ç›‘æ§)                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 è®¾è®¡åŸåˆ™

1. **æœ€å°åŒ–æ”¹åŠ¨**ï¼šä¿ç•™ç°æœ‰ä»£ç ï¼Œæ¸è¿›å¼é‡æ„
2. **å‘åå…¼å®¹**ï¼šä¸ç ´åç°æœ‰åŠŸèƒ½
3. **æ€§èƒ½ä¼˜å…ˆ**ï¼šé€šè¿‡ç¼“å­˜å’Œæ‰¹é‡å¤„ç†æå‡æ€§èƒ½
4. **å¯æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°çš„å¤„ç†å™¨
5. **å¯è§‚æµ‹æ€§**ï¼šå®Œå–„çš„ç›‘æ§å’Œæ—¥å¿—

---

## 2. ç°çŠ¶åˆ†æ

### 2.1 å·²æœ‰ä»£ç æ¸…å•

#### âœ… å®Œæ•´å®ç°çš„æ¨¡å—

| æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½ | ä»£ç è¡Œæ•° | çŠ¶æ€ |
|---------|------|---------|------|
| `app/backend/telegram_client_manager.py` | Telegramå®¢æˆ·ç«¯ç®¡ç† | 2513è¡Œ | âœ… å®Œæ•´ |
| `app/backend/models.py` | æ•°æ®æ¨¡å‹å®šä¹‰ | 571è¡Œ | âœ… å®Œæ•´ |
| `app/backend/services/media_monitor_service.py` | åª’ä½“ç›‘æ§æœåŠ¡ | 1316è¡Œ | âœ… å®Œæ•´ |
| `app/backend/services/business_services.py` | ä¸šåŠ¡æœåŠ¡å±‚ | 661è¡Œ | âœ… å®Œæ•´ |
| `app/backend/filters.py` | å…³é”®è¯è¿‡æ»¤å’Œæ­£åˆ™æ›¿æ¢ | 154è¡Œ | âœ… å®Œæ•´ |
| `app/backend/database.py` | æ•°æ®åº“è¿æ¥ | ~100è¡Œ | âœ… å®Œæ•´ |

#### ğŸ”§ éœ€è¦é‡æ„çš„æ¨¡å—

| æ¨¡å— | å½“å‰ä½ç½® | é—®é¢˜ | é‡æ„æ–¹æ¡ˆ |
|------|---------|------|---------|
| **è½¬å‘é€»è¾‘** | `TelegramClientManager._process_message()` | 800+è¡Œä»£ç æ··åœ¨å®¢æˆ·ç«¯ç®¡ç†å™¨ä¸­ | æå–åˆ° `ForwardProcessor` |
| **æ¶ˆæ¯å¤„ç†** | `TelegramClientManager._forward_message()` | ç›´æ¥è°ƒç”¨ `self.client` | é€šè¿‡ `MessageContext` å°è£… |
| **æ—¥å¿—è®°å½•** | `TelegramClientManager._log_message()` | æ¯æ¡æ¶ˆæ¯å•ç‹¬å†™å…¥ | æ”¹ä¸ºæ‰¹é‡å†™å…¥ |

#### âŒ ç¼ºå¤±çš„æ¨¡å—

| æ¨¡å— | åŠŸèƒ½ | ä¼˜å…ˆçº§ |
|------|------|--------|
| `ResourceMonitorRule` æ¨¡å‹ | èµ„æºç›‘æ§è§„åˆ™æ•°æ®æ¨¡å‹ | ğŸ”´ P0 |
| `ResourceRecord` æ¨¡å‹ | èµ„æºè®°å½•æ•°æ®æ¨¡å‹ | ğŸ”´ P0 |
| `ResourceMonitorService` | èµ„æºç›‘æ§æœåŠ¡ | ğŸ”´ P0 |
| `MessageContext` | æ¶ˆæ¯å¤„ç†ä¸Šä¸‹æ–‡ | ğŸ”´ P0 |
| `MessageDispatcher` | æ¶ˆæ¯åˆ†å‘å™¨ | ğŸ”´ P0 |
| `SharedFilterEngine` | å…±äº«è¿‡æ»¤å¼•æ“ | ğŸŸ¡ P1 |
| `MessageCacheManager` | æ¶ˆæ¯ç¼“å­˜ç®¡ç†å™¨ | ğŸŸ¡ P1 |
| `SmartRetryQueue` | æ™ºèƒ½é‡è¯•é˜Ÿåˆ— | ğŸŸ¡ P1 |
| `BatchDatabaseWriter` | æ‰¹é‡æ•°æ®åº“å†™å…¥ | ğŸŸ¢ P2 |
| `PerformanceMonitor` | æ€§èƒ½ç›‘æ§ | ğŸŸ¢ P2 |

### 2.2 ç°æœ‰ä»£ç åˆ†æ

#### 2.2.1 æ¶ˆæ¯å¤„ç†æµç¨‹ï¼ˆå½“å‰ï¼‰

```python
# æ–‡ä»¶ï¼šapp/backend/telegram_client_manager.py (ç¬¬730-798è¡Œ)
async def _process_message(self, event, is_edited: bool = False):
    """å¤„ç†æ¶ˆæ¯ï¼ˆåœ¨ç‹¬ç«‹ä»»åŠ¡ä¸­è¿è¡Œï¼‰- ä¼˜åŒ–ç‰ˆ"""
    message = event.message
    
    # 1. è·å–èŠå¤©ID
    chat_id = self._get_chat_id(message)
    
    # 2. æ£€æŸ¥æ˜¯å¦åœ¨ç›‘å¬åˆ—è¡¨
    if chat_id not in self.monitored_chats:
        return
    
    # 3. å¤„ç†è½¬å‘è§„åˆ™ï¼ˆå†…è”é€»è¾‘ï¼Œ800+è¡Œï¼‰
    rules = await self._get_applicable_rules(chat_id)
    for rule in rules:
        await self._process_rule_safe(rule, message, event)
    
    # 4. å¤„ç†åª’ä½“ç›‘æ§è§„åˆ™
    await self._process_media_monitor(chat_id, message)
    
    # âŒ é—®é¢˜ï¼š
    # - è½¬å‘é€»è¾‘æ··åœ¨å®¢æˆ·ç«¯ç®¡ç†å™¨ä¸­
    # - æ²¡æœ‰èµ„æºç›‘æ§å¤„ç†
    # - æ²¡æœ‰ç»Ÿä¸€çš„åˆ†å‘æœºåˆ¶
```

#### 2.2.2 è½¬å‘æ¶ˆæ¯å®ç°ï¼ˆå½“å‰ï¼‰

```python
# æ–‡ä»¶ï¼šapp/backend/telegram_client_manager.py (ç¬¬1106-1139è¡Œ)
async def _forward_message(self, rule: ForwardRule, original_message, text_to_forward: str):
    """è½¬å‘æ¶ˆæ¯ï¼ˆæ”¯æŒæ–‡æœ¬å’Œåª’ä½“æ¶ˆæ¯ï¼‰"""
    target_chat_id = int(rule.target_chat_id)
    
    # âœ… ä¼˜ç‚¹ï¼šå®ç°å®Œæ•´ï¼Œæ”¯æŒæ–‡æœ¬å’Œåª’ä½“
    if original_message.media:
        await self.client.send_message(
            target_chat_id,
            text_to_forward,
            file=original_message.media
        )
    else:
        await self.client.send_message(
            target_chat_id,
            text_to_forward
        )
    
    # âŒ é—®é¢˜ï¼š
    # - ç›´æ¥è°ƒç”¨ self.clientï¼ˆäº‹ä»¶å¾ªç¯é—®é¢˜ï¼‰
    # - æ²¡æœ‰é‡è¯•æœºåˆ¶
    # - æ²¡æœ‰æ‰¹é‡å¤„ç†
```

#### 2.2.3 åª’ä½“ç›‘æ§å®ç°ï¼ˆå½“å‰ï¼‰

```python
# æ–‡ä»¶ï¼šapp/backend/services/media_monitor_service.py (ç¬¬238-618è¡Œ)
class MediaMonitorService:
    """åª’ä½“ç›‘æ§æœåŠ¡"""
    
    def __init__(self):
        self.active_monitors: Dict[int, bool] = {}
        self.download_queue = asyncio.Queue()
        self.download_workers: List[asyncio.Task] = []
    
    async def process_message(self, client, message, rule_id: int):
        """å¤„ç†æ¶ˆæ¯"""
        # 1. æ£€æŸ¥è§„åˆ™
        # 2. åº”ç”¨è¿‡æ»¤å™¨
        # 3. åˆ›å»ºä¸‹è½½ä»»åŠ¡
        # 4. åŠ å…¥é˜Ÿåˆ—
        pass
    
    # âœ… ä¼˜ç‚¹ï¼š
    # - å·²ç»æ˜¯ç‹¬ç«‹æœåŠ¡
    # - æœ‰é˜Ÿåˆ—å’Œå·¥ä½œçº¿ç¨‹
    # - å®ç°å®Œæ•´
    
    # ğŸ”§ éœ€è¦ä¼˜åŒ–ï¼š
    # - ä¸æ–°æ¶æ„é›†æˆ
    # - æ·»åŠ æ‰¹é‡å¤„ç†
```

### 2.3 æ•°æ®åº“ç»“æ„åˆ†æ

#### å·²æœ‰è¡¨ç»“æ„

```sql
-- 1. forward_rules (è½¬å‘è§„åˆ™) âœ…
CREATE TABLE forward_rules (
    id INTEGER PRIMARY KEY,
    name VARCHAR(100),
    source_chat_id VARCHAR(50),  -- å•ä¸ªèŠå¤©ID
    target_chat_id VARCHAR(50),
    is_active BOOLEAN,
    enable_keyword_filter BOOLEAN,
    enable_regex_replace BOOLEAN,
    -- ... å…¶ä»–å­—æ®µ
);

-- 2. media_monitor_rules (åª’ä½“ç›‘æ§è§„åˆ™) âœ…
CREATE TABLE media_monitor_rules (
    id INTEGER PRIMARY KEY,
    name VARCHAR(100),
    source_chats TEXT,  -- JSON: å¤šä¸ªèŠå¤©ID
    is_active BOOLEAN,
    -- ... å…¶ä»–å­—æ®µ
);

-- 3. message_logs (æ¶ˆæ¯æ—¥å¿—) âœ…
CREATE TABLE message_logs (
    id INTEGER PRIMARY KEY,
    rule_id INTEGER,
    source_chat_id VARCHAR(50),
    status VARCHAR(20),
    -- ... å…¶ä»–å­—æ®µ
);

-- 4. download_tasks (ä¸‹è½½ä»»åŠ¡) âœ…
CREATE TABLE download_tasks (
    id INTEGER PRIMARY KEY,
    rule_id INTEGER,
    message_id INTEGER,
    status VARCHAR(20),
    -- ... å…¶ä»–å­—æ®µ
);

-- 5. media_files (åª’ä½“æ–‡ä»¶) âœ…
CREATE TABLE media_files (
    id INTEGER PRIMARY KEY,
    task_id INTEGER,
    file_name VARCHAR(500),
    file_type VARCHAR(50),
    -- ... å…¶ä»–å­—æ®µ
);
```

#### éœ€è¦æ–°å»ºçš„è¡¨

```sql
-- 6. resource_monitor_rules (èµ„æºç›‘æ§è§„åˆ™) âŒ æ–°å»º
CREATE TABLE resource_monitor_rules (
    id INTEGER PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    source_chats TEXT NOT NULL,  -- JSON: ["chat_id1", "chat_id2"]
    is_active BOOLEAN DEFAULT TRUE,
    
    -- é“¾æ¥è¿‡æ»¤
    link_types TEXT,  -- JSON: ["pan115", "magnet", "ed2k"]
    keywords TEXT,  -- JSON: [{"keyword": "xxx", "is_exclude": false}]
    
    -- 115é…ç½®
    auto_save_to_115 BOOLEAN DEFAULT FALSE,
    target_path VARCHAR(500),
    pan115_user_key VARCHAR(100),  -- å¯ä»¥ä¸ºç©ºï¼Œä½¿ç”¨å…¨å±€é…ç½®
    
    -- æ ‡ç­¾
    default_tags TEXT,  -- JSON: ["tag1", "tag2"]
    
    -- å»é‡
    enable_deduplication BOOLEAN DEFAULT TRUE,
    dedup_time_window INTEGER DEFAULT 3600,
    
    -- æ—¶é—´æˆ³
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 7. resource_records (èµ„æºè®°å½•) âŒ æ–°å»º
CREATE TABLE resource_records (
    id INTEGER PRIMARY KEY,
    rule_id INTEGER NOT NULL,
    rule_name VARCHAR(100),
    
    -- æ¶ˆæ¯ä¿¡æ¯
    source_chat_id VARCHAR(50),
    source_chat_name VARCHAR(200),
    message_id INTEGER,
    message_text TEXT,
    message_date DATETIME,
    
    -- é“¾æ¥ä¿¡æ¯
    link_type VARCHAR(20),  -- 'pan115', 'magnet', 'ed2k'
    link_url TEXT NOT NULL,
    link_hash VARCHAR(64),  -- MD5å“ˆå¸Œï¼Œç”¨äºå»é‡
    
    -- 115è½¬å­˜ä¿¡æ¯
    save_status VARCHAR(20) DEFAULT 'pending',  -- pending, saving, success, failed, ignored
    save_path VARCHAR(500),
    save_error TEXT,
    save_time DATETIME,
    retry_count INTEGER DEFAULT 0,
    
    -- æ ‡ç­¾
    tags TEXT,  -- JSON: ["tag1", "tag2"]
    
    -- æ¶ˆæ¯å¿«ç…§
    message_snapshot TEXT,  -- JSON: å®Œæ•´æ¶ˆæ¯æ•°æ®
    
    -- æ—¶é—´æˆ³
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (rule_id) REFERENCES resource_monitor_rules(id) ON DELETE CASCADE
);

-- 8. retry_tasks (é‡è¯•ä»»åŠ¡) âŒ æ–°å»º
CREATE TABLE retry_tasks (
    id INTEGER PRIMARY KEY,
    task_id VARCHAR(64) UNIQUE NOT NULL,  -- MD5å“ˆå¸Œ
    task_type VARCHAR(20) NOT NULL,  -- 'forward', 'resource', 'media'
    task_data TEXT NOT NULL,  -- JSON
    
    -- é”™è¯¯ä¿¡æ¯
    error_type VARCHAR(50),
    last_error TEXT,
    
    -- é‡è¯•ä¿¡æ¯
    attempt INTEGER DEFAULT 0,
    max_attempts INTEGER DEFAULT 5,
    next_retry_time DATETIME,
    
    -- æ—¶é—´æˆ³
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 9. notification_rules (é€šçŸ¥è§„åˆ™) âŒ æ–°å»º
CREATE TABLE notification_rules (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,  -- ç”¨æˆ·IDï¼ŒNULLè¡¨ç¤ºå…¨å±€è§„åˆ™
    notification_type VARCHAR(50) NOT NULL,  -- é€šçŸ¥ç±»å‹
    is_active BOOLEAN DEFAULT TRUE,
    
    -- é€šçŸ¥æ¸ é“é…ç½®
    telegram_chat_id VARCHAR(50),  -- TelegramèŠå¤©ID
    webhook_url VARCHAR(500),  -- Webhook URL
    email_address VARCHAR(200),  -- é‚®ç®±åœ°å€
    
    -- é€šçŸ¥é¢‘ç‡æ§åˆ¶
    min_interval INTEGER DEFAULT 0,  -- æœ€å°é—´éš”ï¼ˆç§’ï¼‰
    max_per_hour INTEGER DEFAULT 0,  -- æ¯å°æ—¶æœ€å¤§æ•°é‡ï¼ˆ0è¡¨ç¤ºä¸é™åˆ¶ï¼‰
    
    -- æ—¶é—´æˆ³
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_notification_type (notification_type),
    INDEX idx_user_id (user_id)
);

-- 10. notification_logs (é€šçŸ¥å†å²) âŒ æ–°å»º
CREATE TABLE notification_logs (
    id INTEGER PRIMARY KEY,
    notification_type VARCHAR(50) NOT NULL,
    message TEXT NOT NULL,
    channels VARCHAR(200),  -- é€šçŸ¥æ¸ é“ï¼ˆé€—å·åˆ†éš”ï¼‰
    user_id INTEGER,
    sent_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_sent_at (sent_at),
    INDEX idx_notification_type (notification_type)
);
```

---

## 3. å¼€å‘è®¡åˆ’

### 3.1 é˜¶æ®µåˆ’åˆ†

#### ğŸ”´ é˜¶æ®µ1ï¼šæ ¸å¿ƒæ¶æ„ï¼ˆP0ï¼Œ3-4å¤©ï¼‰

**ç›®æ ‡**ï¼šå»ºç«‹æ··åˆæ¶æ„åŸºç¡€ï¼Œå®ç°èµ„æºç›‘æ§MVP

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥ä½œé‡ | ä¾èµ– |
|------|------|--------|------|
| 1.1 åˆ›å»ºæ•°æ®æ¨¡å‹ | `models.py` | 0.5å¤© | æ—  |
| 1.2 åˆ›å»ºæ•°æ®åº“è¿ç§» | `alembic/versions/xxx.py` | 0.5å¤© | 1.1 |
| 1.3 åˆ›å»ºæ¶ˆæ¯ä¸Šä¸‹æ–‡ | `services/message_context.py` | 0.5å¤© | æ—  |
| 1.4 åˆ›å»ºæ¶ˆæ¯åˆ†å‘å™¨ | `services/message_dispatcher.py` | 1å¤© | 1.3 |
| 1.5 åˆ›å»ºèµ„æºç›‘æ§æœåŠ¡ | `services/resource_monitor_service.py` | 1å¤© | 1.1 |
| 1.6 é›†æˆåˆ°å®¢æˆ·ç«¯ç®¡ç†å™¨ | `telegram_client_manager.py` | 0.5å¤© | 1.4, 1.5 |
| 1.7 åˆ›å»ºAPIè·¯ç”± | `api/routes/resource_monitor.py` | 0.5å¤© | 1.5 |

#### ğŸŸ¡ é˜¶æ®µ2ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆP1ï¼Œ2-3å¤©ï¼‰

**ç›®æ ‡**ï¼šæ·»åŠ ç¼“å­˜ã€æ‰¹é‡å¤„ç†ã€æ™ºèƒ½é‡è¯•

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥ä½œé‡ | ä¾èµ– |
|------|------|--------|------|
| 2.1 æ¶ˆæ¯ç¼“å­˜ç®¡ç†å™¨ | `services/common/message_cache.py` | 0.5å¤© | é˜¶æ®µ1 |
| 2.2 å…±äº«è¿‡æ»¤å¼•æ“ | `services/common/filter_engine.py` | 0.5å¤© | é˜¶æ®µ1 |
| 2.3 æ™ºèƒ½é‡è¯•é˜Ÿåˆ— | `services/common/retry_queue.py` | 1å¤© | é˜¶æ®µ1 |
| 2.4 æ‰¹é‡æ•°æ®åº“å†™å…¥ | `services/common/batch_writer.py` | 1å¤© | é˜¶æ®µ1 |

#### ğŸŸ¢ é˜¶æ®µ3ï¼šå‰ç«¯ç•Œé¢ï¼ˆP1ï¼Œ2-3å¤©ï¼‰

**ç›®æ ‡**ï¼šå®Œå–„å‰ç«¯ç•Œé¢ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥ä½œé‡ | ä¾èµ– |
|------|------|--------|------|
| 3.1 è§„åˆ™åˆ—è¡¨é¡µé¢ | `frontend/src/pages/ResourceMonitor/RuleList.tsx` | 0.5å¤© | é˜¶æ®µ1 |
| 3.2 è§„åˆ™è¡¨å•é¡µé¢ | `frontend/src/pages/ResourceMonitor/RuleForm.tsx` | 1å¤© | é˜¶æ®µ1 |
| 3.3 è®°å½•åˆ—è¡¨é¡µé¢ | `frontend/src/pages/ResourceMonitor/RecordList.tsx` | 1å¤© | é˜¶æ®µ1 |
| 3.4 å¿«æ·åˆ›å»ºå‘å¯¼ | `frontend/src/pages/ResourceMonitor/QuickWizard.tsx` | 0.5å¤© | 3.1, 3.2 |

#### ğŸŸ¢ é˜¶æ®µ4ï¼šç›‘æ§å’Œä¼˜åŒ–ï¼ˆP2ï¼Œ1-2å¤©ï¼‰

**ç›®æ ‡**ï¼šæ·»åŠ ç›‘æ§é¢æ¿ï¼Œä¼˜åŒ–æ€§èƒ½

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥ä½œé‡ | ä¾èµ– |
|------|------|--------|------|
| 4.1 æ€§èƒ½ç›‘æ§å™¨ | `services/common/performance_monitor.py` | 0.5å¤© | é˜¶æ®µ2 |
| 4.2 ç›‘æ§API | `api/routes/monitor.py` | 0.5å¤© | 4.1 |
| 4.3 ç›‘æ§é¢æ¿ | `frontend/src/pages/Monitor/Dashboard.tsx` | 1å¤© | 4.2 |

#### ğŸŸ¡ é˜¶æ®µ5ï¼šæ¨é€é€šçŸ¥ç³»ç»Ÿï¼ˆP1ï¼Œ2-3å¤©ï¼‰

**ç›®æ ‡**ï¼šå®ç°å®Œæ•´çš„æ¨é€é€šçŸ¥åŠŸèƒ½

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥ä½œé‡ | ä¾èµ– |
|------|------|--------|------|
| 5.1 é€šçŸ¥æœåŠ¡æ ¸å¿ƒ | `services/notification_service.py` | 1å¤© | é˜¶æ®µ1 |
| 5.2 é€šçŸ¥æ¨¡æ¿å¼•æ“ | `services/notification_templates.py` | 0.5å¤© | 5.1 |
| 5.3 é€šçŸ¥API | `api/routes/notifications.py` | 0.5å¤© | 5.1 |
| 5.4 å‰ç«¯é€šçŸ¥ä¸­å¿ƒ | `frontend/src/components/NotificationCenter.tsx` | 1å¤© | 5.3 |

### 3.2 æ—¶é—´çº¿

```
Week 1:
  Day 1-2: é˜¶æ®µ1.1-1.4 (æ•°æ®æ¨¡å‹ + æ¶ˆæ¯åˆ†å‘å™¨)
  Day 3-4: é˜¶æ®µ1.5-1.7 (èµ„æºç›‘æ§æœåŠ¡ + API)
  Day 5:   æµ‹è¯•å’Œä¿®å¤

Week 2:
  Day 1-2: é˜¶æ®µ2.1-2.4 (æ€§èƒ½ä¼˜åŒ–)
  Day 3-4: é˜¶æ®µ3.1-3.3 (å‰ç«¯ç•Œé¢)
  Day 5:   é˜¶æ®µ4 (ç›‘æ§é¢æ¿)

Week 3:
  Day 1-2: é˜¶æ®µ5 (æ¨é€é€šçŸ¥ç³»ç»Ÿ)
  Day 3-5: å®Œæ•´æµ‹è¯•å’Œä¼˜åŒ–

Week 4:
  Day 1-3: 115Botå€Ÿé‰´åŠŸèƒ½ (ç§’ä¼ /è¿‡æ»¤/è°ƒåº¦)
  Day 4-5: æ–‡æ¡£å’Œéƒ¨ç½²
```

---

## 4. è¯¦ç»†è®¾è®¡

### 4.1 æ ¸å¿ƒç±»è®¾è®¡

#### 4.1.1 MessageContextï¼ˆæ¶ˆæ¯ä¸Šä¸‹æ–‡ï¼‰

```python
# æ–‡ä»¶ï¼šapp/backend/services/message_context.py
from dataclasses import dataclass
from typing import Any, Optional
import asyncio

@dataclass
class MessageContext:
    """
    æ¶ˆæ¯å¤„ç†ä¸Šä¸‹æ–‡
    
    ä½œç”¨ï¼š
    1. å°è£…æ¶ˆæ¯å’Œå®¢æˆ·ç«¯ç®¡ç†å™¨
    2. æä¾›å®‰å…¨çš„å®¢æˆ·ç«¯æ“ä½œæ–¹æ³•
    3. å¤„ç†äº‹ä»¶å¾ªç¯é—®é¢˜
    """
    
    message: Any  # Telethon Message å¯¹è±¡
    client_manager: 'TelegramClientManager'
    chat_id: int
    is_edited: bool = False
    
    # ç¼“å­˜çš„å¤„ç†ç»“æœï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
    _extracted_links: Optional[dict] = None
    _matched_keywords: Optional[list] = None
    
    async def send_message(self, chat_id: int, text: str, **kwargs):
        """
        å®‰å…¨åœ°å‘é€æ¶ˆæ¯
        
        è‡ªåŠ¨å¤„ç†ï¼š
        - äº‹ä»¶å¾ªç¯åˆ‡æ¢
        - è¿æ¥çŠ¶æ€æ£€æŸ¥
        - è¶…æ—¶æ§åˆ¶
        """
        return await self.client_manager._safe_send_message(
            chat_id, text, **kwargs
        )
    
    async def download_media(self, file_path: str):
        """å®‰å…¨åœ°ä¸‹è½½åª’ä½“"""
        return await self.client_manager._safe_download_media(
            self.message, file_path
        )
    
    def is_connected(self) -> bool:
        """æ£€æŸ¥å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€"""
        return self.client_manager.connected
    
    def get_extracted_links(self) -> dict:
        """è·å–æå–çš„é“¾æ¥ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
        if self._extracted_links is None:
            from services.link_extractor import LinkExtractor
            self._extracted_links = LinkExtractor.extract_all(
                self.message.text or ""
            )
        return self._extracted_links
    
    def get_matched_keywords(self, keywords: list) -> list:
        """è·å–åŒ¹é…çš„å…³é”®è¯ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
        cache_key = tuple(sorted(keywords))
        if self._matched_keywords is None:
            self._matched_keywords = {}
        
        if cache_key not in self._matched_keywords:
            from filters import KeywordFilter
            filter_engine = KeywordFilter()
            self._matched_keywords[cache_key] = filter_engine.match(
                self.message.text or "", keywords
            )
        
        return self._matched_keywords[cache_key]
```

**å…³é”®ç‚¹ï¼š**
- âœ… å°è£…å®¢æˆ·ç«¯æ“ä½œï¼Œé¿å…ç›´æ¥è®¿é—® `self.client`
- âœ… è‡ªåŠ¨å¤„ç†äº‹ä»¶å¾ªç¯é—®é¢˜
- âœ… ç¼“å­˜å¤„ç†ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
- âœ… æä¾›ä¾¿æ·æ–¹æ³•ï¼Œç®€åŒ–å¤„ç†å™¨ä»£ç 

#### 4.1.2 MessageDispatcherï¼ˆæ¶ˆæ¯åˆ†å‘å™¨ï¼‰

```python
# æ–‡ä»¶ï¼šapp/backend/services/message_dispatcher.py
from typing import List, Dict
import asyncio
import time

class MessageProcessor:
    """æ¶ˆæ¯å¤„ç†å™¨åŸºç±»"""
    
    async def should_process(self, context: MessageContext) -> bool:
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥å¤„ç†è¿™æ¡æ¶ˆæ¯"""
        raise NotImplementedError
    
    async def process(self, context: MessageContext) -> bool:
        """å¤„ç†æ¶ˆæ¯ï¼Œè¿”å›æ˜¯å¦æˆåŠŸ"""
        raise NotImplementedError

class MessageDispatcher:
    """
    æ¶ˆæ¯åˆ†å‘å™¨
    
    ä½œç”¨ï¼š
    1. ç»Ÿä¸€ç®¡ç†æ‰€æœ‰å¤„ç†å™¨
    2. å¹¶å‘æ‰§è¡Œå¤„ç†å™¨
    3. æ”¶é›†å¤„ç†ç»“æœ
    4. æ€§èƒ½ç›‘æ§
    """
    
    def __init__(self):
        self.processors: List[MessageProcessor] = []
        self.stats = {
            'total_messages': 0,
            'total_processing_time': 0,
            'processor_stats': {}
        }
    
    def register(self, processor: MessageProcessor):
        """æ³¨å†Œå¤„ç†å™¨"""
        self.processors.append(processor)
        processor_name = processor.__class__.__name__
        self.stats['processor_stats'][processor_name] = {
            'processed': 0,
            'success': 0,
            'failed': 0,
            'avg_time': 0
        }
    
    async def dispatch(self, context: MessageContext) -> Dict[str, bool]:
        """
        åˆ†å‘æ¶ˆæ¯ç»™æ‰€æœ‰å¤„ç†å™¨
        
        è¿”å›ï¼š{processor_name: success}
        """
        start_time = time.time()
        self.stats['total_messages'] += 1
        
        # 1. ç­›é€‰éœ€è¦å¤„ç†çš„å¤„ç†å™¨
        active_processors = []
        for processor in self.processors:
            if await processor.should_process(context):
                active_processors.append(processor)
        
        if not active_processors:
            return {}
        
        # 2. å¹¶å‘æ‰§è¡Œæ‰€æœ‰å¤„ç†å™¨
        tasks = []
        for processor in active_processors:
            task = asyncio.create_task(
                self._process_with_stats(processor, context)
            )
            tasks.append((processor.__class__.__name__, task))
        
        # 3. ç­‰å¾…æ‰€æœ‰å¤„ç†å™¨å®Œæˆ
        results = {}
        for processor_name, task in tasks:
            try:
                success = await task
                results[processor_name] = success
            except Exception as e:
                logger.error(f"å¤„ç†å™¨ {processor_name} æ‰§è¡Œå¤±è´¥: {e}")
                results[processor_name] = False
        
        # 4. æ›´æ–°ç»Ÿè®¡
        processing_time = time.time() - start_time
        self.stats['total_processing_time'] += processing_time
        
        return results
    
    async def _process_with_stats(self, processor: MessageProcessor, context: MessageContext) -> bool:
        """æ‰§è¡Œå¤„ç†å™¨å¹¶è®°å½•ç»Ÿè®¡"""
        processor_name = processor.__class__.__name__
        stats = self.stats['processor_stats'][processor_name]
        
        start_time = time.time()
        stats['processed'] += 1
        
        try:
            success = await processor.process(context)
            if success:
                stats['success'] += 1
            else:
                stats['failed'] += 1
            
            # æ›´æ–°å¹³å‡å¤„ç†æ—¶é—´
            processing_time = time.time() - start_time
            stats['avg_time'] = (
                (stats['avg_time'] * (stats['processed'] - 1) + processing_time) 
                / stats['processed']
            )
            
            return success
            
        except Exception as e:
            stats['failed'] += 1
            logger.error(f"å¤„ç†å™¨ {processor_name} æ‰§è¡Œå¼‚å¸¸: {e}")
            return False
    
    def get_stats(self) -> dict:
        """è·å–ç»Ÿè®¡æ•°æ®"""
        return {
            'total_messages': self.stats['total_messages'],
            'avg_processing_time': (
                self.stats['total_processing_time'] / self.stats['total_messages']
                if self.stats['total_messages'] > 0 else 0
            ),
            'processors': self.stats['processor_stats']
        }
```

**å…³é”®ç‚¹ï¼š**
- âœ… ç»Ÿä¸€çš„å¤„ç†å™¨æ¥å£
- âœ… å¹¶å‘æ‰§è¡Œï¼Œäº’ä¸é˜»å¡
- âœ… å®Œæ•´çš„ç»Ÿè®¡æ•°æ®
- âœ… å¼‚å¸¸éš”ç¦»ï¼Œå•ä¸ªå¤„ç†å™¨å¤±è´¥ä¸å½±å“å…¶ä»–

#### 4.1.3 ResourceMonitorServiceï¼ˆèµ„æºç›‘æ§æœåŠ¡ï¼‰

```python
# æ–‡ä»¶ï¼šapp/backend/services/resource_monitor_service.py
import json
import hashlib
from datetime import datetime, timedelta
from typing import List, Dict, Optional
from sqlalchemy import select, and_
from sqlalchemy.ext.asyncio import AsyncSession

from log_manager import get_logger
from database import get_db
from models import ResourceMonitorRule, ResourceRecord

logger = get_logger("resource_monitor", "enhanced_bot.log")

class LinkExtractor:
    """é“¾æ¥æå–å™¨"""
    
    PATTERNS = {
        'pan115': [
            r'https?://(?:115|115cdn)\.com/s/[a-zA-Z0-9]+(?:\?password=[a-zA-Z0-9]+)?',
            r'115://[a-zA-Z0-9]+',
        ],
        'magnet': [
            r'magnet:\?xt=urn:btih:[a-zA-Z0-9]{32,40}[^\s]*',
        ],
        'ed2k': [
            r'ed2k://\|file\|[^\|]+\|[0-9]+\|[a-fA-F0-9]{32}\|[^\s]*',
        ]
    }
    
    @classmethod
    def extract_all(cls, text: str) -> Dict[str, List[str]]:
        """æå–æ‰€æœ‰ç±»å‹çš„é“¾æ¥"""
        import re
        
        results = {}
        for link_type, patterns in cls.PATTERNS.items():
            links = []
            for pattern in patterns:
                matches = re.findall(pattern, text, re.IGNORECASE)
                links.extend(matches)
            
            if links:
                results[link_type] = list(set(links))  # å»é‡
        
        return results
    
    @classmethod
    def calculate_hash(cls, link: str) -> str:
        """è®¡ç®—é“¾æ¥å“ˆå¸Œï¼ˆç”¨äºå»é‡ï¼‰"""
        return hashlib.md5(link.encode()).hexdigest()

class ResourceMonitorService:
    """
    èµ„æºç›‘æ§æœåŠ¡
    
    åŠŸèƒ½ï¼š
    1. ç›‘æ§æ¶ˆæ¯ä¸­çš„èµ„æºé“¾æ¥
    2. æå–115/ç£åŠ›/ed2ké“¾æ¥
    3. è‡ªåŠ¨è½¬å­˜åˆ°115ç½‘ç›˜
    4. å»é‡å’Œæ ‡ç­¾ç®¡ç†
    """
    
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def get_active_rules_for_chat(self, chat_id: int) -> List[ResourceMonitorRule]:
        """è·å–èŠå¤©çš„æ´»è·ƒè§„åˆ™"""
        result = await self.db.execute(
            select(ResourceMonitorRule).where(
                ResourceMonitorRule.is_active == True
            )
        )
        all_rules = result.scalars().all()
        
        # è¿‡æ»¤åŒ¹é…çš„è§„åˆ™
        matched_rules = []
        for rule in all_rules:
            source_chats = json.loads(rule.source_chats) if rule.source_chats else []
            source_chat_ids = [int(c) for c in source_chats]
            
            if int(chat_id) in source_chat_ids:
                matched_rules.append(rule)
        
        return matched_rules
    
    async def handle_new_message(self, context: MessageContext):
        """
        å¤„ç†æ–°æ¶ˆæ¯
        
        æµç¨‹ï¼š
        1. è·å–é€‚ç”¨çš„è§„åˆ™
        2. æå–é“¾æ¥
        3. å…³é”®è¯è¿‡æ»¤
        4. å»é‡æ£€æŸ¥
        5. åˆ›å»ºè®°å½•
        6. è‡ªåŠ¨è½¬å­˜ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        """
        try:
            # 1. è·å–è§„åˆ™
            rules = await self.get_active_rules_for_chat(context.chat_id)
            if not rules:
                return
            
            logger.info(f"æ‰¾åˆ° {len(rules)} ä¸ªèµ„æºç›‘æ§è§„åˆ™")
            
            # 2. æå–é“¾æ¥
            links = context.get_extracted_links()
            if not links:
                logger.info("æ¶ˆæ¯ä¸­æœªæ‰¾åˆ°é“¾æ¥")
                return
            
            logger.info(f"æå–åˆ°é“¾æ¥: {links}")
            
            # 3. å¤„ç†æ¯ä¸ªè§„åˆ™
            for rule in rules:
                await self._process_rule(context, rule, links)
                
        except Exception as e:
            logger.error(f"å¤„ç†æ¶ˆæ¯å¤±è´¥: {e}", exc_info=True)
    
    async def _process_rule(self, context: MessageContext, rule: ResourceMonitorRule, links: dict):
        """å¤„ç†å•ä¸ªè§„åˆ™"""
        try:
            # 1. å…³é”®è¯è¿‡æ»¤
            if rule.keywords:
                keywords = json.loads(rule.keywords)
                matched = context.get_matched_keywords([k['keyword'] for k in keywords])
                if not matched:
                    logger.info(f"è§„åˆ™ {rule.name} å…³é”®è¯ä¸åŒ¹é…")
                    return
            
            # 2. é“¾æ¥ç±»å‹è¿‡æ»¤
            link_types = json.loads(rule.link_types) if rule.link_types else []
            
            # 3. å¤„ç†æ¯ä¸ªé“¾æ¥
            for link_type in link_types:
                if link_type not in links:
                    continue
                
                for link_url in links[link_type]:
                    await self._process_link(context, rule, link_type, link_url)
                    
        except Exception as e:
            logger.error(f"å¤„ç†è§„åˆ™ {rule.name} å¤±è´¥: {e}", exc_info=True)
    
    async def _process_link(self, context: MessageContext, rule: ResourceMonitorRule, 
                           link_type: str, link_url: str):
        """å¤„ç†å•ä¸ªé“¾æ¥"""
        try:
            # 1. å»é‡æ£€æŸ¥
            link_hash = LinkExtractor.calculate_hash(link_url)
            
            if rule.enable_deduplication:
                if await self._is_duplicate(link_hash, rule.dedup_time_window):
                    logger.info(f"é“¾æ¥å·²å­˜åœ¨ï¼ˆå»é‡ï¼‰: {link_url[:50]}")
                    return
            
            # 2. åˆ›å»ºè®°å½•
            record = await self._create_record(context, rule, link_type, link_url, link_hash)
            
            # 3. è‡ªåŠ¨è½¬å­˜
            if rule.auto_save_to_115 and link_type == 'pan115':
                await self._auto_save_to_115(record, rule)
                
        except Exception as e:
            logger.error(f"å¤„ç†é“¾æ¥å¤±è´¥: {e}", exc_info=True)
    
    async def _is_duplicate(self, link_hash: str, time_window: int) -> bool:
        """æ£€æŸ¥é“¾æ¥æ˜¯å¦é‡å¤"""
        cutoff_time = datetime.now() - timedelta(seconds=time_window)
        
        result = await self.db.execute(
            select(ResourceRecord).where(
                and_(
                    ResourceRecord.link_hash == link_hash,
                    ResourceRecord.created_at >= cutoff_time
                )
            ).limit(1)
        )
        
        return result.scalar_one_or_none() is not None
    
    async def _create_record(self, context: MessageContext, rule: ResourceMonitorRule,
                            link_type: str, link_url: str, link_hash: str) -> ResourceRecord:
        """åˆ›å»ºèµ„æºè®°å½•"""
        # è·å–é»˜è®¤æ ‡ç­¾
        default_tags = json.loads(rule.default_tags) if rule.default_tags else []
        
        # åˆ›å»ºæ¶ˆæ¯å¿«ç…§
        message_snapshot = {
            'id': context.message.id,
            'date': context.message.date.isoformat() if context.message.date else None,
            'text': context.message.text or "",
            'chat_id': context.chat_id
        }
        
        record = ResourceRecord(
            rule_id=rule.id,
            rule_name=rule.name,
            source_chat_id=str(context.chat_id),
            message_id=context.message.id,
            message_text=context.message.text or "",
            message_date=context.message.date,
            link_type=link_type,
            link_url=link_url,
            link_hash=link_hash,
            save_status='pending',
            tags=json.dumps(default_tags),
            message_snapshot=json.dumps(message_snapshot)
        )
        
        self.db.add(record)
        await self.db.commit()
        await self.db.refresh(record)
        
        logger.info(f"âœ… åˆ›å»ºèµ„æºè®°å½•: {record.id}")
        return record
    
    async def _auto_save_to_115(self, record: ResourceRecord, rule: ResourceMonitorRule):
        """è‡ªåŠ¨è½¬å­˜åˆ°115"""
        try:
            from services.pan115_service import Pan115Service
            
            # æ›´æ–°çŠ¶æ€ä¸º"è½¬å­˜ä¸­"
            record.save_status = 'saving'
            await self.db.commit()
            
            # æ‰§è¡Œè½¬å­˜
            pan115_service = Pan115Service(self.db)
            
            # æå–åˆ†äº«ç 
            import re
            match = re.search(r'/s/([a-zA-Z0-9]+)', record.link_url)
            if not match:
                raise ValueError("æ— æ³•æå–åˆ†äº«ç ")
            
            share_code = match.group(1)
            
            # è°ƒç”¨è½¬å­˜API
            result = await pan115_service.save_share(
                share_code=share_code,
                target_path=rule.target_path or "/",
                user_key=rule.pan115_user_key
            )
            
            # æ›´æ–°è®°å½•
            record.save_status = 'success'
            record.save_path = rule.target_path
            record.save_time = datetime.now()
            await self.db.commit()
            
            logger.info(f"âœ… è½¬å­˜æˆåŠŸ: {record.id}")
            
        except Exception as e:
            logger.error(f"è½¬å­˜å¤±è´¥: {e}", exc_info=True)
            
            # æ›´æ–°å¤±è´¥çŠ¶æ€
            record.save_status = 'failed'
            record.save_error = str(e)
            record.retry_count += 1
            await self.db.commit()
            
            # åŠ å…¥é‡è¯•é˜Ÿåˆ—
            from services.common.retry_queue import get_retry_queue
            retry_queue = get_retry_queue()
            await retry_queue.add_task('resource', {
                'record_id': record.id,
                'share_code': share_code,
                'target_path': rule.target_path
            }, e)
```

**å…³é”®ç‚¹ï¼š**
- âœ… å®Œæ•´çš„é“¾æ¥æå–é€»è¾‘
- âœ… å…³é”®è¯è¿‡æ»¤å’Œå»é‡
- âœ… è‡ªåŠ¨è½¬å­˜åˆ°115
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•
- âœ… æ¶ˆæ¯å¿«ç…§ä¿å­˜

#### 4.1.4 NotificationServiceï¼ˆæ¨é€é€šçŸ¥æœåŠ¡ï¼‰

```python
# æ–‡ä»¶ï¼šapp/backend/services/notification_service.py
from typing import Dict, List, Optional, Any
from enum import Enum
from datetime import datetime
import asyncio
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

from log_manager import get_logger
from database import get_db
from models import NotificationRule, NotificationLog

logger = get_logger("notification", "enhanced_bot.log")

class NotificationType(Enum):
    """é€šçŸ¥ç±»å‹"""
    DOWNLOAD_COMPLETE = "download_complete"      # ä¸‹è½½å®Œæˆ
    DOWNLOAD_FAILED = "download_failed"          # ä¸‹è½½å¤±è´¥
    RESOURCE_CAPTURED = "resource_captured"      # èµ„æºæ•è·
    SAVE_115_SUCCESS = "save_115_success"        # 115è½¬å­˜æˆåŠŸ
    SAVE_115_FAILED = "save_115_failed"          # 115è½¬å­˜å¤±è´¥
    TASK_STALE = "task_stale"                    # ä»»åŠ¡å¡ä½
    STORAGE_WARNING = "storage_warning"          # å­˜å‚¨ç©ºé—´è­¦å‘Š
    DAILY_REPORT = "daily_report"                # æ¯æ—¥æŠ¥å‘Š

class NotificationChannel(Enum):
    """é€šçŸ¥æ¸ é“"""
    TELEGRAM = "telegram"        # Telegramæ¶ˆæ¯
    WEB_PUSH = "web_push"        # Webæ¨é€
    EMAIL = "email"              # é‚®ä»¶
    WEBHOOK = "webhook"          # Webhook

class NotificationService:
    """
    æ¨é€é€šçŸ¥æœåŠ¡
    
    åŠŸèƒ½ï¼š
    1. å¤šæ¸ é“æ¨é€ï¼ˆTelegram/Web/Email/Webhookï¼‰
    2. æ¨¡æ¿åŒ–æ¶ˆæ¯
    3. é€šçŸ¥è§„åˆ™ç®¡ç†
    4. é€šçŸ¥å†å²è®°å½•
    5. æ‰¹é‡æ¨é€
    """
    
    def __init__(self, db: AsyncSession):
        self.db = db
        self.template_engine = NotificationTemplateEngine()
    
    async def send_notification(
        self,
        notification_type: NotificationType,
        data: Dict[str, Any],
        channels: Optional[List[NotificationChannel]] = None,
        user_id: Optional[int] = None
    ):
        """
        å‘é€é€šçŸ¥
        
        Args:
            notification_type: é€šçŸ¥ç±»å‹
            data: é€šçŸ¥æ•°æ®
            channels: é€šçŸ¥æ¸ é“ï¼ˆNoneè¡¨ç¤ºä½¿ç”¨é»˜è®¤æ¸ é“ï¼‰
            user_id: ç”¨æˆ·IDï¼ˆNoneè¡¨ç¤ºå‘é€ç»™æ‰€æœ‰ç”¨æˆ·ï¼‰
        """
        try:
            # 1. è·å–é€šçŸ¥è§„åˆ™
            rules = await self._get_applicable_rules(notification_type, user_id)
            if not rules:
                logger.debug(f"æ²¡æœ‰é€‚ç”¨çš„é€šçŸ¥è§„åˆ™: {notification_type.value}")
                return
            
            # 2. ç”Ÿæˆé€šçŸ¥å†…å®¹
            message = self.template_engine.render(notification_type, data)
            
            # 3. ç¡®å®šé€šçŸ¥æ¸ é“
            if channels is None:
                channels = [NotificationChannel.TELEGRAM]  # é»˜è®¤Telegram
            
            # 4. å‘é€åˆ°å„ä¸ªæ¸ é“
            for channel in channels:
                await self._send_to_channel(channel, message, data, rules)
            
            # 5. è®°å½•é€šçŸ¥å†å²
            await self._log_notification(notification_type, message, channels, user_id)
            
            logger.info(f"âœ… é€šçŸ¥å‘é€æˆåŠŸ: {notification_type.value}")
            
        except Exception as e:
            logger.error(f"âŒ é€šçŸ¥å‘é€å¤±è´¥: {e}", exc_info=True)
    
    async def _get_applicable_rules(
        self, 
        notification_type: NotificationType, 
        user_id: Optional[int]
    ) -> List[NotificationRule]:
        """è·å–é€‚ç”¨çš„é€šçŸ¥è§„åˆ™"""
        query = select(NotificationRule).where(
            NotificationRule.is_active == True,
            NotificationRule.notification_type == notification_type.value
        )
        
        if user_id:
            query = query.where(NotificationRule.user_id == user_id)
        
        result = await self.db.execute(query)
        return result.scalars().all()
    
    async def _send_to_channel(
        self,
        channel: NotificationChannel,
        message: str,
        data: Dict[str, Any],
        rules: List[NotificationRule]
    ):
        """å‘é€åˆ°æŒ‡å®šæ¸ é“"""
        if channel == NotificationChannel.TELEGRAM:
            await self._send_telegram(message, data, rules)
        elif channel == NotificationChannel.WEB_PUSH:
            await self._send_web_push(message, data, rules)
        elif channel == NotificationChannel.EMAIL:
            await self._send_email(message, data, rules)
        elif channel == NotificationChannel.WEBHOOK:
            await self._send_webhook(message, data, rules)
    
    async def _send_telegram(
        self,
        message: str,
        data: Dict[str, Any],
        rules: List[NotificationRule]
    ):
        """å‘é€Telegramé€šçŸ¥"""
        from telegram_client_manager import get_client_manager
        
        for rule in rules:
            if not rule.telegram_chat_id:
                continue
            
            try:
                client_manager = get_client_manager()
                if client_manager and client_manager.connected:
                    # ä½¿ç”¨MessageContextå®‰å…¨å‘é€
                    await client_manager.send_notification(
                        chat_id=int(rule.telegram_chat_id),
                        message=message
                    )
                    logger.info(f"ğŸ“± Telegramé€šçŸ¥å·²å‘é€: {rule.telegram_chat_id}")
            except Exception as e:
                logger.error(f"Telegramé€šçŸ¥å‘é€å¤±è´¥: {e}")
    
    async def _send_web_push(
        self,
        message: str,
        data: Dict[str, Any],
        rules: List[NotificationRule]
    ):
        """å‘é€Webæ¨é€é€šçŸ¥"""
        # TODO: å®ç°Web Pushé€šçŸ¥
        logger.info("ğŸ“² Webæ¨é€é€šçŸ¥ï¼ˆå¾…å®ç°ï¼‰")
    
    async def _send_email(
        self,
        message: str,
        data: Dict[str, Any],
        rules: List[NotificationRule]
    ):
        """å‘é€é‚®ä»¶é€šçŸ¥"""
        # TODO: å®ç°é‚®ä»¶é€šçŸ¥
        logger.info("ğŸ“§ é‚®ä»¶é€šçŸ¥ï¼ˆå¾…å®ç°ï¼‰")
    
    async def _send_webhook(
        self,
        message: str,
        data: Dict[str, Any],
        rules: List[NotificationRule]
    ):
        """å‘é€Webhooké€šçŸ¥"""
        import aiohttp
        
        for rule in rules:
            if not rule.webhook_url:
                continue
            
            try:
                async with aiohttp.ClientSession() as session:
                    payload = {
                        'message': message,
                        'data': data,
                        'timestamp': datetime.now().isoformat()
                    }
                    async with session.post(rule.webhook_url, json=payload) as resp:
                        if resp.status == 200:
                            logger.info(f"ğŸ”— Webhooké€šçŸ¥å·²å‘é€: {rule.webhook_url}")
                        else:
                            logger.error(f"Webhooké€šçŸ¥å¤±è´¥: {resp.status}")
            except Exception as e:
                logger.error(f"Webhooké€šçŸ¥å‘é€å¤±è´¥: {e}")
    
    async def _log_notification(
        self,
        notification_type: NotificationType,
        message: str,
        channels: List[NotificationChannel],
        user_id: Optional[int]
    ):
        """è®°å½•é€šçŸ¥å†å²"""
        log = NotificationLog(
            notification_type=notification_type.value,
            message=message,
            channels=','.join([c.value for c in channels]),
            user_id=user_id,
            sent_at=datetime.now()
        )
        self.db.add(log)
        await self.db.commit()

class NotificationTemplateEngine:
    """é€šçŸ¥æ¨¡æ¿å¼•æ“"""
    
    TEMPLATES = {
        NotificationType.DOWNLOAD_COMPLETE: """
âœ… ä¸‹è½½å®Œæˆ

æ–‡ä»¶å: {file_name}
å¤§å°: {file_size_mb}MB
ç”¨æ—¶: {duration}
å½’æ¡£è·¯å¾„: {final_path}
        """,
        
        NotificationType.DOWNLOAD_FAILED: """
âŒ ä¸‹è½½å¤±è´¥

æ–‡ä»¶å: {file_name}
é”™è¯¯: {error_message}
é‡è¯•æ¬¡æ•°: {retry_count}
        """,
        
        NotificationType.RESOURCE_CAPTURED: """
ğŸ” æ•è·åˆ°æ–°èµ„æº

è§„åˆ™: {rule_name}
é“¾æ¥ç±»å‹: {link_type}
é“¾æ¥: {link_url}
æ¥æº: {source_chat}
        """,
        
        NotificationType.SAVE_115_SUCCESS: """
âš¡ 115è½¬å­˜æˆåŠŸ

æ–‡ä»¶å: {file_name}
ç›®æ ‡è·¯å¾„: {target_path}
æ˜¯å¦ç§’ä¼ : {is_quick}
        """,
        
        NotificationType.SAVE_115_FAILED: """
âŒ 115è½¬å­˜å¤±è´¥

æ–‡ä»¶å: {file_name}
é”™è¯¯: {error_message}
é‡è¯•æ¬¡æ•°: {retry_count}
        """,
        
        NotificationType.TASK_STALE: """
âš ï¸ ä»»åŠ¡å¼‚å¸¸

å‘ç° {count} ä¸ªé•¿æ—¶é—´æœªå®Œæˆçš„ä»»åŠ¡
æœ€é•¿æ—¶é—´: {max_duration}
å»ºè®®æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        """,
        
        NotificationType.STORAGE_WARNING: """
âš ï¸ å­˜å‚¨ç©ºé—´è­¦å‘Š

å·²ç”¨ç©ºé—´: {used_gb}GB
æ€»ç©ºé—´: {total_gb}GB
ä½¿ç”¨ç‡: {usage_percent}%
å‰©ä½™ç©ºé—´: {remain_gb}GB
        """,
        
        NotificationType.DAILY_REPORT: """
ğŸ“Š æ¯æ—¥ç»Ÿè®¡æŠ¥å‘Š

æ—¥æœŸ: {date}

ä¸‹è½½ä»»åŠ¡:
- æ€»è®¡: {total_downloads}
- æˆåŠŸ: {success_downloads}
- å¤±è´¥: {failed_downloads}

èµ„æºæ•è·:
- æ€»è®¡: {total_resources}
- å·²è½¬å­˜: {saved_resources}

å­˜å‚¨ä½¿ç”¨:
- æœ¬åœ°: {local_storage_gb}GB
- 115: {pan115_storage_gb}GB
        """
    }
    
    def render(self, notification_type: NotificationType, data: Dict[str, Any]) -> str:
        """æ¸²æŸ“é€šçŸ¥æ¶ˆæ¯"""
        template = self.TEMPLATES.get(notification_type, "{message}")
        
        try:
            return template.format(**data)
        except KeyError as e:
            logger.error(f"æ¨¡æ¿æ¸²æŸ“å¤±è´¥ï¼Œç¼ºå°‘å­—æ®µ: {e}")
            return f"é€šçŸ¥: {notification_type.value}\næ•°æ®: {data}"

# å…¨å±€é€šçŸ¥æœåŠ¡å®ä¾‹
_notification_service = None

async def get_notification_service() -> NotificationService:
    """è·å–é€šçŸ¥æœåŠ¡å®ä¾‹"""
    global _notification_service
    if _notification_service is None:
        async for db in get_db():
            _notification_service = NotificationService(db)
            break
    return _notification_service
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```python
# åœ¨ä¸‹è½½å®Œæˆåå‘é€é€šçŸ¥
async def _execute_download(self, task_data: Dict[str, Any]):
    # ... ä¸‹è½½é€»è¾‘ ...
    
    # ä¸‹è½½æˆåŠŸï¼Œå‘é€é€šçŸ¥
    notification_service = await get_notification_service()
    await notification_service.send_notification(
        notification_type=NotificationType.DOWNLOAD_COMPLETE,
        data={
            'file_name': task_data['file_name'],
            'file_size_mb': file_size_mb,
            'duration': f"{duration:.1f}ç§’",
            'final_path': final_path
        },
        channels=[NotificationChannel.TELEGRAM, NotificationChannel.WEB_PUSH]
    )

# åœ¨èµ„æºæ•è·åå‘é€é€šçŸ¥
async def _create_record(self, context, rule, link_type, link_url, link_hash):
    # ... åˆ›å»ºè®°å½• ...
    
    # å‘é€é€šçŸ¥
    notification_service = await get_notification_service()
    await notification_service.send_notification(
        notification_type=NotificationType.RESOURCE_CAPTURED,
        data={
            'rule_name': rule.name,
            'link_type': link_type,
            'link_url': link_url[:50] + '...',
            'source_chat': context.chat_id
        }
    )
```

**å…³é”®ç‚¹ï¼š**
- âœ… å¤šæ¸ é“æ”¯æŒï¼ˆTelegram/Web/Email/Webhookï¼‰
- âœ… æ¨¡æ¿åŒ–æ¶ˆæ¯ï¼Œæ˜“äºå®šåˆ¶
- âœ… é€šçŸ¥è§„åˆ™ç®¡ç†ï¼Œçµæ´»æ§åˆ¶
- âœ… é€šçŸ¥å†å²è®°å½•
- âœ… å¼‚æ­¥éé˜»å¡å‘é€

### 4.2 æ•°æ®æµç¨‹å›¾

#### 4.2.1 æ¶ˆæ¯å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  1. æ¶ˆæ¯æ¥æ”¶                                 â”‚
â”‚  TelegramClientManager._process_message(event)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  2. åˆ›å»ºä¸Šä¸‹æ–‡                               â”‚
â”‚  context = MessageContext(                                  â”‚
â”‚      message=event.message,                                 â”‚
â”‚      client_manager=self,                                   â”‚
â”‚      chat_id=self._get_chat_id(message)                     â”‚
â”‚  )                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  3. åˆ†å‘æ¶ˆæ¯                                 â”‚
â”‚  results = await dispatcher.dispatch(context)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ForwardProcessorâ”‚ â”‚ResourceProcessorâ”‚ â”‚ MediaProcessor  â”‚
â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚
â”‚ should_process()â”‚ â”‚ should_process()â”‚ â”‚ should_process()â”‚
â”‚       â”‚         â”‚ â”‚       â”‚         â”‚ â”‚       â”‚         â”‚
â”‚       â–¼         â”‚ â”‚       â–¼         â”‚ â”‚       â–¼         â”‚
â”‚   process()     â”‚ â”‚   process()     â”‚ â”‚   process()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  4. è¿”å›ç»“æœ                                 â”‚
â”‚  {                                                          â”‚
â”‚    'ForwardProcessor': True,                                â”‚
â”‚    'ResourceProcessor': True,                               â”‚
â”‚    'MediaProcessor': False                                  â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.2 èµ„æºç›‘æ§æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              1. ResourceProcessor.process()                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         2. è·å–é€‚ç”¨çš„è§„åˆ™                                     â”‚
â”‚  rules = await service.get_active_rules_for_chat(chat_id)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         3. æå–é“¾æ¥ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰                               â”‚
â”‚  links = context.get_extracted_links()                      â”‚
â”‚  # è¿”å›: {'pan115': [...], 'magnet': [...]}                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         4. éå†è§„åˆ™                                          â”‚
â”‚  for rule in rules:                                         â”‚
â”‚      await service._process_rule(context, rule, links)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         5. å…³é”®è¯è¿‡æ»¤ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰                             â”‚
â”‚  matched = context.get_matched_keywords(keywords)           â”‚
â”‚  if not matched: return                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         6. éå†é“¾æ¥                                          â”‚
â”‚  for link_type in link_types:                               â”‚
â”‚      for link_url in links[link_type]:                      â”‚
â”‚          await service._process_link(...)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         7. å»é‡æ£€æŸ¥                                          â”‚
â”‚  link_hash = calculate_hash(link_url)                       â”‚
â”‚  if is_duplicate(link_hash): return                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         8. åˆ›å»ºè®°å½•                                          â”‚
â”‚  record = ResourceRecord(...)                               â”‚
â”‚  db.add(record)                                             â”‚
â”‚  await db.commit()                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         9. è‡ªåŠ¨è½¬å­˜ï¼ˆå¦‚æœå¯ç”¨ï¼‰                               â”‚
â”‚  if rule.auto_save_to_115:                                  â”‚
â”‚      await service._auto_save_to_115(record, rule)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ è½¬å­˜æˆåŠŸ â”‚               â”‚ è½¬å­˜å¤±è´¥ â”‚
        â”‚ status=  â”‚               â”‚ status=  â”‚
        â”‚ success  â”‚               â”‚ failed   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ åŠ å…¥é‡è¯•é˜Ÿåˆ—      â”‚
                              â”‚ retry_queue.add()â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. å®æ–½æ­¥éª¤

### 5.1 é˜¶æ®µ1è¯¦ç»†æ­¥éª¤

#### Step 1.1: åˆ›å»ºæ•°æ®æ¨¡å‹ï¼ˆ0.5å¤©ï¼‰

**æ–‡ä»¶ï¼š`app/backend/models.py`**

```python
# åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä»¥ä¸‹æ¨¡å‹

class ResourceMonitorRule(Base):
    """èµ„æºç›‘æ§è§„åˆ™æ¨¡å‹"""
    __tablename__ = 'resource_monitor_rules'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(100), nullable=False, comment='è§„åˆ™åç§°')
    source_chats = Column(Text, nullable=False, comment='æºèŠå¤©åˆ—è¡¨(JSON)')
    is_active = Column(Boolean, default=True, comment='æ˜¯å¦å¯ç”¨')
    
    # é“¾æ¥è¿‡æ»¤
    link_types = Column(Text, comment='é“¾æ¥ç±»å‹(JSON): ["pan115", "magnet", "ed2k"]')
    keywords = Column(Text, comment='å…³é”®è¯(JSON)')
    
    # 115é…ç½®
    auto_save_to_115 = Column(Boolean, default=False, comment='æ˜¯å¦è‡ªåŠ¨è½¬å­˜åˆ°115')
    target_path = Column(String(500), comment='ç›®æ ‡è·¯å¾„')
    pan115_user_key = Column(String(100), comment='115ç”¨æˆ·å¯†é’¥ï¼ˆå¯é€‰ï¼‰')
    
    # æ ‡ç­¾
    default_tags = Column(Text, comment='é»˜è®¤æ ‡ç­¾(JSON)')
    
    # å»é‡
    enable_deduplication = Column(Boolean, default=True, comment='æ˜¯å¦å¯ç”¨å»é‡')
    dedup_time_window = Column(Integer, default=3600, comment='å»é‡æ—¶é—´çª—å£(ç§’)')
    
    # æ—¶é—´æˆ³
    created_at = Column(DateTime, default=get_local_now, comment='åˆ›å»ºæ—¶é—´')
    updated_at = Column(DateTime, default=get_local_now, onupdate=get_local_now, comment='æ›´æ–°æ—¶é—´')
    
    # å…³ç³»
    records = relationship("ResourceRecord", back_populates="rule", cascade="all, delete-orphan")
    
    def __repr__(self):
        return f"<ResourceMonitorRule(id={self.id}, name='{self.name}')>"

class ResourceRecord(Base):
    """èµ„æºè®°å½•æ¨¡å‹"""
    __tablename__ = 'resource_records'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    rule_id = Column(Integer, ForeignKey('resource_monitor_rules.id'), nullable=False)
    rule_name = Column(String(100), comment='è§„åˆ™åç§°ï¼ˆå†—ä½™ï¼‰')
    
    # æ¶ˆæ¯ä¿¡æ¯
    source_chat_id = Column(String(50), comment='æºèŠå¤©ID')
    source_chat_name = Column(String(200), comment='æºèŠå¤©åç§°')
    message_id = Column(Integer, comment='æ¶ˆæ¯ID')
    message_text = Column(Text, comment='æ¶ˆæ¯æ–‡æœ¬')
    message_date = Column(DateTime, comment='æ¶ˆæ¯æ—¶é—´')
    
    # é“¾æ¥ä¿¡æ¯
    link_type = Column(String(20), comment='é“¾æ¥ç±»å‹')
    link_url = Column(Text, nullable=False, comment='é“¾æ¥URL')
    link_hash = Column(String(64), index=True, comment='é“¾æ¥å“ˆå¸Œï¼ˆç”¨äºå»é‡ï¼‰')
    
    # 115è½¬å­˜ä¿¡æ¯
    save_status = Column(String(20), default='pending', comment='è½¬å­˜çŠ¶æ€')
    save_path = Column(String(500), comment='è½¬å­˜è·¯å¾„')
    save_error = Column(Text, comment='è½¬å­˜é”™è¯¯ä¿¡æ¯')
    save_time = Column(DateTime, comment='è½¬å­˜æ—¶é—´')
    retry_count = Column(Integer, default=0, comment='é‡è¯•æ¬¡æ•°')
    
    # æ ‡ç­¾
    tags = Column(Text, comment='æ ‡ç­¾(JSON)')
    
    # æ¶ˆæ¯å¿«ç…§
    message_snapshot = Column(Text, comment='æ¶ˆæ¯å¿«ç…§(JSON)')
    
    # æ—¶é—´æˆ³
    created_at = Column(DateTime, default=get_local_now, comment='åˆ›å»ºæ—¶é—´')
    updated_at = Column(DateTime, default=get_local_now, onupdate=get_local_now, comment='æ›´æ–°æ—¶é—´')
    
    # å…³ç³»
    rule = relationship("ResourceMonitorRule", back_populates="records")
    
    def __repr__(self):
        return f"<ResourceRecord(id={self.id}, link_type='{self.link_type}', status='{self.save_status}')>"
```

**æµ‹è¯•ï¼š**
```bash
# æ£€æŸ¥æ¨¡å‹å®šä¹‰
python -c "from app.backend.models import ResourceMonitorRule, ResourceRecord; print('âœ… æ¨¡å‹å®šä¹‰æ­£ç¡®')"
```

#### Step 1.2: åˆ›å»ºæ•°æ®åº“è¿ç§»ï¼ˆ0.5å¤©ï¼‰

**æ–‡ä»¶ï¼š`app/backend/alembic/versions/20250112_add_resource_monitor.py`**

```python
"""add resource monitor tables

Revision ID: 20250112_add_resource_monitor
Revises: <ä¸Šä¸€ä¸ªè¿ç§»ID>
Create Date: 2025-01-12 10:00:00.000000

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic.
revision = '20250112_add_resource_monitor'
down_revision = '<ä¸Šä¸€ä¸ªè¿ç§»ID>'  # éœ€è¦å¡«å†™
branch_labels = None
depends_on = None

def upgrade():
    # åˆ›å»º resource_monitor_rules è¡¨
    op.create_table(
        'resource_monitor_rules',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('name', sa.String(length=100), nullable=False),
        sa.Column('source_chats', sa.Text(), nullable=False),
        sa.Column('is_active', sa.Boolean(), default=True),
        sa.Column('link_types', sa.Text()),
        sa.Column('keywords', sa.Text()),
        sa.Column('auto_save_to_115', sa.Boolean(), default=False),
        sa.Column('target_path', sa.String(length=500)),
        sa.Column('pan115_user_key', sa.String(length=100)),
        sa.Column('default_tags', sa.Text()),
        sa.Column('enable_deduplication', sa.Boolean(), default=True),
        sa.Column('dedup_time_window', sa.Integer(), default=3600),
        sa.Column('created_at', sa.DateTime()),
        sa.Column('updated_at', sa.DateTime()),
        sa.PrimaryKeyConstraint('id')
    )
    
    # åˆ›å»º resource_records è¡¨
    op.create_table(
        'resource_records',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('rule_id', sa.Integer(), nullable=False),
        sa.Column('rule_name', sa.String(length=100)),
        sa.Column('source_chat_id', sa.String(length=50)),
        sa.Column('source_chat_name', sa.String(length=200)),
        sa.Column('message_id', sa.Integer()),
        sa.Column('message_text', sa.Text()),
        sa.Column('message_date', sa.DateTime()),
        sa.Column('link_type', sa.String(length=20)),
        sa.Column('link_url', sa.Text(), nullable=False),
        sa.Column('link_hash', sa.String(length=64)),
        sa.Column('save_status', sa.String(length=20), default='pending'),
        sa.Column('save_path', sa.String(length=500)),
        sa.Column('save_error', sa.Text()),
        sa.Column('save_time', sa.DateTime()),
        sa.Column('retry_count', sa.Integer(), default=0),
        sa.Column('tags', sa.Text()),
        sa.Column('message_snapshot', sa.Text()),
        sa.Column('created_at', sa.DateTime()),
        sa.Column('updated_at', sa.DateTime()),
        sa.PrimaryKeyConstraint('id'),
        sa.ForeignKeyConstraint(['rule_id'], ['resource_monitor_rules.id'], ondelete='CASCADE')
    )
    
    # åˆ›å»ºç´¢å¼•
    op.create_index('idx_resource_records_link_hash', 'resource_records', ['link_hash'])
    op.create_index('idx_resource_records_save_status', 'resource_records', ['save_status'])
    op.create_index('idx_resource_records_created_at', 'resource_records', ['created_at'])

def downgrade():
    op.drop_index('idx_resource_records_created_at', table_name='resource_records')
    op.drop_index('idx_resource_records_save_status', table_name='resource_records')
    op.drop_index('idx_resource_records_link_hash', table_name='resource_records')
    op.drop_table('resource_records')
    op.drop_table('resource_monitor_rules')
```

**æ‰§è¡Œè¿ç§»ï¼š**
```bash
cd app/backend
alembic upgrade head
```

**æµ‹è¯•ï¼š**
```bash
# æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
sqlite3 data/bot.db "SELECT name FROM sqlite_master WHERE type='table' AND name LIKE 'resource%';"
```

#### Step 1.3-1.7: åˆ›å»ºæœåŠ¡å’ŒAPI

ç”±äºç¯‡å¹…é™åˆ¶ï¼Œå®Œæ•´ä»£ç å·²åœ¨å‰é¢çš„ç« èŠ‚ä¸­ç»™å‡ºã€‚

---

## 6. æµ‹è¯•æ–¹æ¡ˆ

### 6.1 å•å…ƒæµ‹è¯•

**æ–‡ä»¶ï¼š`tests/test_resource_monitor.py`**

```python
import pytest
from app.backend.services.resource_monitor_service import LinkExtractor, ResourceMonitorService
from app.backend.models import ResourceMonitorRule, ResourceRecord

class TestLinkExtractor:
    """é“¾æ¥æå–å™¨æµ‹è¯•"""
    
    def test_extract_pan115_link(self):
        """æµ‹è¯•æå–115é“¾æ¥"""
        text = "è¿™æ˜¯ä¸€ä¸ª115é“¾æ¥: https://115.com/s/abc123?password=xyz"
        links = LinkExtractor.extract_all(text)
        
        assert 'pan115' in links
        assert len(links['pan115']) == 1
        assert 'abc123' in links['pan115'][0]
    
    def test_extract_magnet_link(self):
        """æµ‹è¯•æå–ç£åŠ›é“¾æ¥"""
        text = "ç£åŠ›é“¾æ¥: magnet:?xt=urn:btih:abcd1234567890abcd1234567890abcd12345678"
        links = LinkExtractor.extract_all(text)
        
        assert 'magnet' in links
        assert len(links['magnet']) == 1
    
    def test_extract_multiple_links(self):
        """æµ‹è¯•æå–å¤šä¸ªé“¾æ¥"""
        text = """
        115é“¾æ¥: https://115.com/s/abc123
        ç£åŠ›é“¾æ¥: magnet:?xt=urn:btih:abcd1234567890abcd1234567890abcd12345678
        ed2ké“¾æ¥: ed2k://|file|test.mkv|1234567890|ABCD1234567890ABCD1234567890AB|/
        """
        links = LinkExtractor.extract_all(text)
        
        assert 'pan115' in links
        assert 'magnet' in links
        assert 'ed2k' in links

@pytest.mark.asyncio
class TestResourceMonitorService:
    """èµ„æºç›‘æ§æœåŠ¡æµ‹è¯•"""
    
    async def test_create_record(self, db_session):
        """æµ‹è¯•åˆ›å»ºèµ„æºè®°å½•"""
        # TODO: å®ç°æµ‹è¯•
        pass
    
    async def test_deduplication(self, db_session):
        """æµ‹è¯•å»é‡åŠŸèƒ½"""
        # TODO: å®ç°æµ‹è¯•
        pass
```

### 6.2 é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯ï¼š**

1. **æ¶ˆæ¯æ¥æ”¶æµ‹è¯•**
   - å‘é€åŒ…å«115é“¾æ¥çš„æ¶ˆæ¯
   - éªŒè¯æ˜¯å¦åˆ›å»ºäº†èµ„æºè®°å½•

2. **å…³é”®è¯è¿‡æ»¤æµ‹è¯•**
   - åˆ›å»ºå¸¦å…³é”®è¯çš„è§„åˆ™
   - å‘é€åŒ¹é…/ä¸åŒ¹é…çš„æ¶ˆæ¯
   - éªŒè¯è¿‡æ»¤ç»“æœ

3. **å»é‡æµ‹è¯•**
   - å‘é€ç›¸åŒé“¾æ¥çš„æ¶ˆæ¯
   - éªŒè¯åªåˆ›å»ºä¸€æ¡è®°å½•

4. **è‡ªåŠ¨è½¬å­˜æµ‹è¯•**
   - åˆ›å»ºå¯ç”¨è‡ªåŠ¨è½¬å­˜çš„è§„åˆ™
   - å‘é€115é“¾æ¥
   - éªŒè¯è½¬å­˜çŠ¶æ€

### 6.3 æ€§èƒ½æµ‹è¯•

**æµ‹è¯•æŒ‡æ ‡ï¼š**

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|------|--------|---------|
| æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ | < 100ms | å‘é€100æ¡æ¶ˆæ¯ï¼Œè®¡ç®—å¹³å‡å»¶è¿Ÿ |
| é“¾æ¥æå–é€Ÿåº¦ | < 10ms | æå–åŒ…å«10ä¸ªé“¾æ¥çš„æ¶ˆæ¯ |
| æ•°æ®åº“å†™å…¥é€Ÿåº¦ | < 50ms | æ‰¹é‡å†™å…¥100æ¡è®°å½• |
| ç¼“å­˜å‘½ä¸­ç‡ | > 80% | é‡å¤å‘é€ç›¸åŒæ¶ˆæ¯ |

---

## 7. éƒ¨ç½²æ–¹æ¡ˆ

### 7.1 éƒ¨ç½²å‰æ£€æŸ¥

```bash
# 1. æ£€æŸ¥ä»£ç 
git status
git diff

# 2. è¿è¡Œæµ‹è¯•
pytest tests/

# 3. æ£€æŸ¥æ•°æ®åº“è¿ç§»
cd app/backend
alembic current
alembic upgrade head

# 4. æ£€æŸ¥ä¾èµ–
pip list | grep -E "telethon|sqlalchemy|fastapi"
```

### 7.2 éƒ¨ç½²æ­¥éª¤

#### æœ¬åœ°å¼€å‘ç¯å¢ƒ

```bash
# 1. åœæ­¢æœåŠ¡
docker-compose down

# 2. æ¸…ç†æ•°æ®ï¼ˆå¯é€‰ï¼‰
# rm -rf data/ logs/ sessions/

# 3. é‡æ–°æ„å»º
docker-compose build --no-cache

# 4. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 5. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f backend
```

#### ç”Ÿäº§ç¯å¢ƒ

```bash
# 1. å¤‡ä»½æ•°æ®åº“
cp data/bot.db data/bot.db.backup.$(date +%Y%m%d_%H%M%S)

# 2. æ‹‰å–ä»£ç 
git pull origin main

# 3. æ‰§è¡Œè¿ç§»
docker-compose exec backend alembic upgrade head

# 4. é‡å¯æœåŠ¡
docker-compose restart backend

# 5. éªŒè¯æœåŠ¡
curl http://localhost:9393/api/health
```

### 7.3 å›æ»šæ–¹æ¡ˆ

```bash
# 1. åœæ­¢æœåŠ¡
docker-compose down

# 2. å›æ»šä»£ç 
git checkout <ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬>

# 3. å›æ»šæ•°æ®åº“
docker-compose exec backend alembic downgrade -1

# 4. æ¢å¤æ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
cp data/bot.db.backup.<timestamp> data/bot.db

# 5. é‡å¯æœåŠ¡
docker-compose up -d
```

---

## 8. 115Botå€Ÿé‰´ä¸ä¼˜åŒ–

> åŸºäº `115BOT_ANALYSIS.md` å’Œ `VIDEO_TRANSFER_COMPARISON.md` çš„æ·±åº¦åˆ†æ

### 8.1 æ ¸å¿ƒå€Ÿé‰´ç‚¹

#### 8.1.1 ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ â­â­â­â­â­

**115Botçš„å®ç°ï¼š**
- å®šæ—¶è½®è¯¢ç¦»çº¿ä»»åŠ¡çŠ¶æ€ï¼ˆæ¯5åˆ†é’Ÿï¼‰
- è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
- è®¢é˜…æ›´æ–°æ£€æŸ¥ï¼ˆæ¯å¤©æ—©ä¸Š8ç‚¹ï¼‰

**TMCå¯å€Ÿé‰´ï¼š**

```python
# æ–‡ä»¶ï¼šapp/backend/services/task_scheduler.py (æ–°å»º)
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from apscheduler.triggers.interval import IntervalTrigger

class TaskScheduler:
    """ä»»åŠ¡è°ƒåº¦å™¨ - å€Ÿé‰´115Bot"""
    
    def __init__(self):
        self.scheduler = AsyncIOScheduler()
    
    def start(self):
        """å¯åŠ¨è°ƒåº¦å™¨"""
        # 1. æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸‹è½½ä»»åŠ¡çŠ¶æ€
        self.scheduler.add_job(
            self.check_download_tasks,
            trigger=IntervalTrigger(minutes=5),
            id='check_download_tasks',
            name='æ£€æŸ¥ä¸‹è½½ä»»åŠ¡çŠ¶æ€'
        )
        
        # 2. æ¯å¤©å‡Œæ™¨2ç‚¹æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        self.scheduler.add_job(
            self.cleanup_temp_files,
            trigger=CronTrigger(hour=2, minute=0),
            id='cleanup_temp_files',
            name='æ¸…ç†ä¸´æ—¶æ–‡ä»¶'
        )
        
        # 3. æ¯å°æ—¶æ£€æŸ¥å­˜å‚¨ç©ºé—´
        self.scheduler.add_job(
            self.check_storage_space,
            trigger=IntervalTrigger(hours=1),
            id='check_storage_space',
            name='æ£€æŸ¥å­˜å‚¨ç©ºé—´'
        )
        
        # 4. æ¯å¤©æ—©ä¸Š8ç‚¹ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
        self.scheduler.add_job(
            self.generate_daily_report,
            trigger=CronTrigger(hour=8, minute=0),
            id='generate_daily_report',
            name='ç”Ÿæˆæ¯æ—¥æŠ¥å‘Š'
        )
        
        self.scheduler.start()
        logger.info("ä»»åŠ¡è°ƒåº¦å™¨å·²å¯åŠ¨")
    
    async def check_download_tasks(self):
        """æ£€æŸ¥ä¸‹è½½ä»»åŠ¡çŠ¶æ€ï¼ˆç±»ä¼¼115Botçš„ç¦»çº¿ä»»åŠ¡è½®è¯¢ï¼‰"""
        async for db in get_db():
            # æŸ¥æ‰¾é•¿æ—¶é—´æœªå®Œæˆçš„ä»»åŠ¡
            stale_tasks = await db.execute(
                select(DownloadTask).where(
                    DownloadTask.status == 'downloading',
                    DownloadTask.started_at < datetime.now() - timedelta(hours=2)
                )
            )
            
            for task in stale_tasks.scalars():
                logger.warning(f"å‘ç°å¡ä½çš„ä»»åŠ¡: {task.file_name}")
                # é‡ç½®çŠ¶æ€ï¼Œé‡æ–°ä¸‹è½½
                task.status = 'pending'
                task.retry_count += 1
            
            await db.commit()
            break
    
    async def cleanup_temp_files(self):
        """æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå€Ÿé‰´115Botï¼‰"""
        async for db in get_db():
            settings = await db.execute(select(MediaSettings))
            settings = settings.scalar_one_or_none()
            
            if not settings or not settings.auto_cleanup_enabled:
                return
            
            # æŸ¥æ‰¾è¿‡æœŸçš„ä¸´æ—¶æ–‡ä»¶
            cutoff_date = datetime.now() - timedelta(days=settings.auto_cleanup_days)
            
            old_files = await db.execute(
                select(MediaFile).where(
                    MediaFile.temp_path.isnot(None),
                    MediaFile.downloaded_at < cutoff_date
                )
            )
            
            for media_file in old_files.scalars():
                # åªæ¸…ç†å·²å½’æ¡£çš„æ–‡ä»¶
                if settings.cleanup_only_organized and not media_file.is_organized:
                    continue
                
                # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
                if os.path.exists(media_file.temp_path):
                    os.remove(media_file.temp_path)
                    logger.info(f"æ¸…ç†ä¸´æ—¶æ–‡ä»¶: {media_file.temp_path}")
                
                media_file.temp_path = None
            
            await db.commit()
            break
```

**ä¼˜åŠ¿ï¼š**
- âœ… è‡ªåŠ¨åŒ–è¿ç»´ï¼Œå‡å°‘äººå·¥å¹²é¢„
- âœ… åŠæ—¶å‘ç°å’Œå¤„ç†å¼‚å¸¸ä»»åŠ¡
- âœ… è‡ªåŠ¨æ¸…ç†ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
- âœ… å®šæœŸç»Ÿè®¡ï¼Œäº†è§£ç³»ç»ŸçŠ¶æ€

**å·¥ä½œé‡ï¼š** 2-3å¤©

---

#### 8.1.2 æ™ºèƒ½æ–‡ä»¶è¿‡æ»¤ â­â­â­â­

**115Botçš„å®ç°ï¼š**
- å¹¿å‘Šæ–‡ä»¶è¯†åˆ«ï¼ˆwww.ã€.urlã€å¹¿å‘Šã€sampleç­‰ï¼‰
- æ–‡ä»¶å¤§å°è¿‡æ»¤ï¼ˆè§†é¢‘è‡³å°‘1MBï¼‰
- æ‰©å±•åè¿‡æ»¤

**TMCå¯å€Ÿé‰´ï¼š**

```python
# æ–‡ä»¶ï¼šapp/backend/utils/media_filters.py (æ–°å»º)

class AdvancedMediaFilter:
    """é«˜çº§åª’ä½“è¿‡æ»¤å™¨ - å€Ÿé‰´115Bot"""
    
    # å¹¿å‘Šæ–‡ä»¶ç‰¹å¾åº“
    AD_PATTERNS = [
        r'www\.',
        r'\.url$',
        r'\.txt$',
        r'\.nfo$',
        r'å¹¿å‘Š',
        r'æ¨å¹¿',
        r'sample',
        r'é¢„è§ˆ',
        r'@',  # å¸¸è§äºå¹¿å‘Šæ–‡ä»¶å
        r'ç‚¹å‡»',
        r'è®¿é—®',
    ]
    
    # æœ€å°æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰
    MIN_VIDEO_SIZE = 1    # è§†é¢‘è‡³å°‘1MB
    MIN_AUDIO_SIZE = 0.1  # éŸ³é¢‘è‡³å°‘100KB
    MIN_IMAGE_SIZE = 0.01 # å›¾ç‰‡è‡³å°‘10KB
    
    @classmethod
    def is_ad_file(cls, filename: str) -> bool:
        """åˆ¤æ–­æ˜¯å¦ä¸ºå¹¿å‘Šæ–‡ä»¶"""
        filename_lower = filename.lower()
        for pattern in cls.AD_PATTERNS:
            if re.search(pattern, filename_lower):
                logger.info(f"æ£€æµ‹åˆ°å¹¿å‘Šæ–‡ä»¶: {filename}")
                return True
        return False
    
    @classmethod
    def is_valid_media(cls, file_type: str, file_size_mb: float) -> bool:
        """åˆ¤æ–­æ˜¯å¦ä¸ºæœ‰æ•ˆåª’ä½“æ–‡ä»¶"""
        if file_type == 'video' and file_size_mb < cls.MIN_VIDEO_SIZE:
            logger.info(f"è§†é¢‘æ–‡ä»¶è¿‡å°: {file_size_mb}MB")
            return False
        if file_type == 'audio' and file_size_mb < cls.MIN_AUDIO_SIZE:
            logger.info(f"éŸ³é¢‘æ–‡ä»¶è¿‡å°: {file_size_mb}MB")
            return False
        if file_type == 'image' and file_size_mb < cls.MIN_IMAGE_SIZE:
            logger.info(f"å›¾ç‰‡æ–‡ä»¶è¿‡å°: {file_size_mb}MB")
            return False
        return True
    
    @classmethod
    def extract_video_info(cls, filename: str) -> Dict[str, str]:
        """ä»æ–‡ä»¶åæå–è§†é¢‘ä¿¡æ¯ï¼ˆå€Ÿé‰´115Botï¼‰"""
        info = {}
        
        # æå–åˆ†è¾¨ç‡
        resolution_patterns = [
            r'(\d{3,4}[xXÃ—]\d{3,4})',  # 1920x1080
            r'(4K|2K|1080[pP]|720[pP]|480[pP])',
        ]
        for pattern in resolution_patterns:
            match = re.search(pattern, filename)
            if match:
                info['resolution'] = match.group(1)
                break
        
        # æå–ç”»è´¨
        quality_patterns = [
            r'(BluRay|Blu-ray|REMUX|WEB-DL|WEBRip|HDRip|BDRip)',
        ]
        for pattern in quality_patterns:
            match = re.search(pattern, filename, re.IGNORECASE)
            if match:
                info['quality'] = match.group(1)
                break
        
        # æå–ç¼–ç 
        codec_patterns = [
            r'(H\.?264|H\.?265|HEVC|x264|x265|AVC)',
        ]
        for pattern in codec_patterns:
            match = re.search(pattern, filename, re.IGNORECASE)
            if match:
                info['codec'] = match.group(1)
                break
        
        return info
```

**é›†æˆåˆ°åª’ä½“ç›‘æ§ï¼š**

```python
# ä¿®æ”¹ï¼šapp/backend/services/media_monitor_service.py

async def _execute_download(self, task_data: Dict[str, Any]):
    """æ‰§è¡Œä¸‹è½½ä»»åŠ¡ï¼ˆå¢å¼ºè¿‡æ»¤ï¼‰"""
    # ... ç°æœ‰ä¸‹è½½é€»è¾‘ ...
    
    # ä¸‹è½½å®Œæˆåï¼Œåº”ç”¨é«˜çº§è¿‡æ»¤
    from utils.media_filters import AdvancedMediaFilter
    
    # 1. æ£€æŸ¥æ˜¯å¦ä¸ºå¹¿å‘Šæ–‡ä»¶
    if AdvancedMediaFilter.is_ad_file(task_data['file_name']):
        logger.info(f"è¿‡æ»¤å¹¿å‘Šæ–‡ä»¶: {task_data['file_name']}")
        # åˆ é™¤å·²ä¸‹è½½çš„æ–‡ä»¶
        if file_path.exists():
            os.remove(file_path)
        # æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º"å·²å¿½ç•¥"
        task.status = 'ignored'
        task.error_message = 'å¹¿å‘Šæ–‡ä»¶å·²è¿‡æ»¤'
        await db.commit()
        return
    
    # 2. æ£€æŸ¥æ–‡ä»¶å¤§å°
    file_size_mb = file_path.stat().st_size / 1024 / 1024
    if not AdvancedMediaFilter.is_valid_media(task_data['file_type'], file_size_mb):
        logger.info(f"æ–‡ä»¶å¤§å°ä¸ç¬¦åˆè¦æ±‚: {file_size_mb}MB")
        os.remove(file_path)
        task.status = 'ignored'
        task.error_message = 'æ–‡ä»¶å¤§å°ä¸ç¬¦åˆè¦æ±‚'
        await db.commit()
        return
    
    # 3. æå–è§†é¢‘ä¿¡æ¯
    video_info = AdvancedMediaFilter.extract_video_info(task_data['file_name'])
    metadata_dict.update(video_info)
    
    # ... ç»§ç»­åç»­å¤„ç† ...
```

**ä¼˜åŠ¿ï¼š**
- âœ… è‡ªåŠ¨è¿‡æ»¤æ— ç”¨æ–‡ä»¶ï¼ŒèŠ‚çœå­˜å‚¨å’Œå¸¦å®½
- âœ… æå–æ–‡ä»¶åä¸­çš„å…ƒæ•°æ®ï¼Œä¸°å¯Œæ–‡ä»¶ä¿¡æ¯
- âœ… æå‡ç”¨æˆ·ä½“éªŒï¼Œé¿å…ä¸‹è½½åƒåœ¾æ–‡ä»¶

**å·¥ä½œé‡ï¼š** 1-2å¤©

---

#### 8.1.3 115ç§’ä¼ ä¼˜åŒ– â­â­â­â­â­

**é—®é¢˜ï¼š** TMCç›®å‰æ²¡æœ‰åœ¨ä¸Šä¼ å‰æ£€æŸ¥115ç½‘ç›˜æ˜¯å¦å·²æœ‰ç›¸åŒæ–‡ä»¶

**115Botçš„åšæ³•ï¼š**
```python
# ä¸Šä¼ å‰æ£€æŸ¥ç§’ä¼ 
file_hash = calculate_sha1(file_path)
quick_result = await pan115_client.check_quick_upload(file_hash)

if quick_result['exists']:
    logger.info("æ–‡ä»¶å·²å­˜åœ¨ï¼Œç§’ä¼ æˆåŠŸ")
    return quick_result['pickcode']
else:
    # æ­£å¸¸ä¸Šä¼ 
    await pan115_client.upload_file(file_path)
```

**TMCä¼˜åŒ–æ–¹æ¡ˆï¼š**

```python
# æ–‡ä»¶ï¼šapp/backend/services/p115_service.py (ä¿®æ”¹)

async def upload_file_with_quick_check(
    self, 
    cookies: str,
    file_path: str,
    target_dir: str = "/",
    file_name: Optional[str] = None
) -> Dict[str, Any]:
    """ä¸Šä¼ æ–‡ä»¶ï¼ˆæ”¯æŒç§’ä¼ æ£€æµ‹ï¼‰- å€Ÿé‰´115Bot"""
    
    # 1. è®¡ç®—æ–‡ä»¶SHA1
    file_sha1 = await self._calculate_sha1_async(file_path)
    logger.info(f"æ–‡ä»¶SHA1: {file_sha1}")
    
    # 2. æ£€æŸ¥ç§’ä¼ 
    loop = asyncio.get_event_loop()
    
    def _check_quick():
        client = P115Client(cookies)
        # ä½¿ç”¨115çš„ç§’ä¼ æ£€æŸ¥API
        # åªè¯»å–å‰128KBè¿›è¡Œæ£€æŸ¥ï¼ŒèŠ‚çœæ—¶é—´
        result = client.upload_file_sample(
            file_path,
            read_range=slice(0, 128 * 1024)
        )
        return result
    
    quick_result = await loop.run_in_executor(None, _check_quick)
    
    # 3. å¦‚æœå¯ä»¥ç§’ä¼ 
    if quick_result.get('status') == 2:
        logger.info(f"âš¡ ç§’ä¼ æˆåŠŸ: {file_name}")
        return {
            "success": True,
            "pickcode": quick_result.get('pickcode'),
            "file_name": file_name,
            "is_quick": True,
            "message": "ç§’ä¼ æˆåŠŸï¼ŒèŠ‚çœä¸Šä¼ æ—¶é—´"
        }
    
    # 4. æ­£å¸¸ä¸Šä¼ 
    logger.info(f"ç§’ä¼ ä¸å¯ç”¨ï¼Œå¼€å§‹æ­£å¸¸ä¸Šä¼ : {file_name}")
    return await self.upload_file(cookies, file_path, target_dir, file_name)

@staticmethod
async def _calculate_sha1_async(file_path: str) -> str:
    """å¼‚æ­¥è®¡ç®—æ–‡ä»¶SHA1"""
    import hashlib
    
    def _calc():
        sha1 = hashlib.sha1()
        with open(file_path, 'rb') as f:
            while chunk := f.read(8192):
                sha1.update(chunk)
        return sha1.hexdigest()
    
    loop = asyncio.get_event_loop()
    return await loop.run_in_executor(None, _calc)
```

**æ”¶ç›Šå¯¹æ¯”ï¼š**

| åœºæ™¯ | æ™®é€šä¸Šä¼  | ç§’ä¼  | èŠ‚çœæ—¶é—´ |
|------|---------|------|---------|
| 100MBæ–‡ä»¶ | 2-3åˆ†é’Ÿ | 3-5ç§’ | **95%** |
| 1GBæ–‡ä»¶ | 15-20åˆ†é’Ÿ | 3-5ç§’ | **98%** |
| 10GBæ–‡ä»¶ | 2-3å°æ—¶ | 3-5ç§’ | **99%** |

**å·¥ä½œé‡ï¼š** 1-2å¤©

---

#### 8.1.4 ä¼˜å…ˆçº§é˜Ÿåˆ— â­â­â­

**115Botçš„å®ç°ï¼š**
- æ”¯æŒä»»åŠ¡ä¼˜å…ˆçº§
- é«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¼˜å…ˆå¤„ç†
- ç”¨æˆ·å¯æ‰‹åŠ¨è°ƒæ•´ä¼˜å…ˆçº§

**TMCä¼˜åŒ–æ–¹æ¡ˆï¼š**

```python
# æ–‡ä»¶ï¼šapp/backend/services/media_monitor_service.py (ä¿®æ”¹)

import heapq
from dataclasses import dataclass, field
from typing import Any

@dataclass(order=True)
class PriorityTask:
    """ä¼˜å…ˆçº§ä»»åŠ¡"""
    priority: int  # æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
    task_data: Any = field(compare=False)

class EnhancedMediaMonitorService(MediaMonitorService):
    """å¢å¼ºçš„åª’ä½“ç›‘æ§æœåŠ¡ - æ”¯æŒä¼˜å…ˆçº§é˜Ÿåˆ—"""
    
    def __init__(self):
        super().__init__()
        self.priority_queue = []  # ä¼˜å…ˆçº§é˜Ÿåˆ—
        self.queue_lock = asyncio.Lock()
    
    async def add_download_task_with_priority(
        self, 
        task_data: Dict, 
        priority: int = 5  # é»˜è®¤ä¼˜å…ˆçº§5ï¼ˆ0æœ€é«˜ï¼Œ9æœ€ä½ï¼‰
    ):
        """æ·»åŠ å¸¦ä¼˜å…ˆçº§çš„ä¸‹è½½ä»»åŠ¡"""
        async with self.queue_lock:
            heapq.heappush(
                self.priority_queue,
                PriorityTask(priority=priority, task_data=task_data)
            )
            logger.info(f"æ·»åŠ ä¼˜å…ˆçº§ä»»åŠ¡: priority={priority}, file={task_data['file_name']}")
    
    async def _download_worker(self, worker_id: int):
        """ä¸‹è½½å·¥ä½œçº¿ç¨‹ï¼ˆæ”¯æŒä¼˜å…ˆçº§ï¼‰"""
        logger.info(f"ğŸ‘· ä¸‹è½½å·¥ä½œçº¿ç¨‹ #{worker_id+1} å·²å¯åŠ¨")
        
        while self.is_running:
            try:
                # ä¼˜å…ˆä»ä¼˜å…ˆçº§é˜Ÿåˆ—è·å–
                task = None
                async with self.queue_lock:
                    if self.priority_queue:
                        priority_task = heapq.heappop(self.priority_queue)
                        task = priority_task.task_data
                        logger.info(f"[Worker #{worker_id+1}] å¤„ç†ä¼˜å…ˆçº§ä»»åŠ¡: priority={priority_task.priority}")
                
                # å¦‚æœä¼˜å…ˆçº§é˜Ÿåˆ—ä¸ºç©ºï¼Œä»æ™®é€šé˜Ÿåˆ—è·å–
                if not task:
                    task = await asyncio.wait_for(
                        self.download_queue.get(),
                        timeout=1.0
                    )
                
                logger.info(f"[Worker #{worker_id+1}] å¼€å§‹ä¸‹è½½: {task['file_name']}")
                
                # æ‰§è¡Œä¸‹è½½
                await self._execute_download(task)
                
                # æ ‡è®°ä»»åŠ¡å®Œæˆ
                if not task.get('from_priority_queue'):
                    self.download_queue.task_done()
                
            except asyncio.TimeoutError:
                continue
            except Exception as e:
                logger.error(f"[Worker #{worker_id+1}] ä¸‹è½½ä»»åŠ¡å¤±è´¥: {e}")
```

**å‰ç«¯æ”¯æŒï¼š**

```typescript
// æ–‡ä»¶ï¼šapp/frontend/src/pages/MediaMonitor/RecordList.tsx (ä¿®æ”¹)

// æ·»åŠ ä¼˜å…ˆçº§è°ƒæ•´åŠŸèƒ½
const handleSetPriority = async (taskId: number, priority: number) => {
  try {
    await mediaMonitorApi.setTaskPriority(taskId, priority);
    message.success('ä¼˜å…ˆçº§å·²æ›´æ–°');
    fetchTasks();
  } catch (error) {
    message.error('ä¼˜å…ˆçº§æ›´æ–°å¤±è´¥');
  }
};

// åœ¨è¡¨æ ¼ä¸­æ·»åŠ ä¼˜å…ˆçº§åˆ—
{
  title: 'ä¼˜å…ˆçº§',
  dataIndex: 'priority',
  key: 'priority',
  render: (priority: number, record: DownloadTask) => (
    <Select
      value={priority}
      onChange={(value) => handleSetPriority(record.id, value)}
      style={{ width: 80 }}
    >
      <Option value={0}>ğŸ”´ ç´§æ€¥</Option>
      <Option value={3}>ğŸŸ¡ é«˜</Option>
      <Option value={5}>ğŸŸ¢ æ™®é€š</Option>
      <Option value={7}>ğŸ”µ ä½</Option>
    </Select>
  ),
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… é‡è¦ä»»åŠ¡ä¼˜å…ˆå¤„ç†
- âœ… ç”¨æˆ·å¯æ‰‹åŠ¨è°ƒæ•´
- âœ… æå‡ç”¨æˆ·ä½“éªŒ

**å·¥ä½œé‡ï¼š** 2-3å¤©

---

#### 8.1.5 æ‰¹é‡æ“ä½œ â­â­â­â­

**115Botçš„å®ç°ï¼š**
- æ‰¹é‡æ·»åŠ ç¦»çº¿ä»»åŠ¡
- æ‰¹é‡è§£å‹æ–‡ä»¶
- æ‰¹é‡ç”ŸæˆSTRM

**TMCä¼˜åŒ–æ–¹æ¡ˆï¼š**

```python
# æ–‡ä»¶ï¼šapp/backend/api/routes/media_monitor.py (æ–°å¢)

@router.post("/batch-operations")
async def batch_operations(
    operation: str,  # download/organize/upload/retry
    task_ids: List[int],
    db: AsyncSession = Depends(get_db)
):
    """æ‰¹é‡æ“ä½œï¼ˆå€Ÿé‰´115Botï¼‰"""
    
    if operation == 'download':
        # æ‰¹é‡é‡æ–°ä¸‹è½½
        for task_id in task_ids:
            task = await db.get(DownloadTask, task_id)
            if task:
                task.status = 'pending'
                task.retry_count = 0
                task.error_message = None
        await db.commit()
        return {"success": True, "message": f"å·²é‡æ–°å¯åŠ¨{len(task_ids)}ä¸ªä¸‹è½½ä»»åŠ¡"}
    
    elif operation == 'organize':
        # æ‰¹é‡é‡æ–°å½’æ¡£
        for task_id in task_ids:
            media_file = await db.execute(
                select(MediaFile).where(MediaFile.download_task_id == task_id)
            )
            media_file = media_file.scalar_one_or_none()
            if media_file and media_file.temp_path:
                # é‡æ–°å½’æ¡£
                from services.media_monitor_service import FileOrganizer
                await FileOrganizer.organize_file(
                    rule, 
                    media_file.temp_path, 
                    metadata
                )
        await db.commit()
        return {"success": True, "message": f"å·²é‡æ–°å½’æ¡£{len(task_ids)}ä¸ªæ–‡ä»¶"}
    
    elif operation == 'upload':
        # æ‰¹é‡ä¸Šä¼ åˆ°115
        from services.p115_service import Pan115Service
        p115_service = Pan115Service(db)
        
        success_count = 0
        for task_id in task_ids:
            media_file = await db.execute(
                select(MediaFile).where(MediaFile.download_task_id == task_id)
            )
            media_file = media_file.scalar_one_or_none()
            if media_file and (media_file.temp_path or media_file.final_path):
                try:
                    source_file = media_file.final_path or media_file.temp_path
                    await p115_service.upload_file_with_quick_check(
                        cookies, 
                        source_file, 
                        target_dir
                    )
                    success_count += 1
                except Exception as e:
                    logger.error(f"ä¸Šä¼ å¤±è´¥: {e}")
        
        await db.commit()
        return {
            "success": True, 
            "message": f"æˆåŠŸä¸Šä¼ {success_count}/{len(task_ids)}ä¸ªæ–‡ä»¶åˆ°115ç½‘ç›˜"
        }
    
    elif operation == 'retry':
        # æ‰¹é‡é‡è¯•å¤±è´¥ä»»åŠ¡
        for task_id in task_ids:
            task = await db.get(DownloadTask, task_id)
            if task and task.status == 'failed':
                task.status = 'pending'
                task.retry_count = 0
        await db.commit()
        return {"success": True, "message": f"å·²é‡è¯•{len(task_ids)}ä¸ªå¤±è´¥ä»»åŠ¡"}
```

**å·¥ä½œé‡ï¼š** 1-2å¤©

---

### 8.2 TMCç‹¬ç‰¹ä¼˜åŠ¿ä¿æŒ

| åŠŸèƒ½ | TMCç‹¬æœ‰ | è¯´æ˜ |
|------|---------|------|
| Webç®¡ç†ç•Œé¢ | âœ… | 115Botåªæœ‰Telegramäº¤äº’ |
| å¤šå®¢æˆ·ç«¯ç®¡ç† | âœ… | æ”¯æŒå¤šä¸ªTelegramè´¦å· |
| æ¶ˆæ¯è½¬å‘ | âœ… | 115Botä¸æ”¯æŒ |
| ç”¨æˆ·æƒé™ç³»ç»Ÿ | âœ… | æ›´å®Œå–„çš„æƒé™ç®¡ç† |
| å…ƒæ•°æ®æå– | âœ… | æ›´è¯¦ç»†çš„è§†é¢‘å…ƒæ•°æ® |
| æ•°æ®åº“ç®¡ç† | âœ… | å®Œæ•´çš„å…³ç³»å‹æ•°æ®åº“ |
| APIæ¥å£ | âœ… | RESTful API |
| å®æ—¶è¿›åº¦è·Ÿè¸ª | âœ… | 115Botæ— å®æ—¶è¿›åº¦ |
| å®Œæ•´çš„ä»»åŠ¡ç®¡ç† | âœ… | æ•°æ®åº“è®°å½•æ‰€æœ‰ä»»åŠ¡ |

---

### 8.3 ä¼˜åŒ–å®æ–½è·¯çº¿å›¾

```
é˜¶æ®µ5ï¼ˆç¬¬3å‘¨ï¼‰ï¼š115Botå€Ÿé‰´åŠŸèƒ½
â”œâ”€ Day 1-2: 115ç§’ä¼ ä¼˜åŒ–ï¼ˆæœ€é«˜ROIï¼‰
â”œâ”€ Day 3: æ™ºèƒ½æ–‡ä»¶è¿‡æ»¤
â”œâ”€ Day 4: ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ
â””â”€ Day 5: ä¼˜å…ˆçº§é˜Ÿåˆ— + æ‰¹é‡æ“ä½œ

é˜¶æ®µ6ï¼ˆç¬¬4å‘¨ï¼‰ï¼šé«˜çº§åŠŸèƒ½
â”œâ”€ Day 1-2: è¿›åº¦é€šçŸ¥ä¼˜åŒ–
â”œâ”€ Day 3: æ‰¹é‡ä¸Šä¼ ä¼˜åŒ–
â””â”€ Day 4-5: å®Œæ•´æµ‹è¯•å’Œæ–‡æ¡£

é¢„æœŸæ”¶ç›Šï¼š
â”œâ”€ ä¸Šä¼ é€Ÿåº¦æå‡: 50-70%ï¼ˆç§’ä¼ ï¼‰
â”œâ”€ å­˜å‚¨èŠ‚çœ: 30-50%ï¼ˆè¿‡æ»¤ï¼‰
â”œâ”€ è‡ªåŠ¨åŒ–ç¨‹åº¦: +70%ï¼ˆè°ƒåº¦ï¼‰
â””â”€ ç”¨æˆ·ä½“éªŒ: +40%ï¼ˆä¼˜å…ˆçº§+æ‰¹é‡ï¼‰
```

---

### 8.4 å…³é”®ä¼˜åŒ–å¯¹æ¯”

| ä¼˜åŒ–é¡¹ | ä¼˜å…ˆçº§ | å·¥ä½œé‡ | é¢„æœŸæ”¶ç›Š | å®æ–½å»ºè®® |
|--------|--------|--------|---------|---------|
| **115ç§’ä¼ æ£€æµ‹** | â­â­â­â­â­ | 1-2å¤© | èŠ‚çœ90%ä¸Šä¼ æ—¶é—´ | ç«‹å³å®æ–½ |
| **ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ** | â­â­â­â­ | 2-3å¤© | è‡ªåŠ¨åŒ–+70% | ç¬¬äºŒæ‰¹ |
| **æ™ºèƒ½æ–‡ä»¶è¿‡æ»¤** | â­â­â­â­ | 1-2å¤© | èŠ‚çœ30%å­˜å‚¨ | ç¬¬äºŒæ‰¹ |
| **æ‰¹é‡ä¸Šä¼ ** | â­â­â­â­ | 2-3å¤© | æå‡60%æ•ˆç‡ | ç¬¬äºŒæ‰¹ |
| **ä¼˜å…ˆçº§é˜Ÿåˆ—** | â­â­â­ | 2-3å¤© | ç”¨æˆ·ä½“éªŒ+40% | ç¬¬ä¸‰æ‰¹ |
| **æ‰¹é‡æ“ä½œ** | â­â­â­ | 1-2å¤© | æ“ä½œæ•ˆç‡+50% | ç¬¬ä¸‰æ‰¹ |

---

## 9. é™„å½•

### 9.1 æ–‡ä»¶æ¸…å•

#### æ–°å»ºæ–‡ä»¶ï¼ˆæ··åˆæ¶æ„æ ¸å¿ƒï¼‰

```
app/backend/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ message_context.py              (æ–°å»ºï¼Œ200è¡Œ) - æ¶ˆæ¯ä¸Šä¸‹æ–‡
â”‚   â”œâ”€â”€ message_dispatcher.py           (æ–°å»ºï¼Œ300è¡Œ) - æ¶ˆæ¯åˆ†å‘å™¨
â”‚   â”œâ”€â”€ resource_monitor_service.py     (æ–°å»ºï¼Œ800è¡Œ) - èµ„æºç›‘æ§æœåŠ¡
â”‚   â”œâ”€â”€ task_scheduler.py               (æ–°å»ºï¼Œ400è¡Œ) - ä»»åŠ¡è°ƒåº¦å™¨ [115Botå€Ÿé‰´]
â”‚   â”œâ”€â”€ notification_service.py         (æ–°å»ºï¼Œ400è¡Œ) - æ¨é€é€šçŸ¥æœåŠ¡ â­ æ–°å¢
â”‚   â”œâ”€â”€ notification_templates.py       (æ–°å»ºï¼Œ200è¡Œ) - é€šçŸ¥æ¨¡æ¿å¼•æ“ â­ æ–°å¢
â”‚   â””â”€â”€ common/
â”‚       â”œâ”€â”€ __init__.py                 (æ–°å»º)
â”‚       â”œâ”€â”€ message_cache.py            (æ–°å»ºï¼Œ300è¡Œ) - æ¶ˆæ¯ç¼“å­˜
â”‚       â”œâ”€â”€ filter_engine.py            (æ–°å»ºï¼Œ200è¡Œ) - å…±äº«è¿‡æ»¤å¼•æ“
â”‚       â”œâ”€â”€ retry_queue.py              (æ–°å»ºï¼Œ400è¡Œ) - æ™ºèƒ½é‡è¯•é˜Ÿåˆ—
â”‚       â””â”€â”€ batch_writer.py             (æ–°å»ºï¼Œ300è¡Œ) - æ‰¹é‡æ•°æ®åº“å†™å…¥
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ media_filters.py                (æ–°å»ºï¼Œ300è¡Œ) - é«˜çº§åª’ä½“è¿‡æ»¤å™¨ [115Botå€Ÿé‰´]
â”œâ”€â”€ api/routes/
â”‚   â”œâ”€â”€ resource_monitor.py             (æ–°å»ºï¼Œ400è¡Œ) - èµ„æºç›‘æ§API
â”‚   â””â”€â”€ notifications.py                (æ–°å»ºï¼Œ300è¡Œ) - é€šçŸ¥ç®¡ç†API â­ æ–°å¢
â””â”€â”€ alembic/versions/
    â”œâ”€â”€ 20250112_add_resource_monitor.py (æ–°å»ºï¼Œ100è¡Œ) - æ•°æ®åº“è¿ç§»
    â””â”€â”€ 20250112_add_notifications.py    (æ–°å»ºï¼Œ80è¡Œ) - é€šçŸ¥è¡¨è¿ç§» â­ æ–°å¢

app/frontend/src/
â”œâ”€â”€ pages/ResourceMonitor/
â”‚   â”œâ”€â”€ index.tsx                       (æ–°å»ºï¼Œ100è¡Œ) - ä¸»é¡µé¢
â”‚   â”œâ”€â”€ RuleList.tsx                    (æ–°å»ºï¼Œ400è¡Œ) - è§„åˆ™åˆ—è¡¨
â”‚   â”œâ”€â”€ RuleForm.tsx                    (æ–°å»ºï¼Œ600è¡Œ) - è§„åˆ™è¡¨å•
â”‚   â”œâ”€â”€ RecordList.tsx                  (æ–°å»ºï¼Œ800è¡Œ) - è®°å½•åˆ—è¡¨
â”‚   â””â”€â”€ QuickWizard.tsx                 (æ–°å»ºï¼Œ300è¡Œ) - å¿«æ·å‘å¯¼
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ NotificationCenter.tsx          (æ–°å»ºï¼Œ500è¡Œ) - é€šçŸ¥ä¸­å¿ƒ â­ æ–°å¢
â”‚   â””â”€â”€ NotificationSettings.tsx        (æ–°å»ºï¼Œ400è¡Œ) - é€šçŸ¥è®¾ç½® â­ æ–°å¢
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ resourceMonitor.ts              (æ–°å»ºï¼Œ200è¡Œ) - APIæœåŠ¡
â”‚   â””â”€â”€ notifications.ts                (æ–°å»ºï¼Œ150è¡Œ) - é€šçŸ¥APIæœåŠ¡ â­ æ–°å¢
â””â”€â”€ types/
    â”œâ”€â”€ resourceMonitor.ts              (æ–°å»ºï¼Œ100è¡Œ) - ç±»å‹å®šä¹‰
    â””â”€â”€ notifications.ts                (æ–°å»ºï¼Œ80è¡Œ) - é€šçŸ¥ç±»å‹å®šä¹‰ â­ æ–°å¢

docs/
â”œâ”€â”€ HYBRID_ARCHITECTURE_DEVELOPMENT.md  (æœ¬æ–‡æ¡£)
â”œâ”€â”€ 115BOT_ANALYSIS.md                  (å‚è€ƒæ–‡æ¡£)
â””â”€â”€ VIDEO_TRANSFER_COMPARISON.md        (å‚è€ƒæ–‡æ¡£)

æ€»è®¡ï¼šçº¦ 8,010 è¡Œæ–°ä»£ç ï¼ˆå«115Botå€Ÿé‰´ + æ¨é€é€šçŸ¥ï¼‰
```

#### ä¿®æ”¹æ–‡ä»¶

```
app/backend/
â”œâ”€â”€ models.py                           (æ–°å¢ 2ä¸ªæ¨¡å‹ï¼Œçº¦100è¡Œ)
â”œâ”€â”€ telegram_client_manager.py          (ä¿®æ”¹ _process_messageï¼Œçº¦50è¡Œ)
â”œâ”€â”€ services/media_monitor_service.py   (æ–°å¢è¿‡æ»¤å’Œä¼˜å…ˆçº§ï¼Œçº¦150è¡Œ) [115Botå€Ÿé‰´]
â”œâ”€â”€ services/p115_service.py            (æ–°å¢ç§’ä¼ æ£€æµ‹ï¼Œçº¦100è¡Œ) [115Botå€Ÿé‰´]
â”œâ”€â”€ api/routes/media_monitor.py         (æ–°å¢æ‰¹é‡æ“ä½œï¼Œçº¦80è¡Œ) [115Botå€Ÿé‰´]
â””â”€â”€ api/routes/__init__.py              (æ–°å¢ 1ä¸ªè·¯ç”±å¯¼å…¥ï¼Œ1è¡Œ)

app/frontend/src/
â”œâ”€â”€ routes.tsx                          (æ–°å¢è·¯ç”±é…ç½®ï¼Œçº¦10è¡Œ)
â””â”€â”€ pages/MediaMonitor/RecordList.tsx   (æ–°å¢ä¼˜å…ˆçº§åˆ—ï¼Œçº¦30è¡Œ) [115Botå€Ÿé‰´]

æ€»è®¡ï¼šçº¦ 520 è¡Œä¿®æ”¹ï¼ˆå«115Botå€Ÿé‰´ä¼˜åŒ–ï¼‰
```

### 9.2 ä¾èµ–æ¸…å•

**Pythonä¾èµ–ï¼ˆå·²æœ‰ï¼‰ï¼š**
- telethon >= 1.24.0
- sqlalchemy >= 2.0.0
- fastapi >= 0.100.0
- alembic >= 1.11.0

**Pythonä¾èµ–ï¼ˆæ–°å¢ï¼‰ï¼š**
- apscheduler >= 3.10.0  # ä»»åŠ¡è°ƒåº¦å™¨ [115Botå€Ÿé‰´]

**å‰ç«¯ä¾èµ–ï¼ˆå·²æœ‰ï¼‰ï¼š**
- react >= 18.0.0
- antd >= 5.0.0
- axios >= 1.0.0

**æ— éœ€å…¶ä»–æ–°å¢ä¾èµ–**

### 9.3 é…ç½®æ¸…å•

**ç¯å¢ƒå˜é‡ï¼ˆæ— éœ€æ–°å¢ï¼‰ï¼š**
- ä½¿ç”¨ç°æœ‰çš„æ•°æ®åº“é…ç½®
- ä½¿ç”¨ç°æœ‰çš„115é…ç½®

**æ•°æ®åº“è¿ç§»ï¼š**
- 1ä¸ªæ–°è¿ç§»æ–‡ä»¶
- 2ä¸ªæ–°è¡¨ï¼ˆresource_monitor_rules, resource_recordsï¼‰
- 3ä¸ªæ–°ç´¢å¼•

**ä»»åŠ¡è°ƒåº¦é…ç½®ï¼ˆæ–°å¢ï¼‰ï¼š** [115Botå€Ÿé‰´]
```python
# config/scheduler.py
SCHEDULER_CONFIG = {
    'check_download_tasks': {
        'interval': 5,  # åˆ†é’Ÿ
        'enabled': True
    },
    'cleanup_temp_files': {
        'cron': '0 2 * * *',  # æ¯å¤©å‡Œæ™¨2ç‚¹
        'enabled': True
    },
    'check_storage_space': {
        'interval': 60,  # åˆ†é’Ÿ
        'enabled': True
    },
    'generate_daily_report': {
        'cron': '0 8 * * *',  # æ¯å¤©æ—©ä¸Š8ç‚¹
        'enabled': False  # é»˜è®¤å…³é—­
    }
}
```

### 9.4 æ€§èƒ½æŒ‡æ ‡

**é¢„æœŸæ€§èƒ½æå‡ï¼ˆæ··åˆæ¶æ„ï¼‰ï¼š**

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ | 200ms | 70ms | 2.9x |
| æ•°æ®åº“å†™å…¥ | 100æ¬¡/ç§’ | 20æ¬¡/ç§’ | 5x |
| ç¼“å­˜å‘½ä¸­ç‡ | 0% | 85% | âˆ |
| é‡è¯•æˆåŠŸç‡ | 40% | 90% | 2.25x |

**é¢„æœŸæ€§èƒ½æå‡ï¼ˆ115Botå€Ÿé‰´ï¼‰ï¼š**

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| 115ä¸Šä¼ é€Ÿåº¦ï¼ˆç§’ä¼ ï¼‰ | 100% | 5% | **95%èŠ‚çœ** |
| å­˜å‚¨ç©ºé—´å ç”¨ï¼ˆè¿‡æ»¤ï¼‰ | 100% | 70% | **30%èŠ‚çœ** |
| ä»»åŠ¡å¤„ç†æ•ˆç‡ï¼ˆä¼˜å…ˆçº§ï¼‰ | 100% | 160% | **60%æå‡** |
| æ“ä½œæ•ˆç‡ï¼ˆæ‰¹é‡ï¼‰ | 100% | 200% | **100%æå‡** |
| è‡ªåŠ¨åŒ–ç¨‹åº¦ï¼ˆè°ƒåº¦ï¼‰ | 30% | 100% | **70%æå‡** |

**èµ„æºå ç”¨ï¼š**

| èµ„æº | å¢åŠ é‡ | è¯´æ˜ |
|------|--------|------|
| å†…å­˜ | +70MB | æ¶ˆæ¯ç¼“å­˜ + ä»»åŠ¡è°ƒåº¦å™¨ |
| ç£ç›˜ | +100MB/ä¸‡æ¡è®°å½• | èµ„æºè®°å½• |
| CPU | +8% | é“¾æ¥æå–ã€è¿‡æ»¤ã€SHA1è®¡ç®— |

---

## 10. æ€»ç»“

### 10.1 æ ¸å¿ƒä¼˜åŠ¿

#### æ··åˆæ¶æ„ä¼˜åŠ¿
1. **æœ€å°åŒ–æ”¹åŠ¨**ï¼šä¿ç•™ç°æœ‰ä»£ç ï¼Œåªæ–°å¢åŠŸèƒ½
2. **æ€§èƒ½æå‡**ï¼šé€šè¿‡ç¼“å­˜å’Œæ‰¹é‡å¤„ç†æå‡3-5å€æ€§èƒ½
3. **æ˜“äºæ‰©å±•**ï¼šç»Ÿä¸€çš„å¤„ç†å™¨æ¥å£ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
4. **å‘åå…¼å®¹**ï¼šä¸ç ´åç°æœ‰åŠŸèƒ½
5. **å¯è§‚æµ‹æ€§**ï¼šå®Œå–„çš„ç›‘æ§å’Œæ—¥å¿—

#### 115Botå€Ÿé‰´ä¼˜åŠ¿
1. **ç§’ä¼ ä¼˜åŒ–**ï¼šèŠ‚çœ90%ä»¥ä¸Šä¸Šä¼ æ—¶é—´
2. **æ™ºèƒ½è¿‡æ»¤**ï¼šèŠ‚çœ30%å­˜å‚¨ç©ºé—´ï¼Œé¿å…åƒåœ¾æ–‡ä»¶
3. **ä»»åŠ¡è°ƒåº¦**ï¼šè‡ªåŠ¨åŒ–ç¨‹åº¦æå‡70%
4. **ä¼˜å…ˆçº§é˜Ÿåˆ—**ï¼šé‡è¦ä»»åŠ¡ä¼˜å…ˆå¤„ç†
5. **æ‰¹é‡æ“ä½œ**ï¼šæ“ä½œæ•ˆç‡æå‡100%

### 10.2 é£é™©å’Œç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| äº‹ä»¶å¾ªç¯é—®é¢˜ | é«˜ | MessageContextå°è£…ï¼Œè‡ªåŠ¨å¤„ç† |
| æ•°æ®åº“è¿ç§»å¤±è´¥ | ä¸­ | å®Œæ•´çš„å›æ»šæ–¹æ¡ˆ |
| æ€§èƒ½ä¸‹é™ | ä¸­ | ç¼“å­˜å’Œæ‰¹é‡å¤„ç† |
| 115é™æµ | ä¸­ | æ™ºèƒ½é‡è¯•é˜Ÿåˆ— + ç§’ä¼ ä¼˜åŒ– |
| SHA1è®¡ç®—è€—æ—¶ | ä½ | å¼‚æ­¥è®¡ç®—ï¼Œä¸é˜»å¡ä¸»æµç¨‹ |

### 10.3 å®Œæ•´å¼€å‘è·¯çº¿å›¾

```
ç¬¬1-2å‘¨ï¼šæ··åˆæ¶æ„æ ¸å¿ƒï¼ˆé˜¶æ®µ1-4ï¼‰
â”œâ”€ æ•°æ®æ¨¡å‹å’Œæ¶ˆæ¯åˆ†å‘å™¨
â”œâ”€ èµ„æºç›‘æ§æœåŠ¡
â”œâ”€ æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜ã€æ‰¹é‡ã€é‡è¯•ï¼‰
â””â”€ å‰ç«¯ç•Œé¢å’Œç›‘æ§é¢æ¿

ç¬¬3å‘¨ï¼šæ¨é€é€šçŸ¥ + æµ‹è¯•ï¼ˆé˜¶æ®µ5ï¼‰â­ æ–°å¢
â”œâ”€ æ¨é€é€šçŸ¥æœåŠ¡æ ¸å¿ƒ
â”œâ”€ é€šçŸ¥æ¨¡æ¿å¼•æ“
â”œâ”€ å¤šæ¸ é“æ”¯æŒï¼ˆTelegram/Web/Email/Webhookï¼‰
â”œâ”€ å‰ç«¯é€šçŸ¥ä¸­å¿ƒ
â””â”€ å®Œæ•´æµ‹è¯•å’Œä¼˜åŒ–

ç¬¬4å‘¨ï¼š115Botå€Ÿé‰´åŠŸèƒ½ï¼ˆé˜¶æ®µ6ï¼‰
â”œâ”€ 115ç§’ä¼ ä¼˜åŒ–ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
â”œâ”€ æ™ºèƒ½æ–‡ä»¶è¿‡æ»¤
â”œâ”€ ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ
â””â”€ ä¼˜å…ˆçº§é˜Ÿåˆ— + æ‰¹é‡æ“ä½œ

ç¬¬5å‘¨ï¼šé«˜çº§åŠŸèƒ½å’Œéƒ¨ç½²ï¼ˆé˜¶æ®µ7ï¼‰
â”œâ”€ è¿›åº¦é€šçŸ¥ä¼˜åŒ–
â”œâ”€ æ‰¹é‡ä¸Šä¼ ä¼˜åŒ–
â”œâ”€ å®Œæ•´æµ‹è¯•
â””â”€ æ–‡æ¡£å®Œå–„å’Œéƒ¨ç½²

é¢„æœŸæ€»æ”¶ç›Šï¼š
â”œâ”€ å¼€å‘æ—¶é—´ï¼š4-5å‘¨
â”œâ”€ æ–°å¢ä»£ç ï¼šçº¦8,010è¡Œï¼ˆå«æ¨é€é€šçŸ¥ï¼‰
â”œâ”€ ä¿®æ”¹ä»£ç ï¼šçº¦520è¡Œ
â”œâ”€ æ€§èƒ½æå‡ï¼š3-5å€ï¼ˆæ··åˆæ¶æ„ï¼‰+ 50-95%ï¼ˆ115Botä¼˜åŒ–ï¼‰
â”œâ”€ è‡ªåŠ¨åŒ–ç¨‹åº¦ï¼š+70%
â”œâ”€ ç”¨æˆ·ä½“éªŒï¼š+50%ï¼ˆå«æ¨é€é€šçŸ¥ï¼‰
â””â”€ é€šçŸ¥åŠæ—¶æ€§ï¼šå®æ—¶æ¨é€
```

### 10.4 å…³é”®é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | æ—¶é—´ | äº¤ä»˜å†…å®¹ | éªŒæ”¶æ ‡å‡† |
|--------|------|---------|---------|
| **M1ï¼šæ ¸å¿ƒæ¶æ„** | Week 1 | æ¶ˆæ¯åˆ†å‘å™¨ + èµ„æºç›‘æ§MVP | èƒ½åˆ›å»ºè§„åˆ™å¹¶æ•è·é“¾æ¥ |
| **M2ï¼šæ€§èƒ½ä¼˜åŒ–** | Week 2 | ç¼“å­˜ + æ‰¹é‡ + é‡è¯• + å‰ç«¯ | æ€§èƒ½æå‡3å€ä»¥ä¸Š |
| **M3ï¼šæ¨é€é€šçŸ¥** â­ | Week 3 | é€šçŸ¥æœåŠ¡ + å¤šæ¸ é“ + å‰ç«¯ | å®æ—¶æ¨é€æ­£å¸¸å·¥ä½œ |
| **M4ï¼š115ä¼˜åŒ–** | Week 4 | ç§’ä¼  + è¿‡æ»¤ + è°ƒåº¦ + æ‰¹é‡ | ä¸Šä¼ é€Ÿåº¦æå‡50%ä»¥ä¸Š |
| **M5ï¼šå®Œæ•´äº¤ä»˜** | Week 5 | æµ‹è¯• + æ–‡æ¡£ + éƒ¨ç½² | æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡ |

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v2.1 â­ æ–°å¢æ¨é€é€šçŸ¥ç³»ç»Ÿ  
**åˆ›å»ºæ—¥æœŸï¼š** 2025-01-12  
**æœ€åæ›´æ–°ï¼š** 2025-01-14  
**ä½œè€…ï¼š** AI Assistant  
**å®¡æ ¸çŠ¶æ€ï¼š** å¾…å®¡æ ¸  
**å‚è€ƒæ–‡æ¡£ï¼š** 115BOT_ANALYSIS.md, VIDEO_TRANSFER_COMPARISON.md

**v2.1 æ›´æ–°å†…å®¹ï¼š**
- âœ… æ–°å¢é˜¶æ®µ5ï¼šæ¨é€é€šçŸ¥ç³»ç»Ÿï¼ˆP1ï¼Œ2-3å¤©ï¼‰
- âœ… æ–°å¢ NotificationService å’Œ NotificationTemplateEngine è®¾è®¡
- âœ… æ–°å¢ notification_rules å’Œ notification_logs æ•°æ®è¡¨
- âœ… æ–°å¢é€šçŸ¥ä¸­å¿ƒå’Œé€šçŸ¥è®¾ç½®å‰ç«¯ç»„ä»¶
- âœ… æ”¯æŒå¤šæ¸ é“æ¨é€ï¼ˆTelegram/Web/Email/Webhookï¼‰
- âœ… æ”¯æŒ8ç§é€šçŸ¥ç±»å‹ï¼ˆä¸‹è½½å®Œæˆã€èµ„æºæ•è·ã€115è½¬å­˜ç­‰ï¼‰
- âœ… æ›´æ–°å¼€å‘è·¯çº¿å›¾ï¼š4-5å‘¨å®Œæˆ
- âœ… æ›´æ–°ä»£ç é‡ï¼šçº¦8,010è¡Œï¼ˆå«æ¨é€é€šçŸ¥ï¼‰

---

## 11. å¿«é€Ÿå¼€å§‹

### 11.1 é˜¶æ®µ1ï¼šæ ¸å¿ƒæ¶æ„ï¼ˆç¬¬1å‘¨ï¼‰

```bash
# 1. åˆ›å»ºåˆ†æ”¯
git checkout -b feature/hybrid-architecture

# 2. åˆ›å»ºæ•°æ®æ¨¡å‹
# ç¼–è¾‘ app/backend/models.py
# æ·»åŠ  ResourceMonitorRule å’Œ ResourceRecord æ¨¡å‹

# 3. åˆ›å»ºæ•°æ®åº“è¿ç§»
cd app/backend
alembic revision --autogenerate -m "add resource monitor tables"
alembic upgrade head

# 4. åˆ›å»ºæ ¸å¿ƒæœåŠ¡
mkdir -p services/common
touch services/message_context.py
touch services/message_dispatcher.py
touch services/resource_monitor_service.py

# 5. åˆ›å»ºAPIè·¯ç”±
touch api/routes/resource_monitor.py

# 6. æµ‹è¯•
pytest tests/test_resource_monitor.py

# 7. æäº¤
git add .
git commit -m "feat: å®ç°æ··åˆæ¶æ„æ ¸å¿ƒ - æ¶ˆæ¯åˆ†å‘å™¨å’Œèµ„æºç›‘æ§"
git push origin feature/hybrid-architecture
```

### 11.2 é˜¶æ®µ5ï¼š115Botå€Ÿé‰´ï¼ˆç¬¬3å‘¨ï¼‰

```bash
# 1. åˆ›å»º115ä¼˜åŒ–åˆ†æ”¯
git checkout -b feature/115bot-optimizations

# 2. å®‰è£…æ–°ä¾èµ–
pip install apscheduler>=3.10.0

# 3. åˆ›å»º115ä¼˜åŒ–æ–‡ä»¶
touch services/task_scheduler.py
touch utils/media_filters.py

# 4. ä¿®æ”¹ç°æœ‰æœåŠ¡
# ä¿®æ”¹ services/p115_service.py - æ·»åŠ ç§’ä¼ æ£€æµ‹
# ä¿®æ”¹ services/media_monitor_service.py - æ·»åŠ è¿‡æ»¤å’Œä¼˜å…ˆçº§

# 5. æµ‹è¯•115ä¼˜åŒ–
pytest tests/test_115_optimizations.py

# 6. æäº¤
git add .
git commit -m "feat: é›†æˆ115Botä¼˜åŒ– - ç§’ä¼ /è¿‡æ»¤/è°ƒåº¦/æ‰¹é‡"
git push origin feature/115bot-optimizations
```

### 11.3 å®Œæ•´éƒ¨ç½²

```bash
# 1. åˆå¹¶æ‰€æœ‰åŠŸèƒ½åˆ†æ”¯
git checkout main
git merge feature/hybrid-architecture
git merge feature/115bot-optimizations

# 2. æ›´æ–°ä¾èµ–
pip install -r app/backend/requirements.txt

# 3. æ‰§è¡Œæ•°æ®åº“è¿ç§»
cd app/backend
alembic upgrade head

# 4. é‡æ–°æ„å»ºDockeré•œåƒ
docker-compose build --no-cache

# 5. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 6. éªŒè¯åŠŸèƒ½
curl http://localhost:9393/api/health
curl http://localhost:9393/api/resources/rules

# 7. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f backend
```

### 11.4 éªŒè¯æ¸…å•

- [ ] æ··åˆæ¶æ„æ ¸å¿ƒåŠŸèƒ½
  - [ ] æ¶ˆæ¯åˆ†å‘å™¨æ­£å¸¸å·¥ä½œ
  - [ ] èµ„æºç›‘æ§è§„åˆ™å¯ä»¥åˆ›å»ºå’Œç®¡ç†
  - [ ] é“¾æ¥æå–åŠŸèƒ½æ­£å¸¸
  - [ ] è‡ªåŠ¨è½¬å­˜115åŠŸèƒ½æ­£å¸¸

- [ ] æ€§èƒ½ä¼˜åŒ–åŠŸèƒ½
  - [ ] æ¶ˆæ¯ç¼“å­˜å‘½ä¸­ç‡ > 80%
  - [ ] æ‰¹é‡æ•°æ®åº“å†™å…¥æ­£å¸¸
  - [ ] æ™ºèƒ½é‡è¯•é˜Ÿåˆ—æ­£å¸¸

- [ ] æ¨é€é€šçŸ¥åŠŸèƒ½ â­ æ–°å¢
  - [ ] Telegramé€šçŸ¥æ­£å¸¸å‘é€
  - [ ] Webæ¨é€é€šçŸ¥æ­£å¸¸ï¼ˆå¦‚å·²å®ç°ï¼‰
  - [ ] Webhooké€šçŸ¥æ­£å¸¸å‘é€
  - [ ] é€šçŸ¥è§„åˆ™ç®¡ç†æ­£å¸¸
  - [ ] é€šçŸ¥å†å²è®°å½•æ­£å¸¸
  - [ ] é€šçŸ¥æ¨¡æ¿æ¸²æŸ“æ­£å¸¸
  - [ ] ä¸‹è½½å®Œæˆé€šçŸ¥æ­£å¸¸
  - [ ] èµ„æºæ•è·é€šçŸ¥æ­£å¸¸
  - [ ] 115è½¬å­˜é€šçŸ¥æ­£å¸¸
  - [ ] ä»»åŠ¡å¼‚å¸¸é€šçŸ¥æ­£å¸¸

- [ ] 115Botå€Ÿé‰´åŠŸèƒ½
  - [ ] ç§’ä¼ æ£€æµ‹åŠŸèƒ½æ­£å¸¸ï¼ˆèŠ‚çœ90%ä¸Šä¼ æ—¶é—´ï¼‰
  - [ ] æ™ºèƒ½æ–‡ä»¶è¿‡æ»¤æ­£å¸¸ï¼ˆè¿‡æ»¤å¹¿å‘Šæ–‡ä»¶ï¼‰
  - [ ] ä»»åŠ¡è°ƒåº¦å™¨æ­£å¸¸è¿è¡Œ
  - [ ] ä¼˜å…ˆçº§é˜Ÿåˆ—æ­£å¸¸å·¥ä½œ
  - [ ] æ‰¹é‡æ“ä½œåŠŸèƒ½æ­£å¸¸

- [ ] å‰ç«¯ç•Œé¢
  - [ ] èµ„æºç›‘æ§é¡µé¢å¯è®¿é—®
  - [ ] è§„åˆ™åˆ—è¡¨å’Œè¡¨å•æ­£å¸¸
  - [ ] è®°å½•åˆ—è¡¨å’Œè¯¦æƒ…æ­£å¸¸
  - [ ] ä¼˜å…ˆçº§è°ƒæ•´åŠŸèƒ½æ­£å¸¸
  - [ ] é€šçŸ¥ä¸­å¿ƒå¯è®¿é—® â­ æ–°å¢
  - [ ] é€šçŸ¥è®¾ç½®é¡µé¢æ­£å¸¸ â­ æ–°å¢

---

## 12. ç›¸å…³æ–‡æ¡£

- [115Botæ·±åº¦åˆ†æ](./115BOT_ANALYSIS.md) - 115Boté¡¹ç›®çš„è¯¦ç»†åˆ†æå’Œå€Ÿé‰´ç‚¹
- [è§†é¢‘è½¬å­˜æ–¹æ¡ˆå¯¹æ¯”](./VIDEO_TRANSFER_COMPARISON.md) - TMCä¸115Botçš„æŠ€æœ¯å¯¹æ¯”
- [èµ„æºç›‘æ§ç”¨æˆ·æŒ‡å—](./RESOURCE_MONITOR_USER_GUIDE.md) - ç”¨æˆ·ä½¿ç”¨æ–‡æ¡£ï¼ˆå¾…åˆ›å»ºï¼‰
- [èµ„æºç›‘æ§æµ‹è¯•æŒ‡å—](./RESOURCE_MONITOR_TESTING.md) - æµ‹è¯•æ–‡æ¡£ï¼ˆå¾…åˆ›å»ºï¼‰

---

**ğŸ‰ ç¥å¼€å‘é¡ºåˆ©ï¼**

å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–éœ€è¦è°ƒæ•´ï¼Œè¯·éšæ—¶åé¦ˆã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€æ˜“æ‰©å±•ã€ç”¨æˆ·å‹å¥½çš„æ··åˆæ¶æ„ç³»ç»Ÿï¼ğŸš€


