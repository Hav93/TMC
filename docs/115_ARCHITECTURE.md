# 115网盘集成架构设计

## 📐 系统架构总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用户界面层 (Frontend)                        │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  React + TypeScript + Ant Design                               │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │    │
│  │  │ 登录管理页面  │  │ OAuth授权页面 │  │ 文件管理页面  │        │    │
│  │  │ - 二维码显示  │  │ - Device Flow │  │ - 上传/下载   │        │    │
│  │  │ - 状态轮询    │  │ - Token管理   │  │ - 文件列表    │        │    │
│  │  │ - 用户信息    │  │ - 权限激活    │  │ - 目录管理    │        │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘        │    │
│  └────────────────────────────────────────────────────────────────┘    │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │ HTTP/HTTPS (REST API)
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            API网关层 (FastAPI Router)                    │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  /api/pan115/*  路由组                                          │    │
│  │  ├── /config                    配置管理（GET/POST）            │    │
│  │  ├── /regular-qrcode            常规登录二维码                  │    │
│  │  ├── /regular-qrcode/status     扫码状态检查                    │    │
│  │  ├── /activate-open-api         激活开放平台                    │    │
│  │  ├── /poll-device-token         OAuth轮询                       │    │
│  │  ├── /test-cookies              Cookie可用性测试                │    │
│  │  ├── /refresh-user-info         刷新用户信息                    │    │
│  │  └── /upload                    文件上传                        │    │
│  │                                                                  │    │
│  │  中间件：                                                         │    │
│  │  - 身份认证 (JWT)                                                │    │
│  │  - 请求日志                                                      │    │
│  │  - 异常处理                                                      │    │
│  └────────────────────────────────────────────────────────────────┘    │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           业务逻辑层 (Service Layer)                     │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  Pan115Client (核心客户端类)                                     │    │
│  │  ┌──────────────────────┐  ┌──────────────────────┐           │    │
│  │  │  认证模块              │  │  文件操作模块          │           │    │
│  │  ├──────────────────────┤  ├──────────────────────┤           │    │
│  │  │ • get_regular_qrcode │  │ • upload_file        │           │    │
│  │  │ • check_qrcode_status│  │ • list_files         │           │    │
│  │  │ • get_device_code    │  │ • delete_files       │           │    │
│  │  │ • poll_device_token  │  │ • move_files         │           │    │
│  │  │ • get_access_token   │  │ • copy_files         │           │    │
│  │  │ • refresh_token      │  │ • rename_file        │           │    │
│  │  │ • _generate_pkce     │  │ • create_directory   │           │    │
│  │  └──────────────────────┘  │ • search_files       │           │    │
│  │                             │ • get_download_url   │           │    │
│  │  ┌──────────────────────┐  │ • save_share         │           │    │
│  │  │  用户信息模块          │  │ • get_share_info     │           │    │
│  │  ├──────────────────────┤  └──────────────────────┘           │    │
│  │  │ • get_user_info      │                                      │    │
│  │  │ • _get_space_info    │  ┌──────────────────────┐           │    │
│  │  │ • test_connection    │  │  工具模块              │           │    │
│  │  └──────────────────────┘  ├──────────────────────┤           │    │
│  │                             │ • _get_client_kwargs │           │    │
│  │                             │ • _generate_signature│           │    │
│  │                             │ • _rate_limit        │           │    │
│  │                             └──────────────────────┘           │    │
│  └────────────────────────────────────────────────────────────────┘    │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          网络通信层 (HTTP Client)                        │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  httpx.AsyncClient                                              │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  配置项：                                                   │  │    │
│  │  │  • timeout: 可配置超时时间（默认10s，上传600s）             │  │    │
│  │  │  • trust_env: 代理配置（默认False）                        │  │    │
│  │  │  • proxies: 代理服务器（可选）                             │  │    │
│  │  │  • follow_redirects: 跟随重定向（登录时禁用）              │  │    │
│  │  │  • headers: User-Agent, Cookie, Authorization等           │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │                                                                  │    │
│  │  功能：                                                           │    │
│  │  • 自动重试机制（可选）                                           │    │
│  │  • 请求限流控制                                                   │    │
│  │  • 连接池管理                                                     │    │
│  │  • 超时处理                                                       │    │
│  └────────────────────────────────────────────────────────────────┘    │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          115云服务API层                                  │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  常规登录API (qrcodeapi.115.com, passportapi.115.com)          │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  GET /api/1.0/{app}/1.0/token         获取登录二维码       │  │    │
│  │  │  GET /get/status/                     检查扫码状态        │  │    │
│  │  │  POST /app/1.0/{app}/1.0/login/qrcode 登录并获取Cookie   │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │                                                                  │    │
│  │  开放平台OAuth API (passportapi.115.com)                        │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  POST /open/authDeviceCode            获取设备授权码       │  │    │
│  │  │  POST /app/1.0/token                  获取Access Token   │  │    │
│  │  │  POST /open/user/info                 获取用户信息        │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │                                                                  │    │
│  │  Web API (webapi.115.com)                                       │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  GET /user/info                       获取用户信息        │  │    │
│  │  │  GET /files                           列出文件           │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │                                                                  │    │
│  │  开放平台文件API (proapi.115.com)                               │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  POST /2.0/upload/init                初始化上传          │  │    │
│  │  │  POST /2.0/file/add                   创建文件夹          │  │    │
│  │  │  GET  /2.0/file/list                  列出文件           │  │    │
│  │  │  POST /2.0/file/delete                删除文件           │  │    │
│  │  │  POST /2.0/file/move                  移动文件           │  │    │
│  │  │  GET  /2.0/file/download_url          获取下载链接        │  │    │
│  │  │  POST /2.0/share/receive              转存分享           │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────────────┘    │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          数据持久化层 (Storage)                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  数据库 (SQLite/PostgreSQL)                                      │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  media_settings 表                                        │  │    │
│  │  │  ├── pan115_app_id              开放平台AppID             │  │    │
│  │  │  ├── pan115_user_id             用户ID                    │  │    │
│  │  │  ├── pan115_user_key            Cookie/Token             │  │    │
│  │  │  ├── pan115_device_type         设备类型                  │  │    │
│  │  │  ├── pan115_access_token        访问令牌                  │  │    │
│  │  │  ├── pan115_refresh_token       刷新令牌                  │  │    │
│  │  │  ├── pan115_token_expires_at    令牌过期时间              │  │    │
│  │  │  ├── pan115_user_info           用户信息(JSON)            │  │    │
│  │  │  ├── pan115_last_refresh_at     上次刷新时间              │  │    │
│  │  │  ├── pan115_request_interval    请求间隔                  │  │    │
│  │  │  └── pan115_use_proxy           是否使用代理              │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  │                                                                  │    │
│  │  文件系统                                                         │    │
│  │  ┌──────────────────────────────────────────────────────────┐  │    │
│  │  │  /app/config/115-cookies.txt        Cookie持久化文件      │  │    │
│  │  │  /app/backend/logs/pan115.log       客户端日志           │  │    │
│  │  │  /app/media/storage/                文件缓存目录          │  │    │
│  │  └──────────────────────────────────────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 核心流程图

### 1. Cookie登录流程

```
┌─────────┐
│ 用户操作 │
└────┬────┘
     │
     ▼
┌────────────────────────────────────────────┐
│ 1. 点击"扫码登录"按钮                       │
│    选择设备类型: qandroid/android/ios/web  │
└────┬───────────────────────────────────────┘
     │
     ▼
┌────────────────────────────────────────────┐
│ 2. 前端调用: GET /api/pan115/regular-qrcode│
│    参数: { "app": "qandroid" }             │
└────┬───────────────────────────────────────┘
     │
     ▼
┌────────────────────────────────────────────┐
│ 3. 后端创建Pan115Client                    │
│    调用: client.get_regular_qrcode(app)    │
└────┬───────────────────────────────────────┘
     │
     ▼
┌────────────────────────────────────────────┐
│ 4. 请求115 API                             │
│    GET qrcodeapi.115.com/api/1.0/{app}/... │
└────┬───────────────────────────────────────┘
     │
     ▼
┌────────────────────────────────────────────┐
│ 5. 返回二维码数据                           │
│    • qrcode_url: 二维码图片(base64)        │
│    • qrcode_token: {uid, time, sign}      │
│    • expires_in: 300秒                    │
└────┬───────────────────────────────────────┘
     │
     ▼
┌────────────────────────────────────────────┐
│ 6. 前端显示二维码Modal                      │
│    启动轮询: 每2秒检查一次状态              │
└────┬───────────────────────────────────────┘
     │
     │  ┌─────────────────────────────┐
     ├─▶│ 7a. 轮询检查扫码状态         │◀─┐
     │  │  POST /regular-qrcode/status │  │
     │  │  参数: qrcode_token, app     │  │
     │  └─────┬───────────────────────┘  │
     │        │                           │
     │        ▼                           │
     │  ┌─────────────────────────┐      │
     │  │ status = waiting?        │──是──┘
     │  │ (用户还未扫码)            │ 继续轮询
     │  └─────┬───────────────────┘
     │        │ 否
     │        ▼
     │  ┌─────────────────────────┐
     │  │ status = scanned?        │──是──┐
     │  │ (已扫码，等待确认)        │      │
     │  └─────┬───────────────────┘      │
     │        │ 否                       │
     │        ▼                          │
     │  ┌─────────────────────────┐      │
     │  │ status = confirmed?      │      │
     │  │ (用户已确认)              │      │
     │  └─────┬───────────────────┘      │
     │        │ 是                       │
     │        ▼                          │
     │  ┌─────────────────────────┐      │
     │  │ 8. 调用登录API           │      │
     │  │  POST passportapi.115.com│      │
     │  │  /login/qrcode           │      │
     │  └─────┬───────────────────┘      │
     │        │                          │
     │        ▼                          │
     │  ┌─────────────────────────┐      │
     │  │ 9. 获取登录凭证          │      │
     │  │  • cookies (UID/CID等)  │      │
     │  │  • user_id              │      │
     │  │  • user_info (VIP等)    │      │
     │  └─────┬───────────────────┘      │
     │        │                          │
     │        ▼                          │
     │  ┌─────────────────────────┐      │
     │  │ 10. 保存到数据库         │      │
     │  │  • media_settings表     │      │
     │  └─────┬───────────────────┘      │
     │        │                          │
     │        ▼                          │
     │  ┌─────────────────────────┐      │
     │  │ 11. 保存到文件系统       │      │
     │  │  /config/115-cookies.txt│      │
     │  └─────┬───────────────────┘      │
     │        │                          │
     │        ▼                          │
     │  ┌─────────────────────────┐      │
     │  │ 12. 停止轮询             │      │
     │  │  关闭Modal               │      │
     │  │  刷新配置数据             │      │
     │  └─────┬───────────────────┘      │
     │        │                          │
     └────────┴──────────────────────────┘
              │
              ▼
     ┌────────────────┐
     │ ✅ 登录成功     │
     │ 显示用户信息    │
     └────────────────┘
```

### 2. OAuth激活流程（使用Cookie+AppID）

```
┌──────────────────────────────┐
│ 前置条件：已完成Cookie登录     │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ 1. 用户填写AppID               │
│    点击"启用OPENAPI"开关       │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ 2. 前端调用:                   │
│    POST /activate-open-api    │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ 3. 后端读取配置:               │
│    • AppID (用户输入)          │
│    • Cookie (已保存)           │
│    • user_id (已保存)          │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ 4. 创建Pan115Client            │
│    调用: get_access_token()   │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ 5. 请求Token API:              │
│    POST passportapi.115.com   │
│    /app/1.0/token             │
│    参数: client_id (AppID)    │
│    请求头: Cookie             │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ 6. 115服务器验证:              │
│    • Cookie有效性检查          │
│    • AppID权限检查             │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ 7. 返回Token:                  │
│    • access_token (2小时)     │
│    • refresh_token (可选)     │
│    • expires_in: 7200         │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ 8. 保存到数据库:               │
│    • pan115_access_token      │
│    • pan115_refresh_token     │
│    • pan115_token_expires_at  │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ 9. 使用access_token:           │
│    刷新用户信息和空间数据       │
└──────────┬───────────────────┘
           │
           ▼
┌──────────────────────────────┐
│ 10. 更新前端状态:              │
│     open_api_activated = true│
└──────────┬───────────────────┘
           │
           ▼
     ┌────────────────┐
     │ ✅ 激活成功     │
     └────────────────┘
```

### 3. 文件上传流程

```
┌──────────────────────┐
│ 用户选择本地文件      │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│ 1. 前端调用: POST /api/pan115/upload │
│    参数:                              │
│    • file_path: 本地文件路径          │
│    • remote_path: 目标目录路径        │
└──────┬───────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│ 2. 后端检查文件:                      │
│    • 文件是否存在                     │
│    • 计算文件大小和SHA1               │
└──────┬───────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│ 3. 创建目标目录（如果需要）:          │
│    递归创建 /telegram_downloads       │
└──────┬───────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│ 4. 获取上传信息:                      │
│    POST proapi.115.com/2.0/upload/init│
│    参数: file_name, file_size, sha1   │
└──────┬───────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────┐
│ 5. 115服务器检查:                     │
│    • 是否已存在相同文件(SHA1)         │
└──────┬───────────────────────────────┘
       │
       ├─存在─▶ ┌────────────────────┐
       │        │ 6a. 秒传成功        │
       │        │ 返回: file_id       │
       │        │ quick_upload=true   │
       │        └────────────────────┘
       │
       └─不存在─▶ ┌─────────────────────────┐
                 │ 6b. 需要真实上传         │
                 │ 获取: upload_url, params│
                 └─────┬───────────────────┘
                       │
                       ▼
                 ┌─────────────────────────┐
                 │ 7. 上传文件到115服务器   │
                 │ POST {upload_url}       │
                 │ multipart/form-data     │
                 └─────┬───────────────────┘
                       │
                       ▼
                 ┌─────────────────────────┐
                 │ 8. 返回上传结果          │
                 │ • file_id               │
                 │ • quick_upload=false    │
                 └─────────────────────────┘
       │
       ▼
┌──────────────────────┐
│ ✅ 上传成功          │
│ 返回文件ID给前端     │
└──────────────────────┘
```

---

## 🔐 认证与授权架构

### Cookie认证流程

```
┌────────────┐      1. 扫码登录        ┌──────────────┐
│   用户     │─────────────────────────▶│ 115登录服务   │
└────────────┘                          └──────┬───────┘
                                               │
                                               │ 2. 返回Cookie
                                               ▼
┌────────────┐      3. 保存Cookie      ┌──────────────┐
│   后端     │◀─────────────────────────│  数据库/文件  │
└─────┬──────┘                          └──────────────┘
      │
      │ 4. 后续API请求携带Cookie
      ▼
┌──────────────┐
│  115 Web API │
│  • /user/info │
│  • /files     │
└──────────────┘
```

### Access Token认证流程

```
┌────────────┐  1. Cookie+AppID   ┌──────────────────┐
│   后端     │────────────────────▶│ 115 Token服务     │
└────────────┘                     └────────┬─────────┘
                                            │
                                            │ 2. 返回Token
                                            ▼
┌────────────┐  3. 保存Token       ┌──────────────────┐
│   数据库   │◀────────────────────│   后端            │
└────────────┘                     └────────┬─────────┘
                                            │
                                            │ 4. API请求携带
                                            │    Authorization:
                                            │    Bearer {token}
                                            ▼
                                   ┌──────────────────┐
                                   │ 115开放平台API    │
                                   │  • /open/user/info│
                                   │  • /2.0/file/*    │
                                   └──────────────────┘
```

### OAuth 2.0 Device Flow (PKCE)

```
┌─────────┐                          ┌──────────────┐
│  后端   │   1. 生成PKCE参数         │  后端内存    │
│         │   code_verifier ────────▶│  临时存储    │
│         │   code_challenge          └──────────────┘
└────┬────┘
     │
     │ 2. 请求授权码
     ▼
┌──────────────────┐
│ 115 OAuth服务    │
│ /open/authDevice │
│ Code             │
└────┬─────────────┘
     │
     │ 3. 返回设备码
     │    device_code
     │    user_code (给用户看)
     │    qrcode_url (二维码)
     ▼
┌─────────┐
│  前端   │ 4. 显示二维码
│  Modal  │    启动轮询
└────┬────┘
     │
     │ 5. 用户扫码授权
     ▼
┌──────────────────┐
│ 115 OAuth服务    │ 6. 用户确认授权
└────┬─────────────┘
     │
     │ 7. 后端轮询检查
     ▼
┌──────────────────┐
│ /open/token      │ 8. 提交:
│                  │    device_code
│                  │    code_verifier (验证PKCE)
└────┬─────────────┘
     │
     │ 9. 验证通过，返回Token
     ▼
┌─────────┐
│  后端   │ 10. 保存Token到数据库
└─────────┘
```

---

## 📊 数据流图

### 配置数据流

```
┌───────────────┐
│  用户输入     │ AppID, 请求间隔, 代理设置
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  前端表单     │ Form validation
└───────┬───────┘
        │ POST /api/pan115/config
        ▼
┌───────────────┐
│  API路由      │ 身份验证
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  数据库更新   │ MediaSettings表
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  配置生效     │ 后续请求使用新配置
└───────────────┘
```

### 用户信息数据流

```
┌───────────────┐
│ 115 API       │ 用户信息来源
└───────┬───────┘
        │
        ▼
┌───────────────────────────────────┐
│ Pan115Client.get_user_info()      │
│ • 优先使用access_token (更稳定)   │
│ • 回退到Cookie (可能被限流)        │
└───────┬───────────────────────────┘
        │
        ▼
┌───────────────────────────────────┐
│ 解析并格式化:                      │
│ • user_id, user_name              │
│ • is_vip, vip_level, vip_name     │
│ • space: {total, used, remain}    │
└───────┬───────────────────────────┘
        │
        ├──▶ 保存到数据库 (JSON格式)
        │    pan115_user_info
        │
        └──▶ 返回给前端 (实时显示)
```

### 文件上传数据流

```
┌──────────────┐
│ 本地文件     │ /path/to/file.mp4
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 计算SHA1     │ 文件指纹
└──────┬───────┘
       │
       ▼
┌──────────────────────────────┐
│ 115检查重复                   │
│ • 存在 → 秒传 (返回file_id)  │
│ • 不存在 → 真实上传           │
└──────┬───────────────────────┘
       │
       ▼
┌──────────────────────────────┐
│ multipart/form-data上传       │
│ • file: 文件流                │
│ • params: 签名参数            │
└──────┬───────────────────────┘
       │
       ▼
┌──────────────┐
│ 115存储      │ 文件保存到云端
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 返回file_id  │ 文件唯一标识符
└──────────────┘
```

---

## 🛡️ 安全架构

### 凭证存储安全

```
┌────────────────────────────────────────┐
│  敏感数据分层存储                       │
├────────────────────────────────────────┤
│  数据库 (SQLite/PostgreSQL)            │
│  • Cookie (加密存储 - 可选)            │
│  • Access Token (加密存储 - 可选)      │
│  • Refresh Token                       │
│  • 用户信息 (JSON, 非敏感)             │
├────────────────────────────────────────┤
│  文件系统                               │
│  • /config/115-cookies.txt             │
│    权限: 600 (仅所有者可读写)          │
│    备份: 自动同步到数据库               │
├────────────────────────────────────────┤
│  内存 (运行时)                          │
│  • PKCE code_verifier                  │
│    生命周期: 仅在OAuth流程中           │
│    范围: 进程内部，不持久化             │
└────────────────────────────────────────┘
```

### API请求安全

```
┌────────────────────────────────────────┐
│  请求签名验证（开放平台API）            │
├────────────────────────────────────────┤
│  1. 收集参数:                           │
│     app_id, user_id, user_key,         │
│     timestamp, ...                     │
│                                        │
│  2. 参数排序:                           │
│     按key字母顺序排序                   │
│                                        │
│  3. 拼接字符串:                         │
│     key1value1key2value2...+ app_key   │
│                                        │
│  4. MD5签名:                            │
│     sign = MD5(拼接字符串).upper()     │
│                                        │
│  5. 添加到请求:                         │
│     params['sign'] = sign              │
└────────────────────────────────────────┘
```

### PKCE流程安全

```
┌────────────────────────────────────────┐
│  PKCE (Proof Key for Code Exchange)   │
├────────────────────────────────────────┤
│  目的: 防止授权码拦截攻击               │
│                                        │
│  流程:                                  │
│  1. 生成随机 code_verifier (43-128字符)│
│  2. 计算 code_challenge:               │
│     SHA256(code_verifier) → Base64URL  │
│  3. 请求授权时发送 code_challenge      │
│  4. 获取Token时发送 code_verifier      │
│  5. 服务器验证:                         │
│     SHA256(收到的verifier) ==          │
│     之前的challenge                    │
│                                        │
│  攻击者即使拦截了授权码，也无法获取     │
│  Token，因为缺少 code_verifier         │
└────────────────────────────────────────┘
```

---

## 📈 性能优化架构

### 缓存策略

```
┌────────────────────────────────────────────────┐
│  多级缓存架构                                   │
├────────────────────────────────────────────────┤
│  L1: 内存缓存 (运行时)                          │
│  • Pan115Client实例缓存                        │
│  • 用户信息临时缓存 (30秒TTL)                  │
│  • 文件列表缓存 (可选)                          │
├────────────────────────────────────────────────┤
│  L2: 数据库缓存                                 │
│  • pan115_user_info (长期缓存)                 │
│  • pan115_last_refresh_at (防抖控制)           │
├────────────────────────────────────────────────┤
│  L3: 115服务器 (最终数据源)                     │
│  • 按需请求，避免频繁调用                       │
│  • 使用Token优先（更稳定）                      │
└────────────────────────────────────────────────┘
```

### 请求限流

```
┌────────────────────────────────────────┐
│  API限流控制                            │
├────────────────────────────────────────┤
│  请求1   ───▶ [等待0s] ───▶ 执行       │
│  请求2   ───▶ [等待1s] ───▶ 执行       │
│  请求3   ───▶ [等待2s] ───▶ 执行       │
│  ...                                   │
│                                        │
│  实现:                                  │
│  • last_request_time 记录上次时间      │
│  • request_interval 配置间隔(默认1s)   │
│  • 每次请求前计算等待时间               │
│  • asyncio.sleep() 异步等待             │
└────────────────────────────────────────┘
```

### 并发控制

```
┌────────────────────────────────────────┐
│  异步并发架构                           │
├────────────────────────────────────────┤
│  单个客户端实例:                        │
│  • 串行处理API请求（限流）              │
│                                        │
│  多个客户端实例:                        │
│  • 每个用户独立实例                     │
│  • 互不影响，并行处理                   │
│                                        │
│  上传队列:                              │
│  • 大文件排队上传                       │
│  • 避免同时上传过多文件                 │
│  • 进度跟踪和失败重试                   │
└────────────────────────────────────────┘
```

---

## 📝 总结

本架构设计实现了：

✅ **模块化设计**：前后端分离，职责清晰  
✅ **双模式支持**：Cookie登录（快速）+ OAuth API（稳定）  
✅ **安全可靠**：PKCE防拦截、Cookie持久化、签名验证  
✅ **高性能**：多级缓存、请求限流、异步并发  
✅ **可扩展**：易于添加新功能（分享、下载等）  
✅ **容错机制**：自动重试、防抖控制、缓存回退  

---

**架构文档版本**：v1.0  
**最后更新**：2025-01-17





