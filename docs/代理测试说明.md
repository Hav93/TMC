# 🌐 代理测试功能说明

## 📝 功能说明

代理测试功能用于验证：**后端服务器 → 代理服务器 → Telegram** 的连通性

## 🔄 测试流程

```
1. 用户在前端填写代理配置
   ├─ 代理类型: http/socks5
   ├─ 代理地址: IP或域名
   ├─ 代理端口: 7890
   └─ 用户名/密码(可选)

2. 前端发送到后端: POST /api/settings/test-proxy

3. 后端执行测试:
   ├─ 步骤1: TCP连接到代理服务器
   ├─ 步骤2: 通过代理访问 https://telegram.org
   └─ 返回: 成功/失败 + 延迟

4. 前端显示结果
```

## ⚠️ Docker环境下的代理地址

### 问题：代理在宿主机上运行

如果您的代理（如Clash、V2Ray）运行在**宿主机**上：

❌ **错误配置**：
```
代理地址: 127.0.0.1
代理端口: 7890
```

**问题**：Docker容器的`127.0.0.1`是容器自己，不是宿主机！

✅ **正确配置（3种方案）**：

#### 方案1：使用host.docker.internal（推荐）
```
代理地址: host.docker.internal
代理端口: 7890
```

适用于：Windows、Mac Docker Desktop

#### 方案2：使用宿主机局域网IP
```
代理地址: 192.168.31.6  (你的电脑IP)
代理端口: 7890
```

**注意**：需要代理软件允许局域网连接（Clash设置中开启"Allow LAN"）

#### 方案3：使用网桥IP
```bash
# 查看Docker网桥IP
docker network inspect bridge | grep Gateway

# 通常是
代理地址: 172.17.0.1
代理端口: 7890
```

## 🧪 测试步骤

### 1. 确保代理正在运行

**Clash示例**：
- 打开Clash
- 确认代理端口（通常7890）
- 开启"Allow LAN"（如果使用局域网IP）

### 2. 在前端填写配置

进入：设置 → 代理配置

```
✅ 启用代理
代理类型: http
代理地址: host.docker.internal  (或 192.168.31.6)
代理端口: 7890
```

### 3. 点击"测试连接"

**成功示例**：
```
✅ 代理连接测试成功！

代理连接: ✅ 成功 (TCP延迟: 2ms)
Telegram访问: ✅ 成功 (HTTP延迟: 345ms)
总延迟: 347ms (很快 ✨)

评价: 代理工作正常，速度很快！
```

**失败示例**：
```
❌ 代理连接失败
连接被拒绝 (目标端口未开放)

请检查:
1. 代理服务器是否运行
2. IP和端口是否正确
3. 防火墙设置
```

## 🔧 常见问题

### Q1: "Failed to fetch"

**原因**: 前端无法连接到后端API

**解决方案**：
1. 检查后端服务是否运行：`docker ps`
2. 重启容器：`docker-compose restart`
3. 清除浏览器缓存，重新登录

### Q2: "连接被拒绝"

**原因**: 后端无法连接到代理服务器

**检查清单**：
- ✅ 代理软件正在运行
- ✅ 代理地址不是`127.0.0.1`（Docker环境）
- ✅ 代理端口正确（通常7890）
- ✅ 代理允许局域网连接（如果用局域网IP）
- ✅ 防火墙未阻止端口

### Q3: "连接超时"

**原因**: 代理无法访问Telegram

**可能情况**：
- 代理节点失效
- 代理配置错误
- 网络问题

**解决方案**：
1. 测试代理本身是否工作（在宿主机浏览器测试）
2. 更换代理节点
3. 检查代理软件日志

### Q4: 延迟很高（>2000ms）

**原因**: 代理节点距离远或负载高

**建议**：
- 更换到更近的节点
- 选择延迟更低的节点

## 📊 延迟参考

```
< 500ms   : 极快 🚀 (推荐)
500-1000ms: 很快 ✨
1000-2000ms: 正常 ✓
> 2000ms  : 较慢 ⚠️ (建议更换节点)
```

## 🔐 Docker Compose配置

如果您使用`docker-compose.yml`，可以配置网络模式：

```yaml
services:
  app:
    # 方法1: 使用host网络（直接访问宿主机127.0.0.1）
    network_mode: "host"
    
    # 方法2: 添加extra_hosts
    extra_hosts:
      - "host.docker.internal:host-gateway"
```

重启后：
```bash
docker-compose up -d
```

## 💡 最佳实践

1. **代理地址**：优先使用`host.docker.internal`
2. **定期测试**：更换节点后重新测试
3. **记录配置**：成功的配置保存备用
4. **监控延迟**：延迟突然升高时更换节点

---

**相关文档**：
- `docs/CORS_FIX_FOR_LAN.md` - CORS问题修复
- `docs/SERVER_DEPLOYMENT_GUIDE.md` - 服务器部署指南

