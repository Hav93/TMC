# 🧪 test 分支策略说明

## 分支定位

**test 分支是实验性功能分支，不维护向后兼容性。**

---

## 📋 核心原则

### ✅ 我们做什么

1. **快速迭代新功能**
   - 媒体监控和管理
   - 115网盘集成
   - 文件元数据提取
   - 新的 API 接口

2. **简化部署流程**
   - 推荐全新部署
   - 自动创建最新数据库结构
   - 减少维护复杂度

3. **保持代码清洁**
   - 不保留历史兼容代码
   - 不维护复杂的迁移脚本
   - 专注功能本身

### ❌ 我们不做什么

1. **不维护数据库迁移兼容性**
   - 不支持从 main 分支平滑升级
   - 不保证旧数据库能正常工作
   - 不提供迁移脚本

2. **不保证稳定性**
   - 可能随时重构
   - 可能引入破坏性更改
   - 建议只在测试环境使用

3. **不提供数据恢复方案**
   - 升级可能导致数据丢失
   - 建议定期备份
   - 生产环境请谨慎使用

---

## 🎯 适用场景

### ✅ 适合使用 test 分支

- 🆕 全新部署
- 🧪 测试环境
- 🔬 功能验证
- 📊 性能测试
- 🎓 学习和研究

### ❌ 不适合使用 test 分支

- 🏭 生产环境（除非你完全理解风险）
- 💾 有重要历史数据
- 🔒 需要稳定性保证
- 📈 关键业务系统

---

## 🚀 快速开始

### 1. 全新部署

```bash
# 克隆项目
git clone <repo-url>
cd <project>

# 切换到 test 分支
git checkout test

# 启动（会自动创建数据库）
docker-compose up -d

# 查看日志
docker logs -f tmc-local
```

### 2. 从 main 分支切换

```bash
# 停止服务
docker-compose down

# 备份数据（可选）
cp -r ./data ./data_backup_$(date +%Y%m%d)

# 切换分支
git checkout test
git pull origin test

# 删除旧数据库（重要！）
rm -f ./data/bot.db

# 重新构建和启动
docker-compose build --no-cache
docker-compose up -d
```

---

## 📊 数据库策略

### 启动时的行为

```
1. 检查数据库文件是否存在
   ├─ 不存在：创建全新数据库 ✅
   └─ 存在：
       ├─ 结构正确：直接使用 ✅
       └─ 结构错误：报错并建议删除 ⚠️

2. 运行 Alembic 迁移
   ├─ 空数据库：应用所有迁移 ✅
   ├─ 最新版本：跳过 ✅
   └─ 旧版本：尝试升级（可能失败） ⚠️

3. 创建默认管理员（如果需要）
```

### 如果遇到问题

```bash
# 最简单的解决方案：删除数据库重新创建
docker-compose down
rm -f ./data/bot.db
docker-compose up -d
```

---

## 🔄 从 main 到 test 的变化

### 数据库结构

```diff
+ media_settings         # 媒体全局配置
+ media_monitor_rules    # 监控规则
+ media_files            # 媒体文件记录
+ download_tasks         # 下载任务队列

- clouddrive_*           # 移除 CloudDrive 相关字段
+ pan115_*               # 新增 115网盘字段
```

### 启动流程

```diff
- fix_alembic_version.py      # 删除（不再需要复杂的版本检测）
- check_and_fix_schema.py     # 删除（不再需要自动修复）
+ 简化的启动检查               # 只做基本验证
```

### 代码变更

```diff
- CloudDrive 集成代码
+ 115网盘集成代码
+ 媒体监控服务
+ 文件元数据提取
+ 下载任务管理
```

---

## 📝 开发者指南

### 添加新功能时

1. **不用考虑向后兼容**
   - 直接修改模型
   - 创建新的迁移文件
   - 不需要处理旧数据

2. **保持简单**
   - 避免复杂的迁移逻辑
   - 推荐用户重新部署
   - 在文档中明确说明

3. **测试覆盖**
   - 测试全新部署场景
   - 测试空数据库初始化
   - 不需要测试升级路径

### 合并到 main 分支时

当功能稳定后，合并到 main 分支时需要：

1. **重新设计迁移策略**
   - 创建向后兼容的迁移脚本
   - 测试从旧版本升级的路径
   - 提供数据迁移工具

2. **更新文档**
   - 写明升级步骤
   - 说明破坏性更改
   - 提供回滚方案

3. **增加测试**
   - 测试各种升级场景
   - 验证数据完整性
   - 性能测试

---

## 🆘 常见问题

### Q: 可以在生产环境使用 test 分支吗？

**A:** 可以，但**强烈不建议**。test 分支可能随时有破坏性更改，升级可能导致数据丢失。

如果确实要用：
- ✅ 做好完整备份
- ✅ 准备回滚方案
- ✅ 在测试环境充分验证
- ✅ 选择维护窗口升级

### Q: 我有 main 分支的数据，想试用 test 分支怎么办？

**A:** 两个选择：

1. **推荐：独立部署**
   - 在另一个目录部署 test 分支
   - 使用不同的端口
   - 互不影响

2. **备份后切换**
   - 完整备份 main 分支的 data 目录
   - 切换到 test 分支并删除旧数据库
   - 如需回滚，恢复备份即可

### Q: test 分支什么时候会合并到 main？

**A:** 当以下条件满足时：
- ✅ 功能稳定，无严重 bug
- ✅ 性能满足要求
- ✅ 用户反馈良好
- ✅ 完成向后兼容的迁移脚本
- ✅ 文档完善

### Q: 数据库初始化失败怎么办？

**A:** 最简单的解决方案：

```bash
# 1. 停止容器
docker-compose down

# 2. 删除数据库
rm -f ./data/bot.db

# 3. 查看日志定位问题（可选）
docker logs tmc-local > error.log

# 4. 重新启动
docker-compose up -d
```

---

## 📚 相关文档

- [升级指南](./UPGRADE_TO_TEST_BRANCH.md) - 如何从 main 切换到 test
- [数据库重置工具](../scripts/maintenance/reset_database.py) - 数据库清理工具
- [功能说明](../README.md) - test 分支的新功能介绍

---

## 💡 总结

**test 分支的哲学：**

> 简单、快速、实验性。  
> 不追求完美的向后兼容，追求快速迭代和功能创新。  
> 稳定性和兼容性留给 main 分支。

**适合你吗？**

- ✅ 如果你想尝鲜新功能 → test 分支
- ✅ 如果你在搭建测试环境 → test 分支
- ✅ 如果你需要稳定运行 → main 分支
- ✅ 如果你有重要数据 → main 分支

**记住：删除数据库重新部署是 test 分支的标准操作，不是 bug！** 🎯

