# ğŸ” æœåŠ¡å™¨ä»£ç†æµ‹è¯•Failed to fetchæ’æŸ¥æŒ‡å—

## ğŸ“Š é—®é¢˜ç°è±¡

- **æœ¬åœ°ç¯å¢ƒ**ï¼šä»£ç†æµ‹è¯• âœ… æ­£å¸¸
- **æœåŠ¡å™¨ç¯å¢ƒ**ï¼šä»£ç†æµ‹è¯• âŒ Failed to fetch

## ğŸ¯ æ’æŸ¥æ­¥éª¤

### æ­¥éª¤1ï¼šç¡®è®¤æœåŠ¡å™¨å®¹å™¨çŠ¶æ€

```bash
# 1. æ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
docker ps | grep tmc

# 2. æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€
docker inspect tmc-local | grep -A 10 Health

# 3. æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats tmc-local --no-stream
```

### æ­¥éª¤2ï¼šæ£€æŸ¥åç«¯æ—¥å¿—ï¼ˆå…³é”®ï¼ï¼‰

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
docker logs tmc-local -f

# æŸ¥çœ‹æœ€è¿‘100è¡Œ
docker logs tmc-local --tail=100

# æŸ¥æ‰¾OPTIONSè¯·æ±‚
docker logs tmc-local 2>&1 | grep "OPTIONS"

# æŸ¥æ‰¾test-proxyè¯·æ±‚
docker logs tmc-local 2>&1 | grep "test-proxy"
```

**æœŸæœ›çœ‹åˆ°**ï¼š
```
INFO: xxx.xxx.xxx.xxx - "OPTIONS /api/settings/test-proxy HTTP/1.1" 200 OK
INFO: xxx.xxx.xxx.xxx - "POST /api/settings/test-proxy HTTP/1.1" 200 OK
```

**å¦‚æœçœ‹åˆ°401**ï¼š
```
INFO: xxx.xxx.xxx.xxx - "OPTIONS /api/settings/test-proxy HTTP/1.1" 401 Unauthorized
```
è¯´æ˜OPTIONSè¯·æ±‚è¢«æ‹¦æˆªäº†ã€‚

### æ­¥éª¤3ï¼šæ£€æŸ¥ä»£ç ç‰ˆæœ¬

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ£€æŸ¥å½“å‰commit
cd /path/to/TMC
git log --oneline -1

# åº”è¯¥çœ‹åˆ°
# ab07dab fix(middleware): Allow OPTIONS requests to pass through auth
```

**å¦‚æœä¸æ˜¯æœ€æ–°çš„**ï¼š
```bash
git pull origin test
docker-compose restart
```

### æ­¥éª¤4ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡

```bash
# æŸ¥çœ‹å®¹å™¨çš„ç¯å¢ƒå˜é‡
docker exec tmc-local env | grep -E "JWT|CORS|API"

# æ£€æŸ¥JWT_SECRET_KEYæ˜¯å¦è®¾ç½®
docker exec tmc-local env | grep JWT_SECRET_KEY
```

**é‡è¦**ï¼šå¦‚æœJWT_SECRET_KEYæ¯æ¬¡å¯åŠ¨éƒ½ä¸ä¸€æ ·ï¼Œä¼šå¯¼è‡´tokenå¤±æ•ˆã€‚

### æ­¥éª¤5ï¼šæµè§ˆå™¨å¼€å‘è€…å·¥å…·æ£€æŸ¥

**åœ¨æµè§ˆå™¨æŒ‰F12ï¼ŒæŸ¥çœ‹Networkæ ‡ç­¾**ï¼š

#### æƒ…å†µAï¼šOPTIONSè¯·æ±‚å¤±è´¥ï¼ˆ401ï¼‰

```
Request:
  Method: OPTIONS
  URL: http://xxx:9393/api/settings/test-proxy
  Status: 401 Unauthorized

Response Headers:
  Access-Control-Allow-Origin: (æ²¡æœ‰)
```

**åŸå› **ï¼šè®¤è¯ä¸­é—´ä»¶æ‹¦æˆªOPTIONS

**è§£å†³**ï¼šç¡®ä¿ä»£ç å·²æ›´æ–°åˆ°`ab07dab`

#### æƒ…å†µBï¼šOPTIONSæˆåŠŸï¼ŒPOSTå¤±è´¥ï¼ˆ401ï¼‰

```
OPTIONS: 200 OK
POST: 401 Unauthorized
```

**åŸå› **ï¼šJWT Tokenæ— æ•ˆ

**è§£å†³**ï¼š
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
2. é‡æ–°ç™»å½•
3. æ£€æŸ¥JWT_SECRET_KEYæ˜¯å¦å›ºå®š

#### æƒ…å†µCï¼šPOSTæˆåŠŸï¼Œä½†å“åº”æ˜¯CORSé”™è¯¯

```
POST: 200 OK
Console Error: 
  Access to fetch at 'http://xxx:9393/api/settings/test-proxy' 
  from origin 'http://xxx:9393' has been blocked by CORS policy
```

**åŸå› **ï¼šCORSé…ç½®é—®é¢˜

**è§£å†³**ï¼šç¡®ä¿`allow_origins=["*"]`

#### æƒ…å†µDï¼šç½‘ç»œé”™è¯¯ï¼Œè¯·æ±‚æ²¡å‘å‡ºå»

```
Console Error:
  Failed to fetch
  TypeError: NetworkError when attempting to fetch resource
```

**å¯èƒ½åŸå› **ï¼š
1. æœåŠ¡å™¨é˜²ç«å¢™é˜»æ­¢
2. åå‘ä»£ç†é…ç½®é”™è¯¯ï¼ˆå¦‚æœæœ‰ï¼‰
3. Dockerç½‘ç»œé—®é¢˜

### æ­¥éª¤6ï¼šæ‰‹åŠ¨æµ‹è¯•API

```bash
# å…ˆè·å–tokenï¼ˆåœ¨æœåŠ¡å™¨ä¸Šï¼‰
TOKEN="your-jwt-token"

# æµ‹è¯•OPTIONSè¯·æ±‚
curl -X OPTIONS http://localhost:9393/api/settings/test-proxy -v

# åº”è¯¥è¿”å›200ï¼Œä¸éœ€è¦token

# æµ‹è¯•POSTè¯·æ±‚
curl -X POST http://localhost:9393/api/settings/test-proxy \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "enable_proxy": true,
    "proxy_type": "http",
    "proxy_host": "host.docker.internal",
    "proxy_port": 7890
  }' \
  -v
```

### æ­¥éª¤7ï¼šæ£€æŸ¥åå‘ä»£ç†ï¼ˆå¦‚æœæœ‰ï¼‰

å¦‚æœæœåŠ¡å™¨ä½¿ç”¨äº†Nginx/Caddyç­‰åå‘ä»£ç†ï¼š

**Nginxé…ç½®æ£€æŸ¥**ï¼š
```nginx
location /api/ {
    proxy_pass http://localhost:9393;
    
    # è¿™äº›å¿…é¡»æœ‰ï¼
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # CORSç›¸å…³ï¼ˆå¦‚æœåç«¯å·²å¤„ç†CORSï¼Œè¿™é‡Œä¸è¦é‡å¤å¤„ç†ï¼‰
    # add_header Access-Control-Allow-Origin *;
    # add_header Access-Control-Allow-Methods *;
    # add_header Access-Control-Allow-Headers *;
}
```

### æ­¥éª¤8ï¼šæ£€æŸ¥é˜²ç«å¢™

```bash
# æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
sudo ufw status

# ç¡®ä¿9393ç«¯å£å¼€æ”¾
sudo ufw allow 9393

# æˆ–è€…æ£€æŸ¥iptables
sudo iptables -L -n | grep 9393
```

## ğŸ”§ å¸¸è§é—®é¢˜æ±‡æ€»

### é—®é¢˜1ï¼šæœåŠ¡å™¨å®¹å™¨æœªæ›´æ–°

**ç—‡çŠ¶**ï¼š
```bash
docker logs tmc-local 2>&1 | grep OPTIONS
# æ˜¾ç¤ºï¼š401 Unauthorized
```

**è§£å†³**ï¼š
```bash
git pull origin test
docker-compose build --no-cache
docker-compose up -d
```

### é—®é¢˜2ï¼šJWT_SECRET_KEYæœªè®¾ç½®

**ç—‡çŠ¶**ï¼š
- æ¯æ¬¡é‡å¯åéœ€è¦é‡æ–°ç™»å½•
- Tokené¢‘ç¹å¤±æ•ˆ

**æ£€æŸ¥**ï¼š
```bash
docker exec tmc-local env | grep JWT_SECRET_KEY
```

**è§£å†³**ï¼š
åœ¨æœåŠ¡å™¨çš„`.env`æ–‡ä»¶ä¸­æ·»åŠ ï¼š
```bash
# ç”Ÿæˆå¯†é’¥
python3 -c "import secrets; print(secrets.token_urlsafe(32))"

# æ·»åŠ åˆ°.env
JWT_SECRET_KEY=ç”Ÿæˆçš„å¯†é’¥
```

ç„¶åé‡å¯ï¼š
```bash
docker-compose down
docker-compose up -d
```

### é—®é¢˜3ï¼šDockerç½‘ç»œéš”ç¦»

**ç—‡çŠ¶**ï¼š
- æœ¬åœ°èƒ½è®¿é—®ä»£ç†
- å®¹å™¨å†…æ— æ³•è®¿é—®ä»£ç†

**æ£€æŸ¥**ï¼š
```bash
# è¿›å…¥å®¹å™¨æµ‹è¯•ç½‘ç»œ
docker exec -it tmc-local sh

# æµ‹è¯•èƒ½å¦è®¿é—®ä»£ç†ï¼ˆå‡è®¾ä»£ç†åœ¨å®¿ä¸»æœºï¼‰
ping host.docker.internal
nc -zv host.docker.internal 7890
```

**è§£å†³æ–¹æ¡ˆA**ï¼šä½¿ç”¨hostç½‘ç»œæ¨¡å¼
```yaml
# docker-compose.yml
services:
  app:
    network_mode: "host"
```

**è§£å†³æ–¹æ¡ˆB**ï¼šæ·»åŠ extra_hosts
```yaml
services:
  app:
    extra_hosts:
      - "host.docker.internal:host-gateway"
```

### é—®é¢˜4ï¼šæµè§ˆå™¨ç¼“å­˜

**ç—‡çŠ¶**ï¼š
- ä»£ç å·²æ›´æ–°
- å®¹å™¨å·²é‡å¯
- ä½†é—®é¢˜ä¾ç„¶å­˜åœ¨

**è§£å†³**ï¼š
```bash
# Chrome/Edge
1. æŒ‰ Ctrl+Shift+Delete
2. é€‰æ‹©"ç¼“å­˜çš„å›¾ç‰‡å’Œæ–‡ä»¶"
3. æ—¶é—´èŒƒå›´é€‰"å…¨éƒ¨"
4. æ¸…é™¤æ•°æ®

# æˆ–è€…ä½¿ç”¨æ— ç—•æ¨¡å¼æµ‹è¯•
Ctrl+Shift+N (Chrome)
Ctrl+Shift+P (Firefox)
```

### é—®é¢˜5ï¼šHTTPSæ··åˆå†…å®¹

**ç—‡çŠ¶**ï¼š
- ä½¿ç”¨HTTPSè®¿é—®å‰ç«¯
- ä½†åç«¯æ˜¯HTTP
- æµè§ˆå™¨é˜»æ­¢è¯·æ±‚

**æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°**ï¼š
```
Mixed Content: The page at 'https://...' was loaded over HTTPS, 
but requested an insecure resource 'http://...'. This request has been blocked;
```

**è§£å†³**ï¼š
1. å‰ç«¯å’Œåç«¯éƒ½ä½¿ç”¨HTTPS
2. æˆ–è€…éƒ½ä½¿ç”¨HTTP

## ğŸ“ å®Œæ•´æ’æŸ¥æ¸…å•

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œè¿™äº›å‘½ä»¤ï¼Œç„¶åæŠŠç»“æœå‘ç»™æˆ‘

# 1. Gitç‰ˆæœ¬
git log --oneline -1

# 2. å®¹å™¨çŠ¶æ€
docker ps | grep tmc

# 3. æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
docker logs tmc-local --tail=50

# 4. æŸ¥çœ‹OPTIONSè¯·æ±‚
docker logs tmc-local 2>&1 | grep "OPTIONS.*test-proxy" | tail -10

# 5. æŸ¥çœ‹ç¯å¢ƒå˜é‡
docker exec tmc-local env | grep JWT_SECRET_KEY

# 6. æµ‹è¯•ç½‘ç»œ
docker exec tmc-local wget -O- http://localhost:9393/health --timeout=5

# 7. æŸ¥çœ‹ä¸­é—´ä»¶ä»£ç 
docker exec tmc-local grep -A 5 "OPTIONSè¯·æ±‚" /app/app/backend/middleware.py
```

æŠŠè¿™äº›ç»“æœå‘ç»™æˆ‘ï¼Œæˆ‘å¯ä»¥ç²¾ç¡®å®šä½é—®é¢˜ï¼

## ğŸ¯ å¿«é€Ÿä¿®å¤ï¼ˆæœ€å¯èƒ½çš„åŸå› ï¼‰

åŸºäºç»éªŒï¼Œæœ€å¯èƒ½çš„åŸå› æ˜¯ï¼š

### 1. ä»£ç æœªæ›´æ–°ï¼ˆ80%å¯èƒ½æ€§ï¼‰

```bash
cd /path/to/TMC
git fetch origin test
git reset --hard origin/test  # å¼ºåˆ¶åŒæ­¥åˆ°æœ€æ–°
docker-compose down
docker-compose up -d
```

### 2. JWT_SECRET_KEYæœªè®¾ç½®ï¼ˆ15%å¯èƒ½æ€§ï¼‰

```bash
# ç¼–è¾‘.envæ–‡ä»¶
nano .env

# æ·»åŠ 
JWT_SECRET_KEY=$(python3 -c "import secrets; print(secrets.token_urlsafe(32))")

# é‡å¯
docker-compose restart
```

### 3. æµè§ˆå™¨ç¼“å­˜ï¼ˆ5%å¯èƒ½æ€§ï¼‰

```bash
# æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶å¼ºåˆ¶åˆ·æ–°
Ctrl+Shift+Delete (æ¸…é™¤ç¼“å­˜)
Ctrl+Shift+R (å¼ºåˆ¶åˆ·æ–°)
```

---

**è¯·æ‰§è¡Œä¸Šé¢çš„"å®Œæ•´æ’æŸ¥æ¸…å•"ï¼ŒæŠŠç»“æœå‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šå¸®æ‚¨ç²¾ç¡®å®šä½ï¼** ğŸ”

