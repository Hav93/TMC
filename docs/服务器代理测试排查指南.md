# 🔍 服务器代理测试Failed to fetch排查指南

## 📊 问题现象

- **本地环境**：代理测试 ✅ 正常
- **服务器环境**：代理测试 ❌ Failed to fetch

## 🎯 排查步骤

### 步骤1：确认服务器容器状态

```bash
# 1. 检查容器是否正常运行
docker ps | grep tmc

# 2. 检查容器健康状态
docker inspect tmc-local | grep -A 10 Health

# 3. 查看容器资源使用
docker stats tmc-local --no-stream
```

### 步骤2：检查后端日志（关键！）

```bash
# 实时查看日志
docker logs tmc-local -f

# 查看最近100行
docker logs tmc-local --tail=100

# 查找OPTIONS请求
docker logs tmc-local 2>&1 | grep "OPTIONS"

# 查找test-proxy请求
docker logs tmc-local 2>&1 | grep "test-proxy"
```

**期望看到**：
```
INFO: xxx.xxx.xxx.xxx - "OPTIONS /api/settings/test-proxy HTTP/1.1" 200 OK
INFO: xxx.xxx.xxx.xxx - "POST /api/settings/test-proxy HTTP/1.1" 200 OK
```

**如果看到401**：
```
INFO: xxx.xxx.xxx.xxx - "OPTIONS /api/settings/test-proxy HTTP/1.1" 401 Unauthorized
```
说明OPTIONS请求被拦截了。

### 步骤3：检查代码版本

```bash
# 在服务器上检查当前commit
cd /path/to/TMC
git log --oneline -1

# 应该看到
# ab07dab fix(middleware): Allow OPTIONS requests to pass through auth
```

**如果不是最新的**：
```bash
git pull origin test
docker-compose restart
```

### 步骤4：检查环境变量

```bash
# 查看容器的环境变量
docker exec tmc-local env | grep -E "JWT|CORS|API"

# 检查JWT_SECRET_KEY是否设置
docker exec tmc-local env | grep JWT_SECRET_KEY
```

**重要**：如果JWT_SECRET_KEY每次启动都不一样，会导致token失效。

### 步骤5：浏览器开发者工具检查

**在浏览器按F12，查看Network标签**：

#### 情况A：OPTIONS请求失败（401）

```
Request:
  Method: OPTIONS
  URL: http://xxx:9393/api/settings/test-proxy
  Status: 401 Unauthorized

Response Headers:
  Access-Control-Allow-Origin: (没有)
```

**原因**：认证中间件拦截OPTIONS

**解决**：确保代码已更新到`ab07dab`

#### 情况B：OPTIONS成功，POST失败（401）

```
OPTIONS: 200 OK
POST: 401 Unauthorized
```

**原因**：JWT Token无效

**解决**：
1. 清除浏览器缓存
2. 重新登录
3. 检查JWT_SECRET_KEY是否固定

#### 情况C：POST成功，但响应是CORS错误

```
POST: 200 OK
Console Error: 
  Access to fetch at 'http://xxx:9393/api/settings/test-proxy' 
  from origin 'http://xxx:9393' has been blocked by CORS policy
```

**原因**：CORS配置问题

**解决**：确保`allow_origins=["*"]`

#### 情况D：网络错误，请求没发出去

```
Console Error:
  Failed to fetch
  TypeError: NetworkError when attempting to fetch resource
```

**可能原因**：
1. 服务器防火墙阻止
2. 反向代理配置错误（如果有）
3. Docker网络问题

### 步骤6：手动测试API

```bash
# 先获取token（在服务器上）
TOKEN="your-jwt-token"

# 测试OPTIONS请求
curl -X OPTIONS http://localhost:9393/api/settings/test-proxy -v

# 应该返回200，不需要token

# 测试POST请求
curl -X POST http://localhost:9393/api/settings/test-proxy \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "enable_proxy": true,
    "proxy_type": "http",
    "proxy_host": "host.docker.internal",
    "proxy_port": 7890
  }' \
  -v
```

### 步骤7：检查反向代理（如果有）

如果服务器使用了Nginx/Caddy等反向代理：

**Nginx配置检查**：
```nginx
location /api/ {
    proxy_pass http://localhost:9393;
    
    # 这些必须有！
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # CORS相关（如果后端已处理CORS，这里不要重复处理）
    # add_header Access-Control-Allow-Origin *;
    # add_header Access-Control-Allow-Methods *;
    # add_header Access-Control-Allow-Headers *;
}
```

### 步骤8：检查防火墙

```bash
# 检查防火墙状态
sudo ufw status

# 确保9393端口开放
sudo ufw allow 9393

# 或者检查iptables
sudo iptables -L -n | grep 9393
```

## 🔧 常见问题汇总

### 问题1：服务器容器未更新

**症状**：
```bash
docker logs tmc-local 2>&1 | grep OPTIONS
# 显示：401 Unauthorized
```

**解决**：
```bash
git pull origin test
docker-compose build --no-cache
docker-compose up -d
```

### 问题2：JWT_SECRET_KEY未设置

**症状**：
- 每次重启后需要重新登录
- Token频繁失效

**检查**：
```bash
docker exec tmc-local env | grep JWT_SECRET_KEY
```

**解决**：
在服务器的`.env`文件中添加：
```bash
# 生成密钥
python3 -c "import secrets; print(secrets.token_urlsafe(32))"

# 添加到.env
JWT_SECRET_KEY=生成的密钥
```

然后重启：
```bash
docker-compose down
docker-compose up -d
```

### 问题3：Docker网络隔离

**症状**：
- 本地能访问代理
- 容器内无法访问代理

**检查**：
```bash
# 进入容器测试网络
docker exec -it tmc-local sh

# 测试能否访问代理（假设代理在宿主机）
ping host.docker.internal
nc -zv host.docker.internal 7890
```

**解决方案A**：使用host网络模式
```yaml
# docker-compose.yml
services:
  app:
    network_mode: "host"
```

**解决方案B**：添加extra_hosts
```yaml
services:
  app:
    extra_hosts:
      - "host.docker.internal:host-gateway"
```

### 问题4：浏览器缓存

**症状**：
- 代码已更新
- 容器已重启
- 但问题依然存在

**解决**：
```bash
# Chrome/Edge
1. 按 Ctrl+Shift+Delete
2. 选择"缓存的图片和文件"
3. 时间范围选"全部"
4. 清除数据

# 或者使用无痕模式测试
Ctrl+Shift+N (Chrome)
Ctrl+Shift+P (Firefox)
```

### 问题5：HTTPS混合内容

**症状**：
- 使用HTTPS访问前端
- 但后端是HTTP
- 浏览器阻止请求

**检查浏览器控制台**：
```
Mixed Content: The page at 'https://...' was loaded over HTTPS, 
but requested an insecure resource 'http://...'. This request has been blocked;
```

**解决**：
1. 前端和后端都使用HTTPS
2. 或者都使用HTTP

## 📝 完整排查清单

```bash
# 在服务器上执行这些命令，然后把结果发给我

# 1. Git版本
git log --oneline -1

# 2. 容器状态
docker ps | grep tmc

# 3. 查看最近的日志
docker logs tmc-local --tail=50

# 4. 查看OPTIONS请求
docker logs tmc-local 2>&1 | grep "OPTIONS.*test-proxy" | tail -10

# 5. 查看环境变量
docker exec tmc-local env | grep JWT_SECRET_KEY

# 6. 测试网络
docker exec tmc-local wget -O- http://localhost:9393/health --timeout=5

# 7. 查看中间件代码
docker exec tmc-local grep -A 5 "OPTIONS请求" /app/app/backend/middleware.py
```

把这些结果发给我，我可以精确定位问题！

## 🎯 快速修复（最可能的原因）

基于经验，最可能的原因是：

### 1. 代码未更新（80%可能性）

```bash
cd /path/to/TMC
git fetch origin test
git reset --hard origin/test  # 强制同步到最新
docker-compose down
docker-compose up -d
```

### 2. JWT_SECRET_KEY未设置（15%可能性）

```bash
# 编辑.env文件
nano .env

# 添加
JWT_SECRET_KEY=$(python3 -c "import secrets; print(secrets.token_urlsafe(32))")

# 重启
docker-compose restart
```

### 3. 浏览器缓存（5%可能性）

```bash
# 清除浏览器缓存并强制刷新
Ctrl+Shift+Delete (清除缓存)
Ctrl+Shift+R (强制刷新)
```

---

**请执行上面的"完整排查清单"，把结果告诉我，我会帮您精确定位！** 🔍

