# 115ç½‘ç›˜é›†æˆå®Œæ•´å®ç°æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [å‰ç½®å‡†å¤‡](#å‰ç½®å‡†å¤‡)
3. [é›†æˆæ¶æ„](#é›†æˆæ¶æ„)
4. [è¯¦ç»†å®ç°æ­¥éª¤](#è¯¦ç»†å®ç°æ­¥éª¤)
5. [æ ¸å¿ƒåŠŸèƒ½å®ç°](#æ ¸å¿ƒåŠŸèƒ½å®ç°)
6. [å®‰å…¨ä¸æœ€ä½³å®è·µ](#å®‰å…¨ä¸æœ€ä½³å®è·µ)
7. [å¸¸è§é—®é¢˜ä¸æ•…éšœæ’æŸ¥](#å¸¸è§é—®é¢˜ä¸æ•…éšœæ’æŸ¥)
8. [APIæ¥å£è¯´æ˜](#apiæ¥å£è¯´æ˜)

---

## æ¦‚è¿°

### 115äº‘å¼€æ”¾å¹³å°ç®€ä»‹

115äº‘å¼€æ”¾å¹³å°ï¼ˆhttps://www.yuque.com/115yun/openï¼‰æä¾›äº†å®Œæ•´çš„äº‘å­˜å‚¨æœåŠ¡APIï¼Œæ”¯æŒæ–‡ä»¶ç®¡ç†ã€ä¸Šä¼ ä¸‹è½½ã€åˆ†äº«ç­‰åŠŸèƒ½ã€‚æœ¬æŒ‡å—å°†è¯¦ç»†è¯´æ˜å¦‚ä½•åœ¨é¡¹ç›®ä¸­é›†æˆ115äº‘æœåŠ¡ã€‚

### é›†æˆæ–¹å¼

æœ¬é¡¹ç›®æ”¯æŒ**ä¸¤ç§é›†æˆæ–¹å¼**ï¼š

1. **å¸¸è§„Cookieç™»å½•** âœ… **æ¨èç”¨äºå¿«é€Ÿå¼€å§‹**
   - é€šè¿‡æ‰«ç ç™»å½•è·å–Cookieå‡­è¯
   - ç®€å•å¿«é€Ÿï¼Œæ— éœ€ç”³è¯·å¼€æ”¾å¹³å°è´¦å·
   - é€‚ç”¨äºåŸºç¡€æ–‡ä»¶æ“ä½œ
   - Cookieæœ‰æ•ˆæœŸçº¦30å¤©

2. **å¼€æ”¾å¹³å°OAuthè®¤è¯** ğŸ” **æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ**
   - éœ€è¦ç”³è¯·å¼€æ”¾å¹³å°AppID
   - æ›´ç¨³å®šçš„APIè®¿é—®æƒé™
   - Access Tokenæœ‰æ•ˆæœŸ2å°æ—¶ï¼ˆå¯åˆ·æ–°ï¼‰
   - æ”¯æŒæ›´å¤šé«˜çº§åŠŸèƒ½

---

## å‰ç½®å‡†å¤‡

### 1. è·å–115è´¦å·

- æ³¨å†Œ115è´¦å·ï¼šhttps://115.com/
- ä¸‹è½½115 APPï¼ˆiOS/Androidï¼‰æˆ–115ç”Ÿæ´»APP
- å»ºè®®å¼€é€šVIPä¼šå‘˜ï¼ˆéå¿…é¡»ï¼Œä½†ä¼šæœ‰æ›´å¥½çš„ä½“éªŒï¼‰

### 2. ç”³è¯·å¼€æ”¾å¹³å°AppIDï¼ˆå¯é€‰ï¼Œç”¨äºOAuthæ–¹å¼ï¼‰

#### æ­¥éª¤ï¼š

1. **è®¿é—®115å¼€æ”¾å¹³å°æ–‡æ¡£**
   - ç½‘å€ï¼šhttps://www.yuque.com/115yun/open
   
2. **äº†è§£å¼€æ”¾å¹³å°æ¥å…¥æµç¨‹**
   - é˜…è¯»å®˜æ–¹æ–‡æ¡£ä¸­çš„"æ¥å…¥æŒ‡å—"
   - äº†è§£APIæƒé™å’Œé™æµè§„åˆ™
   
3. **ç”³è¯·AppID**
   - ç›®å‰115å¼€æ”¾å¹³å°é‡‡ç”¨ç™½åå•åˆ¶
   - éœ€è¦è”ç³»115å®˜æ–¹ç”³è¯·å¼€æ”¾å¹³å°æƒé™
   - æä¾›åº”ç”¨è¯´æ˜å’Œä½¿ç”¨åœºæ™¯
   
4. **è·å–AppID**
   - å®¡æ ¸é€šè¿‡åä¼šè·å¾—AppIDï¼ˆçº¯æ•°å­—ï¼‰
   - **ä¸éœ€è¦AppSecret**ï¼ˆæœ¬é¡¹ç›®ä½¿ç”¨OAuth 2.0 Device Flow with PKCEï¼‰

### 3. ç¯å¢ƒå‡†å¤‡

#### ç³»ç»Ÿè¦æ±‚ï¼š
- Python 3.8+
- httpxï¼ˆHTTPå®¢æˆ·ç«¯åº“ï¼‰
- ç¨³å®šçš„ç½‘ç»œè¿æ¥ï¼ˆ115æ˜¯å›½å†…æœåŠ¡ï¼Œé€šå¸¸ä¸éœ€è¦ä»£ç†ï¼‰

#### å®‰è£…ä¾èµ–ï¼š
```bash
cd app/backend
pip install httpx
```

---

## é›†æˆæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·ç•Œé¢ (Frontend)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  æ‰«ç ç™»å½•    â”‚  â”‚  OAuthæˆæƒ   â”‚  â”‚  æ–‡ä»¶ç®¡ç†    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚                  â”‚
          â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      APIè·¯ç”±å±‚ (FastAPI)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  /api/pan115/regular-qrcode     - è·å–ç™»å½•äºŒç»´ç           â”‚  â”‚
â”‚  â”‚  /api/pan115/regular-qrcode/status - æ£€æŸ¥æ‰«ç çŠ¶æ€        â”‚  â”‚
â”‚  â”‚  /api/pan115/activate-open-api  - æ¿€æ´»å¼€æ”¾å¹³å°API        â”‚  â”‚
â”‚  â”‚  /api/pan115/poll-device-token  - è½®è¯¢OAuth Token        â”‚  â”‚
â”‚  â”‚  /api/pan115/config             - é…ç½®ç®¡ç†                â”‚  â”‚
â”‚  â”‚  /api/pan115/upload             - æ–‡ä»¶ä¸Šä¼                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸šåŠ¡é€»è¾‘å±‚ (Pan115Client)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è®¤è¯æ¨¡å—                                                  â”‚  â”‚
â”‚  â”‚  - get_regular_qrcode()      è·å–ç™»å½•äºŒç»´ç                â”‚  â”‚
â”‚  â”‚  - check_regular_qrcode_status() æ£€æŸ¥æ‰«ç çŠ¶æ€            â”‚  â”‚
â”‚  â”‚  - get_device_code()         OAuth Device Flow           â”‚  â”‚
â”‚  â”‚  - poll_device_token()       è½®è¯¢è·å–Token               â”‚  â”‚
â”‚  â”‚  - get_access_token()        ä½¿ç”¨Cookie+AppIDè·å–Token   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  æ–‡ä»¶æ“ä½œæ¨¡å—                                              â”‚  â”‚
â”‚  â”‚  - upload_file()             ä¸Šä¼ æ–‡ä»¶                     â”‚  â”‚
â”‚  â”‚  - list_files()              åˆ—å‡ºæ–‡ä»¶                     â”‚  â”‚
â”‚  â”‚  - delete_files()            åˆ é™¤æ–‡ä»¶                     â”‚  â”‚
â”‚  â”‚  - move_files()              ç§»åŠ¨æ–‡ä»¶                     â”‚  â”‚
â”‚  â”‚  - create_directory()        åˆ›å»ºç›®å½•                     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  ç”¨æˆ·ä¿¡æ¯æ¨¡å—                                              â”‚  â”‚
â”‚  â”‚  - get_user_info()           è·å–ç”¨æˆ·ä¿¡æ¯                 â”‚  â”‚
â”‚  â”‚  - _get_space_info_only()    è·å–ç©ºé—´ä¿¡æ¯                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      115äº‘æœåŠ¡å™¨ API                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å¸¸è§„ç™»å½•API                                               â”‚  â”‚
â”‚  â”‚  - qrcodeapi.115.com         äºŒç»´ç æœåŠ¡                   â”‚  â”‚
â”‚  â”‚  - passportapi.115.com       ç™»å½•è®¤è¯                     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  å¼€æ”¾å¹³å°API                                               â”‚  â”‚
â”‚  â”‚  - passportapi.115.com/open  OAuthè®¤è¯                    â”‚  â”‚
â”‚  â”‚  - passportapi.115.com/app   Tokenç®¡ç†                    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Web API                                                   â”‚  â”‚
â”‚  â”‚  - webapi.115.com            æ–‡ä»¶æ“ä½œ                     â”‚  â”‚
â”‚  â”‚  - proapi.115.com            å¼€æ”¾å¹³å°æ–‡ä»¶API              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                          â”‚
          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®åº“å­˜å‚¨      â”‚        â”‚  æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨    â”‚
â”‚  - Cookie        â”‚        â”‚  - Cookiesæ–‡ä»¶   â”‚
â”‚  - Access Token  â”‚        â”‚  - ç”¨æˆ·ä¿¡æ¯ç¼“å­˜  â”‚
â”‚  - ç”¨æˆ·ä¿¡æ¯      â”‚        â”‚  - ä¸Šä¼ ä¸´æ—¶æ–‡ä»¶  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

- **åç«¯**ï¼šPython + FastAPI + SQLAlchemy + httpx
- **å‰ç«¯**ï¼šReact + TypeScript + Ant Design + React Query
- **è®¤è¯**ï¼šOAuth 2.0 Device Flow with PKCE
- **å­˜å‚¨**ï¼šSQLite/PostgreSQL (æ•°æ®åº“) + æ–‡ä»¶ç³»ç»Ÿ (CookieæŒä¹…åŒ–)

---

## è¯¦ç»†å®ç°æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šåç«¯æ ¸å¿ƒå®¢æˆ·ç«¯å®ç°

#### 1.1 åˆ›å»ºPan115Clientç±»

æ–‡ä»¶ï¼š`app/backend/services/pan115_client.py`

```python
"""
115ç½‘ç›˜ Open API å®¢æˆ·ç«¯
åŸºäºå®˜æ–¹æ–‡æ¡£: https://www.yuque.com/115yun/open/fd7fidbgsritauxm
"""
import httpx
import hashlib
import time
import os
import base64
import secrets
import asyncio
from typing import Optional, Dict, Any, List
from pathlib import Path
from log_manager import get_logger

logger = get_logger('pan115')

class Pan115Client:
    """115ç½‘ç›˜ Open API å®¢æˆ·ç«¯ï¼ˆåŒæ—¶æ”¯æŒå¸¸è§„ç™»å½•ï¼‰"""
    
    def __init__(self, app_id: str, app_key: str, user_id: str, user_key: str, use_proxy: bool = False):
        """
        åˆå§‹åŒ–115ç½‘ç›˜å®¢æˆ·ç«¯
        
        Args:
            app_id: åº”ç”¨ID (å¼€æ”¾å¹³å°AppID)
            app_key: åº”ç”¨å¯†é’¥ (æœ¬é¡¹ç›®ä¸­ä¸ä½¿ç”¨ï¼Œä½¿ç”¨OAuth PKCE)
            user_id: ç”¨æˆ·ID
            user_key: ç”¨æˆ·å¯†é’¥ï¼ˆå¯ä»¥æ˜¯cookieså­—ç¬¦ä¸²æˆ–access_tokenï¼‰
            use_proxy: æ˜¯å¦ä½¿ç”¨ç³»ç»Ÿä»£ç†(é»˜è®¤False,å› ä¸º115æ˜¯å›½å†…æœåŠ¡)
        """
        self.app_id = app_id
        self.app_key = app_key
        self.user_id = user_id
        self.user_key = user_key
        self.use_proxy = use_proxy
        self.base_url = "https://proapi.115.com"  # å¼€æ”¾å¹³å°API
        self.open_api_url = "https://passportapi.115.com"  # OAuth API
        self.auth_url = "https://passportapi.115.com"  # è®¤è¯API
        self.webapi_url = "https://webapi.115.com"  # å¸¸è§„ Web API
        self.access_token = None  # Bearer Token
    
    def _get_client_kwargs(self, timeout: float = 10.0, **extra_kwargs) -> Dict[str, Any]:
        """è·å–httpx.AsyncClientçš„å‚æ•°é…ç½®"""
        kwargs = {'timeout': timeout}
        kwargs.update(extra_kwargs)
        
        if self.use_proxy:
            kwargs['trust_env'] = True  # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ä»£ç†
        else:
            kwargs['trust_env'] = False
            kwargs['proxies'] = None  # æ˜ç¡®ç¦ç”¨æ‰€æœ‰ä»£ç†
        
        return kwargs
```

#### 1.2 å®ç°å¸¸è§„ç™»å½•åŠŸèƒ½

```python
    async def get_regular_qrcode(self, app: str = "web") -> Dict[str, Any]:
        """
        è·å–115ç™»å½•äºŒç»´ç 
        
        Args:
            app: åº”ç”¨ç±»å‹
                - "web": ç½‘é¡µç‰ˆ
                - "android": Androidå®¢æˆ·ç«¯
                - "ios": iOSå®¢æˆ·ç«¯
                - "qandroid": 115ç”Ÿæ´»Androidç‰ˆï¼ˆæ¨èï¼‰
                
        Returns:
            {
                "success": bool,
                "qrcode_url": str,  # äºŒç»´ç å›¾ç‰‡URL
                "qrcode_token": {   # äºŒç»´ç tokenæ•°æ®
                    "uid": str,
                    "time": int,
                    "sign": str
                },
                "expires_in": int,
                "message": str
            }
        """
        try:
            # å¦‚æœé…ç½®äº†AppIDï¼Œä½¿ç”¨å¼€æ”¾å¹³å°äºŒç»´ç 
            if self.app_id:
                return await self.get_device_code()
            
            # å¸¸è§„ç™»å½•äºŒç»´ç API
            url = f"https://qrcodeapi.115.com/api/1.0/{app}/1.0/token"
            
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                'Accept': 'application/json',
            }
            
            async with httpx.AsyncClient(**self._get_client_kwargs()) as client:
                response = await client.get(url, headers=headers)
            
            if response.status_code == 200:
                result = response.json()
                
                if result.get('state') or result.get('code') == 0:
                    data = result.get('data', {})
                    
                    qrcode_token = {
                        'uid': data.get('uid', ''),
                        'time': data.get('time', 0),
                        'sign': data.get('sign', ''),
                    }
                    
                    return {
                        'success': True,
                        'qrcode_url': data.get('qrcode', ''),
                        'qrcode_token': qrcode_token,
                        'expires_in': 300,
                        'app': app,
                        'message': 'è·å–äºŒç»´ç æˆåŠŸ'
                    }
            
            return {'success': False, 'message': f"HTTP {response.status_code}"}
        except Exception as e:
            logger.error(f"è·å–äºŒç»´ç å¼‚å¸¸: {e}")
            return {'success': False, 'message': str(e)}

    async def check_regular_qrcode_status(self, qrcode_token: Dict[str, Any], app: str = "web") -> Dict[str, Any]:
        """
        æ£€æŸ¥å¸¸è§„115ç™»å½•äºŒç»´ç çŠ¶æ€
        
        Args:
            qrcode_token: äºŒç»´ç tokenæ•°æ®
            app: åº”ç”¨ç±»å‹ï¼ˆä¸è·å–äºŒç»´ç æ—¶ä¿æŒä¸€è‡´ï¼‰
            
        Returns:
            {
                "success": bool,
                "status": str,  # "waiting" | "scanned" | "confirmed" | "expired"
                "cookies": str,  # ç™»å½•æˆåŠŸåçš„cookiesï¼ˆstatus=confirmedæ—¶è¿”å›ï¼‰
                "user_id": str,
                "user_info": dict,  # å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
                "message": str
            }
        """
        try:
            uid = qrcode_token.get('uid')
            time_val = qrcode_token.get('time')
            sign = qrcode_token.get('sign')
            
            # æ£€æŸ¥æ‰«ç çŠ¶æ€
            status_url = "https://qrcodeapi.115.com/get/status/"
            params = {'uid': uid, 'time': time_val, 'sign': sign}
            
            async with httpx.AsyncClient(**self._get_client_kwargs(timeout=30.0)) as client:
                response = await client.get(status_url, params=params)
            
            if response.status_code == 200:
                result = response.json()
                data = result.get('data', {})
                status_code = data.get('status', 0)
                
                # status: 0=ç­‰å¾…æ‰«ç , 1=å·²æ‰«ç å¾…ç¡®è®¤, 2=å·²ç¡®è®¤
                if status_code == 2:
                    # è·å–ç™»å½•å‡­è¯
                    login_url = f"https://passportapi.115.com/app/1.0/{app}/1.0/login/qrcode"
                    login_params = {'account': uid, 'app': app}
                    
                    async with httpx.AsyncClient(**self._get_client_kwargs()) as login_client:
                        login_response = await login_client.post(login_url, data=login_params)
                    
                    if login_response.status_code == 200:
                        login_result = login_response.json()
                        
                        if login_result.get('state'):
                            login_data = login_result.get('data', {})
                            cookie_dict = login_data.get('cookie', {})
                            user_id = str(login_data.get('user_id', ''))
                            
                            # æ„å»ºcookieså­—ç¬¦ä¸²
                            cookies_parts = []
                            for key in ['UID', 'CID', 'SEID', 'KID']:
                                if key in cookie_dict:
                                    cookies_parts.append(f"{key}={cookie_dict[key]}")
                            
                            cookies_str = '; '.join(cookies_parts)
                            
                            # æ„å»ºç”¨æˆ·ä¿¡æ¯
                            user_info = {
                                'user_id': user_id,
                                'user_name': login_data.get('user_name', ''),
                                'email': login_data.get('email', ''),
                                'is_vip': bool(login_data.get('is_vip', 0)),
                                'vip_level': login_data.get('is_vip', 0),
                                'vip_name': self._get_vip_name(login_data.get('is_vip', 0))
                            }
                            
                            return {
                                'success': True,
                                'status': 'confirmed',
                                'cookies': cookies_str,
                                'user_id': user_id,
                                'user_info': user_info,
                                'message': 'ç™»å½•æˆåŠŸ'
                            }
                
                elif status_code == 1:
                    return {'success': True, 'status': 'scanned', 'message': 'å·²æ‰«ç ï¼Œç­‰å¾…ç¡®è®¤'}
                else:
                    return {'success': True, 'status': 'waiting', 'message': 'ç­‰å¾…æ‰«ç '}
            
            return {'success': False, 'status': 'error', 'message': f"HTTP {response.status_code}"}
        except Exception as e:
            logger.error(f"æ£€æŸ¥äºŒç»´ç çŠ¶æ€å¼‚å¸¸: {e}")
            return {'success': False, 'status': 'error', 'message': str(e)}
```

#### 1.3 å®ç°OAuth 2.0 Device Flow with PKCE

```python
    def _generate_pkce_pair(self) -> tuple[str, str]:
        """
        ç”ŸæˆPKCEæ‰€éœ€çš„code_verifierå’Œcode_challenge
        
        PKCE (Proof Key for Code Exchange) ç”¨äºé˜²æ­¢æˆæƒç æ‹¦æˆªæ”»å‡»
        
        Returns:
            (code_verifier, code_challenge)
        """
        # ç”Ÿæˆcode_verifier: 43-128ä¸ªå­—ç¬¦çš„éšæœºå­—ç¬¦ä¸²
        code_verifier = base64.urlsafe_b64encode(secrets.token_bytes(32)).decode('utf-8').rstrip('=')
        
        # ç”Ÿæˆcode_challenge: code_verifierçš„SHA256å“ˆå¸Œçš„base64ç¼–ç 
        challenge_bytes = hashlib.sha256(code_verifier.encode('utf-8')).digest()
        code_challenge = base64.urlsafe_b64encode(challenge_bytes).decode('utf-8').rstrip('=')
        
        return code_verifier, code_challenge

    async def get_device_code(self) -> Dict[str, Any]:
        """
        è·å–è®¾å¤‡æˆæƒç (OAuth Device Code Flowç¬¬ä¸€æ­¥)
        
        é€‚ç”¨äºå·²æœ‰AppIDçš„æƒ…å†µï¼Œæ‰«ç åä¼šè‡ªåŠ¨ç»‘å®šAppIDæƒé™
        
        Returns:
            {
                'success': bool,
                'device_code': str,        # è®¾å¤‡ç ï¼ˆç”¨äºåç»­è½®è¯¢ï¼‰
                'user_code': str,          # ç”¨æˆ·æˆæƒç ï¼ˆç»™ç”¨æˆ·çœ‹çš„ï¼‰
                'verification_uri': str,   # äºŒç»´ç URL
                'expires_in': int,         # æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰
                'interval': int,           # è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰
                'code_verifier': str,      # PKCEéªŒè¯ç ï¼ˆç”¨äºåç»­è·å–tokenï¼‰
                'message': str
            }
        """
        try:
            if not self.app_id:
                return {'success': False, 'message': 'æœªé…ç½®AppID'}
            
            # ç”ŸæˆPKCEå‚æ•°
            code_verifier, code_challenge = self._generate_pkce_pair()
            
            params = {
                'client_id': self.app_id,
                'code_challenge': code_challenge,
                'code_challenge_method': 'sha256',
                'scope': 'basic'
            }
            
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                'Accept': 'application/json',
                'Content-Type': 'application/x-www-form-urlencoded',
            }
            
            async with httpx.AsyncClient(**self._get_client_kwargs()) as client:
                response = await client.post(
                    f"{self.open_api_url}/open/authDeviceCode",
                    data=params,
                    headers=headers
                )
            
            if response.status_code == 200:
                result = response.json()
                
                if result.get('state') == 1 or result.get('code') == 0:
                    data = result.get('data', result)
                    uid = data.get('uid')
                    qrcode_url = data.get('qrcode')
                    
                    if uid and qrcode_url:
                        return {
                            'success': True,
                            'device_code': uid,
                            'user_code': '',
                            'verification_uri': qrcode_url,
                            'qrcode_token': data,
                            'expires_in': 300,
                            'interval': 2,
                            'code_verifier': code_verifier,
                            'message': 'è¯·ä½¿ç”¨115 APPæ‰«æäºŒç»´ç å®Œæˆå¼€æ”¾å¹³å°æˆæƒ'
                        }
            
            return {'success': False, 'message': 'è·å–æˆæƒä¿¡æ¯å¤±è´¥'}
        except Exception as e:
            logger.error(f"è·å–è®¾å¤‡æˆæƒç å¼‚å¸¸: {e}")
            return {'success': False, 'message': str(e)}
```

### ç¬¬äºŒæ­¥ï¼šæ•°æ®åº“æ¨¡å‹è®¾è®¡

æ–‡ä»¶ï¼š`app/backend/models.py`

```python
from sqlalchemy import Column, String, DateTime, Boolean
from datetime import datetime

class MediaSettings(Base):
    """åª’ä½“è®¾ç½®æ¨¡å‹"""
    __tablename__ = 'media_settings'
    
    id = Column(Integer, primary_key=True)
    
    # 115ç½‘ç›˜åŸºç¡€é…ç½®
    pan115_app_id = Column(String, comment='115å¼€æ”¾å¹³å°AppID')
    pan115_user_id = Column(String, comment='115ç”¨æˆ·ID')
    pan115_user_key = Column(String, comment='115ç”¨æˆ·å‡­è¯(cookies)')
    pan115_device_type = Column(String, default='qandroid', comment='ç™»å½•è®¾å¤‡ç±»å‹')
    pan115_request_interval = Column(Float, default=1.0, comment='APIè¯·æ±‚é—´éš”(ç§’)')
    pan115_use_proxy = Column(Boolean, default=False, comment='æ˜¯å¦ä½¿ç”¨ä»£ç†')
    
    # OAuth Tokenç®¡ç†
    pan115_access_token = Column(String, comment='115å¼€æ”¾å¹³å°è®¿é—®ä»¤ç‰Œ')
    pan115_refresh_token = Column(String, comment='115å¼€æ”¾å¹³å°åˆ·æ–°ä»¤ç‰Œ')
    pan115_token_expires_at = Column(DateTime, comment='ä»¤ç‰Œè¿‡æœŸæ—¶é—´')
    
    # ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
    pan115_user_info = Column(Text, comment='115ç”¨æˆ·ä¿¡æ¯(JSONæ ¼å¼)')
    pan115_last_refresh_at = Column(DateTime, comment='ä¸Šæ¬¡åˆ·æ–°æ—¶é—´')
```

### ç¬¬ä¸‰æ­¥ï¼šAPIè·¯ç”±å®ç°

æ–‡ä»¶ï¼š`app/backend/api/routes/pan115.py`

```python
from fastapi import APIRouter, Depends, HTTPException, Body
from sqlalchemy.ext.asyncio import AsyncSession
from pydantic import BaseModel
from typing import Dict, Any, Optional
from datetime import datetime, timedelta

router = APIRouter(tags=["115ç½‘ç›˜"])

class RegularQRCodeRequest(BaseModel):
    """å¸¸è§„115ç™»å½•äºŒç»´ç è¯·æ±‚"""
    app: str = "qandroid"  # æ¨èä½¿ç”¨qandroid

@router.post("/regular-qrcode")
async def get_regular_qrcode(
    request: RegularQRCodeRequest,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """
    è·å–å¸¸è§„115ç™»å½•äºŒç»´ç 
    
    è®¾å¤‡ç±»å‹è¯´æ˜ï¼š
    - qandroid: 115ç”Ÿæ´»Androidç‰ˆï¼ˆæ¨èï¼Œæœ€ç¨³å®šï¼‰
    - android: 115ç½‘ç›˜Androidç‰ˆ
    - ios: 115ç½‘ç›˜iOSç‰ˆ
    - web: ç½‘é¡µç‰ˆ
    """
    try:
        # è¯»å–é…ç½®
        result = await db.execute(select(MediaSettings))
        settings = result.scalars().first()
        
        app_id = getattr(settings, 'pan115_app_id', '') if settings else ''
        use_proxy = getattr(settings, 'pan115_use_proxy', False) if settings else False
        
        # åˆ›å»ºå®¢æˆ·ç«¯
        client = Pan115Client(
            app_id=app_id,
            app_key="",
            user_id="",
            user_key="",
            use_proxy=use_proxy
        )
        
        # è·å–äºŒç»´ç 
        result = await client.get_regular_qrcode(app=request.app)
        
        if result.get('success'):
            return result
        else:
            raise HTTPException(status_code=400, detail=result.get('message', 'è·å–äºŒç»´ç å¤±è´¥'))
    except Exception as e:
        logger.error(f"è·å–äºŒç»´ç å¤±è´¥: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/regular-qrcode/status")
async def check_regular_qrcode_status(
    request: Dict[str, Any] = Body(...),
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """
    æ£€æŸ¥å¸¸è§„115ç™»å½•äºŒç»´ç çŠ¶æ€
    
    è¯·æ±‚å‚æ•°ï¼š
    - qrcode_token: äºŒç»´ç tokenæ•°æ®
    - app: è®¾å¤‡ç±»å‹
    """
    try:
        qrcode_token = request.get('qrcode_token')
        app = request.get('app', 'qandroid')
        
        if not qrcode_token:
            raise HTTPException(status_code=400, detail="ç¼ºå°‘qrcode_tokenå‚æ•°")
        
        # è¯»å–é…ç½®
        result = await db.execute(select(MediaSettings))
        settings = result.scalars().first()
        use_proxy = getattr(settings, 'pan115_use_proxy', False) if settings else False
        
        # åˆ›å»ºå®¢æˆ·ç«¯
        client = Pan115Client(
            app_id="",
            app_key="",
            user_id="",
            user_key="",
            use_proxy=use_proxy
        )
        
        # æ£€æŸ¥çŠ¶æ€
        result = await client.check_regular_qrcode_status(qrcode_token, app)
        
        if not result.get('success'):
            raise HTTPException(status_code=400, detail=result.get('message'))
        
        # å¦‚æœç™»å½•æˆåŠŸï¼Œä¿å­˜cookieså’Œç”¨æˆ·ä¿¡æ¯
        if result.get('status') == 'confirmed':
            cookies = result.get('cookies')
            user_id = result.get('user_id')
            user_info = result.get('user_info', {})
            
            if cookies and user_id:
                # ä¿å­˜åˆ°æ•°æ®åº“
                if not settings:
                    settings = MediaSettings()
                    db.add(settings)
                
                setattr(settings, 'pan115_user_id', user_id)
                setattr(settings, 'pan115_user_key', cookies)
                setattr(settings, 'pan115_device_type', app)
                
                # ä¿å­˜ç”¨æˆ·ä¿¡æ¯
                import json
                setattr(settings, 'pan115_user_info', json.dumps(user_info, ensure_ascii=False))
                setattr(settings, 'pan115_last_refresh_at', datetime.utcnow())
                
                # ä¿å­˜cookiesåˆ°æ–‡ä»¶ï¼ˆæŒä¹…åŒ–ï¼‰
                import os
                cookies_file = os.path.join('/app', 'config', '115-cookies.txt')
                os.makedirs(os.path.dirname(cookies_file), exist_ok=True)
                with open(cookies_file, 'w', encoding='utf-8') as f:
                    f.write(cookies)
                
                await db.commit()
                
                logger.info(f"115ç™»å½•æˆåŠŸ: user_id={user_id}, user_name={user_info.get('user_name')}")
        
        return result
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"æ£€æŸ¥äºŒç»´ç çŠ¶æ€å¤±è´¥: {e}")
        raise HTTPException(status_code=500, detail=str(e))
```

### ç¬¬å››æ­¥ï¼šå‰ç«¯UIå®ç°

æ–‡ä»¶ï¼š`app/frontend/src/pages/Settings/Pan115Settings.tsx`

å…³é”®ä»£ç ç‰‡æ®µï¼š

```typescript
const Pan115Settings: React.FC = () => {
  const [form] = Form.useForm();
  const [qrcodeModalVisible, setQrcodeModalVisible] = useState(false);
  const [qrcodeUrl, setQrcodeUrl] = useState('');
  const [deviceType, setDeviceType] = useState('qandroid');
  
  // è·å–é…ç½®
  const { data: config } = useQuery({
    queryKey: ['pan115Config'],
    queryFn: pan115Api.getConfig,
  });
  
  // è·å–äºŒç»´ç 
  const getRegularQRCodeMutation = useMutation({
    mutationFn: (deviceType: string) => pan115Api.getRegularQRCode(deviceType),
    onSuccess: (data: any) => {
      setQrcodeUrl(data.qrcode_url);
      setQrcodeModalVisible(true);
      startPolling(data.qrcode_token, deviceType);
      message.success('è¯·ä½¿ç”¨115 APPæ‰«ç ç™»å½•');
    },
  });
  
  // è½®è¯¢æ£€æŸ¥çŠ¶æ€
  const startPolling = (tokenData: any, loginDeviceType: string) => {
    const poll = async () => {
      const result = await pan115Api.checkRegularQRCodeStatus(tokenData, loginDeviceType);
      
      if (result.status === 'confirmed') {
        message.success('ç™»å½•æˆåŠŸï¼');
        stopPolling();
        setQrcodeModalVisible(false);
        queryClient.invalidateQueries({ queryKey: ['pan115Config'] });
      }
    };
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œç„¶åæ¯2ç§’è½®è¯¢
    poll();
    pollingTimerRef.current = setInterval(poll, 2000);
  };
  
  return (
    <Card title="115ç½‘ç›˜é…ç½®">
      <Form form={form} layout="vertical">
        <Form.Item label="æ­¥éª¤1ï¼šç™»å½•115è´¦å·">
          <Space>
            <Select value={deviceType} onChange={setDeviceType} style={{ width: 260 }}>
              <Select.Option value="qandroid">ğŸ¤– 115ç”Ÿæ´» - Android</Select.Option>
              <Select.Option value="android">ğŸ¤– 115ç½‘ç›˜ - Android</Select.Option>
              <Select.Option value="ios">ğŸ“± 115ç½‘ç›˜ - iOS</Select.Option>
              <Select.Option value="web">ğŸŒ ç½‘é¡µç‰ˆ</Select.Option>
            </Select>
            <Button
              type="primary"
              icon={<QrcodeOutlined />}
              onClick={() => getRegularQRCodeMutation.mutate(deviceType)}
              loading={getRegularQRCodeMutation.isPending}
            >
              æ‰«ç ç™»å½•
            </Button>
          </Space>
        </Form.Item>
        
        {/* æ˜¾ç¤ºç™»å½•çŠ¶æ€å’Œç”¨æˆ·ä¿¡æ¯ */}
        {config?.user_info && (
          <Alert
            message="115ç½‘ç›˜è´¦å·å·²è¿æ¥"
            description={
              <div>
                <p>ç”¨æˆ·: {config.user_info.user_name}</p>
                <p>ä¼šå‘˜ç­‰çº§: {config.user_info.vip_name}</p>
                <p>ç©ºé—´: {formatFileSize(config.user_info.space?.used)} / {formatFileSize(config.user_info.space?.total)}</p>
              </div>
            }
            type="success"
          />
        )}
      </Form>
      
      {/* äºŒç»´ç å¼¹çª— */}
      <Modal
        title="115ç½‘ç›˜æ‰«ç ç™»å½•"
        open={qrcodeModalVisible}
        onCancel={() => setQrcodeModalVisible(false)}
        footer={null}
      >
        <div style={{ textAlign: 'center' }}>
          <QRCode value={qrcodeUrl} size={200} />
          <p>è¯·ä½¿ç”¨115 APPæ‰«æäºŒç»´ç </p>
        </div>
      </Modal>
    </Card>
  );
};
```

---

## æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. æ–‡ä»¶ä¸Šä¼ 

```python
async def upload_file(self, file_path: str, target_dir_id: str = "0",
                     target_path: Optional[str] = None) -> Dict[str, Any]:
    """
    ä¸Šä¼ æ–‡ä»¶åˆ°115ç½‘ç›˜
    
    Args:
        file_path: æœ¬åœ°æ–‡ä»¶è·¯å¾„
        target_dir_id: ç›®æ ‡ç›®å½•IDï¼Œ0è¡¨ç¤ºæ ¹ç›®å½•
        target_path: ç›®æ ‡è·¯å¾„ï¼ˆå¦‚æœæä¾›ï¼Œä¼šå…ˆåˆ›å»ºç›®å½•ï¼‰
        
    Returns:
        {"success": bool, "message": str, "file_id": str, "quick_upload": bool}
    """
    try:
        # å¦‚æœæä¾›äº†è·¯å¾„ï¼Œå…ˆåˆ›å»ºç›®å½•
        if target_path and target_path != '/':
            dir_result = await self.create_directory_path(target_path)
            if dir_result['success']:
                target_dir_id = dir_result['dir_id']
        
        # è·å–ä¸Šä¼ ä¿¡æ¯
        upload_info = await self.get_upload_info(file_path, target_dir_id)
        
        if not upload_info['success']:
            return upload_info
        
        data = upload_info['data']
        
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆç§’ä¼ ï¼‰
        if data.get('status') == 2 or data.get('pick_code'):
            return {
                'success': True,
                'message': 'æ–‡ä»¶ç§’ä¼ æˆåŠŸ',
                'file_id': data.get('file_id', ''),
                'quick_upload': True
            }
        
        # éœ€è¦çœŸå®ä¸Šä¼ 
        upload_url = data.get('upload_url') or data.get('host')
        file_name = os.path.basename(file_path)
        
        with open(file_path, 'rb') as f:
            files = {'file': (file_name, f, 'application/octet-stream')}
            
            upload_params = {
                'app_id': self.app_id,
                'user_id': self.user_id,
                'user_key': self.user_key,
                'timestamp': str(int(time.time())),
                'target': target_dir_id,
            }
            
            if 'upload_params' in data:
                upload_params.update(data['upload_params'])
            
            upload_params['sign'] = self._generate_signature(upload_params)
            
            async with httpx.AsyncClient(**self._get_client_kwargs(timeout=600.0)) as client:
                response = await client.post(upload_url, files=files, data=upload_params)
        
        if response.status_code == 200:
            result = response.json()
            if result.get('state') == True or result.get('code') == 0:
                file_id = result.get('data', {}).get('file_id', '')
                return {
                    'success': True,
                    'message': 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸ',
                    'file_id': file_id,
                    'quick_upload': False
                }
        
        return {'success': False, 'message': 'ä¸Šä¼ å¤±è´¥'}
    except Exception as e:
        logger.error(f"ä¸Šä¼ æ–‡ä»¶å¼‚å¸¸: {e}")
        return {'success': False, 'message': str(e)}
```

### 2. è·å–ç”¨æˆ·ä¿¡æ¯å’Œç©ºé—´ä¿¡æ¯

```python
async def get_user_info(self) -> Dict[str, Any]:
    """
    è·å–ç”¨æˆ·ä¿¡æ¯å’Œç©ºé—´ä¿¡æ¯
    
    æ”¯æŒä¸¤ç§æ–¹å¼ï¼š
    1. Cookieæ–¹å¼ï¼ˆå¸¸è§„ç™»å½•ï¼‰
    2. Access Tokenæ–¹å¼ï¼ˆå¼€æ”¾å¹³å°APIï¼‰
    """
    try:
        # åˆ¤æ–­æ˜¯å¦ä¸ºå¸¸è§„ç™»å½•
        is_cookie_auth = self.user_key and ('UID=' in self.user_key or 'CID=' in self.user_key)
        
        if is_cookie_auth:
            # ä½¿ç”¨Cookieæ–¹å¼
            return await self._get_user_info_by_cookie()
        
        # ä½¿ç”¨å¼€æ”¾å¹³å°API
        params = {
            'app_id': self.app_id,
            'user_id': self.user_id,
            'user_key': self.user_key,
            'timestamp': str(int(time.time())),
        }
        params['sign'] = self._generate_signature(params)
        
        async with httpx.AsyncClient(**self._get_client_kwargs()) as client:
            response = await client.post(f"{self.base_url}/2.0/user/info", data=params)
        
        if response.status_code == 200:
            result = response.json()
            if result.get('state') == True:
                data = result.get('data', {})
                user_info = {
                    'user_id': data.get('user_id'),
                    'user_name': data.get('user_name'),
                    'is_vip': data.get('vip', {}).get('is_vip', False),
                    'vip_level': data.get('vip', {}).get('level', 0),
                    'space': {
                        'total': data.get('space', {}).get('all_total', {}).get('size', 0),
                        'used': data.get('space', {}).get('all_use', {}).get('size', 0),
                        'remain': data.get('space', {}).get('all_remain', {}).get('size', 0),
                    }
                }
                return {'success': True, 'user_info': user_info}
        
        return {'success': False, 'message': 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥'}
    except Exception as e:
        logger.error(f"è·å–ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸: {e}")
        return {'success': False, 'message': str(e)}
```

---

## å®‰å…¨ä¸æœ€ä½³å®è·µ

### 1. CookieæŒä¹…åŒ–

```python
# ä¿å­˜Cookieåˆ°æ–‡ä»¶ï¼ˆé˜²æ­¢æ•°æ®åº“é—®é¢˜å¯¼è‡´Cookieä¸¢å¤±ï¼‰
import os

cookies_file = os.path.join('/app', 'config', '115-cookies.txt')
os.makedirs(os.path.dirname(cookies_file), exist_ok=True)

with open(cookies_file, 'w', encoding='utf-8') as f:
    f.write(cookies_str)

logger.info(f"âœ… Cookieså·²ä¿å­˜åˆ°æ–‡ä»¶: {cookies_file}")
```

### 2. Tokenè¿‡æœŸå¤„ç†

```python
async def refresh_access_token(self) -> Dict[str, Any]:
    """
    åˆ·æ–°Access Token
    
    å½“access_tokenè¿‡æœŸæ—¶ï¼Œå¯ä»¥ä½¿ç”¨refresh_tokenè·å–æ–°çš„token
    """
    if not self.refresh_token:
        return await self.get_access_token()  # å›é€€åˆ°ä½¿ç”¨Cookie+AppIDé‡æ–°è·å–
    
    # ä½¿ç”¨refresh_tokenåˆ·æ–°
    # æ³¨æ„ï¼š115å¯èƒ½ä¸æ”¯æŒrefresh_tokenï¼Œéœ€è¦æ ¹æ®å®é™…APIè°ƒæ•´
```

### 3. APIé™æµå¤„ç†

```python
import asyncio

class Pan115Client:
    def __init__(self, ..., request_interval: float = 1.0):
        self.request_interval = request_interval
        self.last_request_time = 0
    
    async def _rate_limit(self):
        """APIé™æµæ§åˆ¶"""
        current_time = time.time()
        elapsed = current_time - self.last_request_time
        
        if elapsed < self.request_interval:
            await asyncio.sleep(self.request_interval - elapsed)
        
        self.last_request_time = time.time()
    
    async def upload_file(self, ...):
        await self._rate_limit()  # æ¯æ¬¡è°ƒç”¨APIå‰ç­‰å¾…
        # ... å®é™…ä¸Šä¼ é€»è¾‘
```

### 4. é”™è¯¯é‡è¯•æœºåˆ¶

```python
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=2, max=10))
async def _request_with_retry(self, method: str, url: str, **kwargs):
    """å¸¦é‡è¯•çš„HTTPè¯·æ±‚"""
    async with httpx.AsyncClient(**self._get_client_kwargs()) as client:
        if method == 'GET':
            return await client.get(url, **kwargs)
        elif method == 'POST':
            return await client.post(url, **kwargs)
```

### 5. ä»£ç†é…ç½®ï¼ˆå¯é€‰ï¼‰

115æ˜¯å›½å†…æœåŠ¡ï¼Œé€šå¸¸ä¸éœ€è¦ä»£ç†ã€‚ä½†å¦‚æœæ‚¨çš„æœåŠ¡å™¨åœ¨å›½å¤–ï¼Œå¯èƒ½éœ€è¦é…ç½®ä»£ç†ï¼š

```python
class Pan115Client:
    def _get_client_kwargs(self, timeout: float = 10.0, **extra_kwargs):
        kwargs = {'timeout': timeout}
        
        if self.use_proxy:
            # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ä»£ç†é…ç½®
            # export HTTP_PROXY=http://proxy.example.com:8080
            # export HTTPS_PROXY=http://proxy.example.com:8080
            kwargs['trust_env'] = True
        else:
            kwargs['trust_env'] = False
            kwargs['proxies'] = None
        
        return kwargs
```

---

## å¸¸è§é—®é¢˜ä¸æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šè·å–äºŒç»´ç å¤±è´¥

**ç—‡çŠ¶**ï¼šè°ƒç”¨`get_regular_qrcode()`è¿”å›é”™è¯¯

**å¯èƒ½åŸå› **ï¼š
- ç½‘ç»œè¿æ¥é—®é¢˜
- 115æœåŠ¡å™¨ä¸´æ—¶æ•…éšœ
- ä»£ç†é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æµ‹è¯•ç½‘ç»œè¿æ¥
curl https://qrcodeapi.115.com/

# 2. æ£€æŸ¥æ—¥å¿—
tail -f app/backend/logs/pan115.log

# 3. ç¦ç”¨ä»£ç†é‡è¯•
# åœ¨è®¾ç½®é¡µé¢å…³é—­"ä½¿ç”¨ä»£ç†"é€‰é¡¹
```

### é—®é¢˜2ï¼šæ‰«ç æˆåŠŸä½†Cookieæœªä¿å­˜

**ç—‡çŠ¶**ï¼šæ‰«ç æˆåŠŸï¼Œä½†åˆ·æ–°åæ˜¾ç¤ºæœªç™»å½•

**å¯èƒ½åŸå› **ï¼š
- æ•°æ®åº“å†™å…¥å¤±è´¥
- Cookieæ–‡ä»¶å†™å…¥æƒé™é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥Cookieæ–‡ä»¶æƒé™
ls -la /app/config/115-cookies.txt

# 2. ç¡®ä¿ç›®å½•æœ‰å†™æƒé™
chmod 755 /app/config
chmod 644 /app/config/115-cookies.txt

# 3. æŸ¥çœ‹æ•°æ®åº“
sqlite3 data/bot.db "SELECT pan115_user_id FROM media_settings;"
```

### é—®é¢˜3ï¼šç©ºé—´ä¿¡æ¯æ˜¾ç¤ºä¸º0

**ç—‡çŠ¶**ï¼šç™»å½•æˆåŠŸï¼Œä½†ç©ºé—´ä¿¡æ¯å…¨ä¸º0

**å¯èƒ½åŸå› **ï¼š
- 115 APIé™æµï¼ˆæœ€å¸¸è§ï¼‰
- Cookieå·²è¿‡æœŸ
- APIè¿”å›æ ¼å¼å˜åŒ–

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# 1. ç­‰å¾…1-2åˆ†é’Ÿåç‚¹å‡»"åˆ·æ–°ç”¨æˆ·ä¿¡æ¯"
# 2. æ£€æŸ¥åç«¯æ—¥å¿—æŸ¥çœ‹è¯¦ç»†é”™è¯¯
# 3. å°è¯•ä½¿ç”¨å¼€æ”¾å¹³å°APIï¼ˆæ›´ç¨³å®šï¼‰

# å‰ç«¯ä¼šè‡ªåŠ¨ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œä¸ä¼šå½±å“æ­£å¸¸ä½¿ç”¨
```

### é—®é¢˜4ï¼šæ–‡ä»¶ä¸Šä¼ å¤±è´¥

**ç—‡çŠ¶**ï¼šä¸Šä¼ æ–‡ä»¶æ—¶æŠ¥é”™

**å¯èƒ½åŸå› **ï¼š
- æ–‡ä»¶è¿‡å¤§ï¼ˆè¶…è¿‡VIPé™åˆ¶ï¼‰
- ç½‘ç»œè¶…æ—¶
- ç›®æ ‡ç›®å½•ä¸å­˜åœ¨
- ç­¾åéªŒè¯å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# 1. æ£€æŸ¥æ–‡ä»¶å¤§å°
import os
file_size = os.path.getsize(file_path)
print(f"æ–‡ä»¶å¤§å°: {file_size / 1024 / 1024:.2f} MB")

# 2. å¢åŠ è¶…æ—¶æ—¶é—´
client = Pan115Client(..., timeout=600)  # 10åˆ†é’Ÿ

# 3. æµ‹è¯•åˆ›å»ºç›®å½•
result = await client.create_directory('test_dir')
```

### é—®é¢˜5ï¼šOAuthæ¿€æ´»å¤±è´¥

**ç—‡çŠ¶**ï¼šç‚¹å‡»"å¯ç”¨OPENAPI"åæŠ¥é”™

**å¯èƒ½åŸå› **ï¼š
- AppIDæœªé…ç½®æˆ–æ— æ•ˆ
- Cookieå·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•
- 115æœåŠ¡å™¨é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# 1. ç¡®è®¤AppIDæ­£ç¡®
# 2. å…ˆæ‰«ç ç™»å½•è·å–Cookie
# 3. å†æ¿€æ´»å¼€æ”¾å¹³å°API

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
tail -f app/backend/logs/pan115.log | grep "activate"
```

---

## APIæ¥å£è¯´æ˜

### åç«¯APIç«¯ç‚¹

#### 1. è·å–é…ç½®
```
GET /api/pan115/config
```

**å“åº”**ï¼š
```json
{
  "pan115_app_id": "123456",
  "pan115_user_id": "987654321",
  "pan115_user_key": "UID=****",
  "is_configured": true,
  "open_api_activated": false,
  "user_info": {
    "user_name": "ç”¨æˆ·å",
    "vip_name": "å¹´è´¹VIP",
    "space": {
      "total": 107374182400,
      "used": 53687091200,
      "remain": 53687091200
    }
  }
}
```

#### 2. æ›´æ–°é…ç½®
```
POST /api/pan115/config
```

**è¯·æ±‚**ï¼š
```json
{
  "pan115_app_id": "123456",
  "pan115_request_interval": 1.0,
  "pan115_use_proxy": false
}
```

#### 3. è·å–ç™»å½•äºŒç»´ç 
```
POST /api/pan115/regular-qrcode
```

**è¯·æ±‚**ï¼š
```json
{
  "app": "qandroid"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "qrcode_url": "data:image/png;base64,...",
  "qrcode_token": {
    "uid": "abc123",
    "time": 1698765432,
    "sign": "xyz789"
  },
  "expires_in": 300,
  "message": "è·å–äºŒç»´ç æˆåŠŸ"
}
```

#### 4. æ£€æŸ¥æ‰«ç çŠ¶æ€
```
POST /api/pan115/regular-qrcode/status
```

**è¯·æ±‚**ï¼š
```json
{
  "qrcode_token": {
    "uid": "abc123",
    "time": 1698765432,
    "sign": "xyz789"
  },
  "app": "qandroid"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "status": "confirmed",
  "user_id": "987654321",
  "user_info": {
    "user_name": "ç”¨æˆ·å",
    "is_vip": true,
    "vip_level": 5,
    "vip_name": "å¹´è´¹VIP"
  },
  "message": "ç™»å½•æˆåŠŸ"
}
```

#### 5. æ¿€æ´»å¼€æ”¾å¹³å°API
```
POST /api/pan115/activate-open-api
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "âœ… å¼€æ”¾å¹³å°APIå·²æ¿€æ´»",
  "user_info": {...},
  "has_space_info": true
}
```

#### 6. ä¸Šä¼ æ–‡ä»¶
```
POST /api/pan115/upload
```

**è¯·æ±‚**ï¼š
```json
{
  "file_path": "/path/to/local/file.mp4",
  "remote_path": "/telegram_downloads"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "file_id": "file123",
  "file_name": "file.mp4",
  "is_quick": false,
  "message": "ä¸Šä¼ æˆåŠŸ"
}
```

#### 7. åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
```
POST /api/pan115/refresh-user-info
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "âœ… ç”¨æˆ·ä¿¡æ¯å·²åˆ·æ–°",
  "user_info": {...},
  "from_cache": false
}
```

---

## æ€»ç»“

### å®Œæ•´é›†æˆæµç¨‹

```
1. ç”¨æˆ·æ‰«ç ç™»å½• (å¸¸è§„æ–¹å¼)
   â””â”€> è·å–Cookie
       â””â”€> ä¿å­˜åˆ°æ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿ
           â””â”€> å¯ä»¥ä½¿ç”¨åŸºç¡€æ–‡ä»¶æ“ä½œåŠŸèƒ½

2. (å¯é€‰) æ¿€æ´»å¼€æ”¾å¹³å°API
   â””â”€> é…ç½®AppID
       â””â”€> ä½¿ç”¨Cookie+AppIDè·å–Access Token
           â””â”€> è·å¾—æ›´ç¨³å®šçš„APIè®¿é—®æƒé™
```

### æŠ€æœ¯ç‰¹ç‚¹

âœ… **åŒæ¨¡å¼æ”¯æŒ**ï¼šCookieç™»å½•ï¼ˆå¿«é€Ÿï¼‰ + OAuth APIï¼ˆç¨³å®šï¼‰  
âœ… **å®‰å…¨å¯é **ï¼šPKCEé˜²æ‹¦æˆª + CookieæŒä¹…åŒ–  
âœ… **ç”¨æˆ·å‹å¥½**ï¼šè‡ªåŠ¨è½®è¯¢ + å®æ—¶çŠ¶æ€åé¦ˆ  
âœ… **å®¹é”™æœºåˆ¶**ï¼šç¼“å­˜ç”¨æˆ·ä¿¡æ¯ + è‡ªåŠ¨é‡è¯•  
âœ… **é˜²æŠ–ä¼˜åŒ–**ï¼š30ç§’é˜²æŠ– + APIé™æµæ§åˆ¶  

### ä¸‹ä¸€æ­¥

1. **æµ‹è¯•ä¸Šä¼ åŠŸèƒ½**ï¼šå®ç°æ–‡ä»¶ä¸Šä¼ åˆ°115
2. **å®ç°è‡ªåŠ¨å¤‡ä»½**ï¼šå®šæ—¶å¤‡ä»½é‡è¦æ–‡ä»¶
3. **æ·»åŠ åˆ†äº«åŠŸèƒ½**ï¼šç”Ÿæˆ115åˆ†äº«é“¾æ¥
4. **ç›‘æ§Tokenæœ‰æ•ˆæœŸ**ï¼šè‡ªåŠ¨åˆ·æ–°è¿‡æœŸToken

---

## å‚è€ƒèµ„æ–™

- ğŸ“š [115å¼€æ”¾å¹³å°å®˜æ–¹æ–‡æ¡£](https://www.yuque.com/115yun/open)
- ğŸ” [OAuth 2.0 Device Flow RFC 8628](https://datatracker.ietf.org/doc/html/rfc8628)
- ğŸ›¡ï¸ [PKCE RFC 7636](https://datatracker.ietf.org/doc/html/rfc7636)
- ğŸ¯ [é¡¹ç›®ç°æœ‰å®ç°å‚è€ƒ](./115_OAUTH_DEVICE_FLOW_GUIDE.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01-17  
**ä½œè€…**ï¼šTMCé¡¹ç›®å›¢é˜Ÿ





