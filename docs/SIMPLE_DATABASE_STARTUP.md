# test 分支极简数据库启动流程

> **核心理念：简单、直接、失败即删除**

## 🎯 设计目标

test 分支专注于功能开发和实验，**不维护数据库迁移兼容性**。

### 流程概述

```
数据库存在？
├─ 是 → 版本匹配？
│   ├─ 匹配 ✅ → 直接使用
│   └─ 不匹配 ❌ → 提示删除并退出
└─ 否 → 创建全新数据库 ✅
```

## 📦 启动流程（docker-entrypoint.sh）

### 1. 检测阶段

```bash
# 获取最新 Alembic 版本号
LATEST_VERSION=$(alembic heads | grep -o '[a-z0-9_]*' | head -1)

# 检查数据库文件是否存在
if [ -f "$DB_FILE" ]; then
    # 已有数据库
else
    # 新建数据库
fi
```

### 2. 版本验证（已有数据库）

```bash
# 获取当前数据库版本
CURRENT_VERSION=$(sqlite3 "$DB_FILE" "SELECT version_num FROM alembic_version")

if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
    ✅ 直接使用
else
    ❌ 退出并提示删除
fi
```

### 3. 创建数据库（新数据库）

```bash
alembic upgrade head
```

## 🔧 用户操作

### 场景1：全新部署

```bash
docker-compose up -d
# ✅ 自动创建最新数据库
```

### 场景2：版本不匹配

```bash
# 容器会提示：
❌ 数据库版本不匹配
   当前版本: xxx
   需要版本: yyy

💡 test 分支不支持数据迁移，请删除数据库：
   docker-compose down -v
   docker-compose up -d

# 用户执行：
docker-compose down -v
docker-compose up -d
# ✅ 重新创建最新数据库
```

### 场景3：数据库损坏

```bash
# 容器会提示：
❌ 数据库结构不完整（缺少版本表）

💡 请删除数据库后重新启动：
   docker-compose down -v
   docker-compose up -d
```

## 📊 代码统计

### 简化前后对比

| 项目 | 简化前 | 简化后 | 减少 |
|------|--------|--------|------|
| docker-entrypoint.sh | 58 行 | 46 行 | -21% |
| 迁移脚本数量 | 9 个 | 8 个 | -11% |
| 复杂度 | 高 | 低 | ⬇️⬇️⬇️ |

### 删除的复杂逻辑

1. ❌ `fix_alembic_version.py` (192 行) - 智能版本检测
2. ❌ `check_and_fix_schema.py` (302 行) - 自动 schema 修复
3. ❌ `fix_keywords_replace_schema_20251009.py` (172 行) - 复杂迁移脚本
4. ❌ 多重条件判断和循环检测
5. ❌ 数据库表结构验证
6. ❌ 自动修复尝试

**总计删除：** ~666 行复杂代码 🎉

## ✨ 优势

### 1. **简单直接**
- 只做两件事：创建或加载
- 没有中间状态，没有"尝试修复"
- 逻辑清晰，易于理解

### 2. **快速启动**
- 无需复杂检测
- 无需多次尝试
- 3步即可完成

### 3. **可预测**
- 成功就是成功
- 失败立即提示
- 用户明确知道如何解决

### 4. **易于维护**
- 代码量少
- 逻辑简单
- Bug 少

## 🚨 重要提醒

### test 分支特性

1. **实验性质** - 用于功能开发和测试
2. **不向后兼容** - 数据库结构可能随时变化
3. **推荐全新部署** - 升级请删除旧数据库

### 与 main 分支对比

| 特性 | main 分支 | test 分支 |
|------|-----------|-----------|
| 数据迁移 | ✅ 支持 | ❌ 不支持 |
| 向后兼容 | ✅ 保证 | ❌ 不保证 |
| 稳定性 | ✅ 高 | ⚠️ 实验中 |
| 迭代速度 | ⏳ 谨慎 | ⚡ 快速 |
| 适用场景 | 生产环境 | 开发测试 |

## 📝 开发建议

### 创建新迁移

```bash
cd app/backend
alembic revision --autogenerate -m "描述"
```

### 注意事项

1. **不要**创建复杂的"修复"迁移
2. **不要**尝试兼容旧版本
3. **只**创建新表或新列
4. 保持迁移脚本简单

### 迁移链原则

```
简单的线性链：
A → B → C → D (当前)

不要创建：
A → B → [修复B] → C → [修复C] → D ❌
```

## 🎉 总结

test 分支的数据库策略：

> **能用则用，不行删除，重新开始！**

这种简单粗暴的方式非常适合快速迭代的开发分支，让开发者专注于功能实现而不是复杂的数据迁移逻辑。

---

**最后更新：** 2025-10-11  
**相关文档：** `TEST_BRANCH_POLICY.md`, `UPGRADE_TO_TEST_BRANCH.md`

