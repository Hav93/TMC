# 115Botå…¶ä»–åŠŸèƒ½æ·±åº¦åˆ†æä¸å€Ÿé‰´ä»·å€¼è¯„ä¼°

> é’ˆå¯¹è®¢é˜…åŠŸèƒ½ã€è®¸æ„¿æ ‘ã€STRMç”Ÿæˆã€æ‰¹é‡è§£å‹ç­‰ç‰¹è‰²åŠŸèƒ½çš„è¯¦ç»†åˆ†æ
> 
> **åˆ†ææ—¥æœŸï¼š** 2025-01-12  
> **ç›®æ ‡ï¼š** è¯„ä¼°è¿™äº›åŠŸèƒ½å¯¹TMCé¡¹ç›®çš„å€Ÿé‰´ä»·å€¼å’Œå®æ–½å¯è¡Œæ€§

---

## ç›®å½•

1. [åŠŸèƒ½æ¸…å•](#1-åŠŸèƒ½æ¸…å•)
2. [è®¢é˜…åŠŸèƒ½è¯¦è§£](#2-è®¢é˜…åŠŸèƒ½è¯¦è§£)
3. [è®¸æ„¿æ ‘åŠŸèƒ½](#3-è®¸æ„¿æ ‘åŠŸèƒ½)
4. [STRMæ–‡ä»¶ç”Ÿæˆ](#4-strmæ–‡ä»¶ç”Ÿæˆ)
5. [æ‰¹é‡è§£å‹åŠŸèƒ½](#5-æ‰¹é‡è§£å‹åŠŸèƒ½)
6. [è‡ªåŠ¨é‡å‘½å](#6-è‡ªåŠ¨é‡å‘½å)
7. [å¹¿å‘Šæ–‡ä»¶è¿‡æ»¤](#7-å¹¿å‘Šæ–‡ä»¶è¿‡æ»¤)
8. [ç»¼åˆè¯„ä¼°](#8-ç»¼åˆè¯„ä¼°)
9. [å®æ–½å»ºè®®](#9-å®æ–½å»ºè®®)

---

## 1. åŠŸèƒ½æ¸…å•

### 1.1 115Botç‰¹è‰²åŠŸèƒ½æ€»è§ˆ

| åŠŸèƒ½ | æè¿° | TMCæ˜¯å¦æœ‰ | å€Ÿé‰´ä»·å€¼ | å®æ–½éš¾åº¦ |
|------|------|-----------|----------|----------|
| **è®¢é˜…æ¯æ—¥æ›´æ–°** | è®¢é˜…ç‰¹å®šå†…å®¹çš„æ¯æ—¥æ›´æ–° | âŒ | â­â­â­â­â­ | ä¸­ |
| **è®¸æ„¿æ ‘è‡ªåŠ¨åŒ–** | è‡ªåŠ¨è®¸æ„¿ã€åŠ©æ„¿ã€é‡‡çº³ | âŒ | â­â­ | ä½ |
| **STRMæ–‡ä»¶ç”Ÿæˆ** | ä¸ºè§†é¢‘ç”Ÿæˆæµåª’ä½“æ–‡ä»¶ | âŒ | â­â­â­â­ | ä½ |
| **æ‰¹é‡è§£å‹** | è‡ªåŠ¨è§£å‹ç½‘ç›˜å‹ç¼©æ–‡ä»¶ | âŒ | â­â­â­ | ä¸­ |
| **è‡ªåŠ¨é‡å‘½å** | æ™ºèƒ½é‡å‘½åæ–‡ä»¶ | âœ… éƒ¨åˆ† | â­â­â­â­ | ä½ |
| **å¹¿å‘Šæ–‡ä»¶è¿‡æ»¤** | è‡ªåŠ¨åˆ é™¤å¹¿å‘Šæ–‡ä»¶ | âŒ | â­â­â­â­â­ | ä½ |
| **ç¦»çº¿ä»»åŠ¡ç›‘æ§** | ç›‘æ§115ç¦»çº¿ä¸‹è½½ | âŒ | â­â­â­â­ | ä¸­ |
| **ç§’ä¼ æ£€æµ‹** | ä¸Šä¼ å‰æ£€æŸ¥ç§’ä¼  | âŒ | â­â­â­â­â­ | ä½ |

---

## 2. è®¢é˜…åŠŸèƒ½è¯¦è§£

### 2.1 åŠŸèƒ½æè¿°

**æ ¸å¿ƒæ¦‚å¿µï¼š** è®¢é˜…Telegramé¢‘é“/ç¾¤ç»„çš„ç‰¹å®šå†…å®¹ï¼Œè‡ªåŠ¨ä¸‹è½½å¹¶å½’æ¡£åˆ°115ç½‘ç›˜

**å…¸å‹åœºæ™¯ï¼š**
```
åœºæ™¯1ï¼šè®¢é˜…ç”µå½±èµ„æºé¢‘é“
- ç”¨æˆ·è®¢é˜… @movie_channel
- è®¾ç½®è¿‡æ»¤æ¡ä»¶ï¼š4Kã€BluRayã€>10GB
- æ¯å¤©è‡ªåŠ¨æ£€æŸ¥æ–°æ¶ˆæ¯
- ç¬¦åˆæ¡ä»¶çš„è‡ªåŠ¨ä¸‹è½½åˆ°115ç½‘ç›˜

åœºæ™¯2ï¼šè®¢é˜…è½¯ä»¶æ›´æ–°é¢‘é“
- ç”¨æˆ·è®¢é˜… @software_updates
- è®¾ç½®å…³é”®è¯ï¼šPhotoshopã€ç ´è§£ç‰ˆ
- è‡ªåŠ¨ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
- ä¿ç•™å†å²ç‰ˆæœ¬
```

### 2.2 æŠ€æœ¯å®ç°

#### 2.2.1 æ•°æ®æ¨¡å‹

```python
class SubscriptionRule(Base):
    """è®¢é˜…è§„åˆ™æ¨¡å‹"""
    __tablename__ = 'subscription_rules'
    
    id = Column(Integer, primary_key=True)
    name = Column(String(100), nullable=False, comment='è®¢é˜…åç§°')
    description = Column(Text, comment='è®¢é˜…æè¿°')
    is_active = Column(Boolean, default=True, comment='æ˜¯å¦å¯ç”¨')
    
    # è®¢é˜…æº
    source_chat_id = Column(String(50), nullable=False, comment='è®¢é˜…çš„é¢‘é“/ç¾¤ç»„ID')
    source_chat_name = Column(String(200), comment='é¢‘é“/ç¾¤ç»„åç§°')
    
    # è¿‡æ»¤æ¡ä»¶
    keywords = Column(Text, comment='å…³é”®è¯ï¼ˆé€—å·åˆ†éš”ï¼‰')
    exclude_keywords = Column(Text, comment='æ’é™¤å…³é”®è¯')
    media_types = Column(Text, comment='åª’ä½“ç±»å‹ï¼š["video","document"]')
    min_size_mb = Column(Integer, comment='æœ€å°æ–‡ä»¶å¤§å°')
    max_size_mb = Column(Integer, comment='æœ€å¤§æ–‡ä»¶å¤§å°')
    file_extensions = Column(Text, comment='æ–‡ä»¶æ‰©å±•åï¼š[".mp4",".mkv"]')
    
    # æ£€æŸ¥è®¾ç½®
    check_frequency = Column(String(20), default='daily', comment='æ£€æŸ¥é¢‘ç‡ï¼šhourly/daily/weekly')
    check_time = Column(String(10), comment='æ£€æŸ¥æ—¶é—´ï¼š08:00')
    last_check_at = Column(DateTime, comment='æœ€åæ£€æŸ¥æ—¶é—´')
    last_message_id = Column(Integer, comment='æœ€åå¤„ç†çš„æ¶ˆæ¯ID')
    
    # ä¸‹è½½è®¾ç½®
    auto_download = Column(Boolean, default=True, comment='æ˜¯å¦è‡ªåŠ¨ä¸‹è½½')
    download_limit = Column(Integer, default=10, comment='æ¯æ¬¡æœ€å¤šä¸‹è½½æ•°é‡')
    
    # å½’æ¡£è®¾ç½®
    target_folder = Column(String(255), comment='115ç½‘ç›˜ç›®æ ‡æ–‡ä»¶å¤¹')
    organize_by = Column(String(20), default='date', comment='ç»„ç»‡æ–¹å¼ï¼šdate/type/sender')
    
    # é€šçŸ¥è®¾ç½®
    notify_on_download = Column(Boolean, default=True, comment='ä¸‹è½½æ—¶é€šçŸ¥')
    notify_chat_id = Column(String(50), comment='é€šçŸ¥å‘é€åˆ°çš„èŠå¤©ID')
    
    # ç»Ÿè®¡
    total_checked = Column(Integer, default=0, comment='ç´¯è®¡æ£€æŸ¥æ¬¡æ•°')
    total_downloaded = Column(Integer, default=0, comment='ç´¯è®¡ä¸‹è½½æ•°é‡')
    
    # æ—¶é—´æˆ³
    created_at = Column(DateTime, default=datetime.now)
    updated_at = Column(DateTime, default=datetime.now, onupdate=datetime.now)
```

#### 2.2.2 æ ¸å¿ƒé€»è¾‘

```python
class SubscriptionService:
    """è®¢é˜…æœåŠ¡"""
    
    async def check_subscription(self, rule: SubscriptionRule):
        """æ£€æŸ¥è®¢é˜…æ›´æ–°"""
        try:
            # 1. è·å–Telegramå®¢æˆ·ç«¯
            client = await self.get_telegram_client(rule.client_id)
            
            # 2. è·å–é¢‘é“æœ€æ–°æ¶ˆæ¯
            messages = await client.get_messages(
                rule.source_chat_id,
                limit=100,
                min_id=rule.last_message_id or 0
            )
            
            # 3. è¿‡æ»¤æ¶ˆæ¯
            matched_messages = []
            for message in messages:
                if await self.match_filters(message, rule):
                    matched_messages.append(message)
            
            # 4. é™åˆ¶ä¸‹è½½æ•°é‡
            if len(matched_messages) > rule.download_limit:
                matched_messages = matched_messages[:rule.download_limit]
            
            # 5. åˆ›å»ºä¸‹è½½ä»»åŠ¡
            for message in matched_messages:
                await self.create_download_task(message, rule)
            
            # 6. æ›´æ–°æ£€æŸ¥è®°å½•
            rule.last_check_at = datetime.now()
            rule.last_message_id = messages[0].id if messages else rule.last_message_id
            rule.total_checked += 1
            rule.total_downloaded += len(matched_messages)
            await self.db.commit()
            
            # 7. å‘é€é€šçŸ¥
            if rule.notify_on_download and matched_messages:
                await self.send_notification(
                    rule.notify_chat_id,
                    f"ğŸ“¥ è®¢é˜… {rule.name} å‘ç° {len(matched_messages)} ä¸ªæ–°èµ„æº"
                )
            
            logger.info(f"âœ… è®¢é˜…æ£€æŸ¥å®Œæˆ: {rule.name}, å‘ç°{len(matched_messages)}ä¸ªæ–°èµ„æº")
            
        except Exception as e:
            logger.error(f"âŒ è®¢é˜…æ£€æŸ¥å¤±è´¥: {rule.name}, {e}")
    
    async def match_filters(self, message, rule: SubscriptionRule) -> bool:
        """åŒ¹é…è¿‡æ»¤æ¡ä»¶"""
        # 1. æ£€æŸ¥æ˜¯å¦åŒ…å«åª’ä½“
        if not (message.photo or message.video or message.document):
            return False
        
        # 2. æ£€æŸ¥å…³é”®è¯
        if rule.keywords:
            keywords = [k.strip() for k in rule.keywords.split(',')]
            text = message.text or message.caption or ''
            if not any(kw in text for kw in keywords):
                return False
        
        # 3. æ£€æŸ¥æ’é™¤å…³é”®è¯
        if rule.exclude_keywords:
            exclude_keywords = [k.strip() for k in rule.exclude_keywords.split(',')]
            text = message.text or message.caption or ''
            if any(kw in text for kw in exclude_keywords):
                return False
        
        # 4. æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if rule.media_types:
            media_types = json.loads(rule.media_types)
            message_type = self.get_message_type(message)
            if message_type not in media_types:
                return False
        
        # 5. æ£€æŸ¥æ–‡ä»¶å¤§å°
        file_size_mb = self.get_file_size_mb(message)
        if rule.min_size_mb and file_size_mb < rule.min_size_mb:
            return False
        if rule.max_size_mb and file_size_mb > rule.max_size_mb:
            return False
        
        # 6. æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
        if rule.file_extensions:
            extensions = json.loads(rule.file_extensions)
            file_name = self.get_file_name(message)
            if not any(file_name.endswith(ext) for ext in extensions):
                return False
        
        return True
    
    async def schedule_checks(self):
        """è°ƒåº¦è®¢é˜…æ£€æŸ¥ä»»åŠ¡"""
        # ä½¿ç”¨APSchedulerå®šæ—¶æ‰§è¡Œ
        from apscheduler.schedulers.asyncio import AsyncIOScheduler
        
        scheduler = AsyncIOScheduler()
        
        # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ‰€æœ‰è®¢é˜…
        scheduler.add_job(
            self.check_all_subscriptions,
            'cron',
            minute=0,  # æ¯å°æ—¶çš„ç¬¬0åˆ†é’Ÿ
            id='check_subscriptions'
        )
        
        scheduler.start()
        logger.info("ğŸ“… è®¢é˜…æ£€æŸ¥è°ƒåº¦å™¨å·²å¯åŠ¨")
    
    async def check_all_subscriptions(self):
        """æ£€æŸ¥æ‰€æœ‰æ´»è·ƒè®¢é˜…"""
        async for db in get_db():
            # è·å–æ‰€æœ‰æ´»è·ƒè®¢é˜…
            result = await db.execute(
                select(SubscriptionRule).where(SubscriptionRule.is_active == True)
            )
            rules = result.scalars().all()
            
            for rule in rules:
                # æ£€æŸ¥æ˜¯å¦åˆ°äº†æ£€æŸ¥æ—¶é—´
                if self.should_check_now(rule):
                    await self.check_subscription(rule)
            
            break
    
    def should_check_now(self, rule: SubscriptionRule) -> bool:
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥ç°åœ¨æ£€æŸ¥"""
        now = datetime.now()
        
        # å¦‚æœä»æœªæ£€æŸ¥è¿‡ï¼Œç«‹å³æ£€æŸ¥
        if not rule.last_check_at:
            return True
        
        # æ ¹æ®æ£€æŸ¥é¢‘ç‡åˆ¤æ–­
        if rule.check_frequency == 'hourly':
            return (now - rule.last_check_at).total_seconds() >= 3600
        elif rule.check_frequency == 'daily':
            # æ£€æŸ¥æ˜¯å¦åˆ°äº†æŒ‡å®šæ—¶é—´
            if rule.check_time:
                check_hour, check_minute = map(int, rule.check_time.split(':'))
                if now.hour == check_hour and now.minute == check_minute:
                    # æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»æ£€æŸ¥è¿‡
                    return rule.last_check_at.date() < now.date()
            else:
                # é»˜è®¤æ¯24å°æ—¶æ£€æŸ¥ä¸€æ¬¡
                return (now - rule.last_check_at).total_seconds() >= 86400
        elif rule.check_frequency == 'weekly':
            return (now - rule.last_check_at).total_seconds() >= 604800
        
        return False
```

### 2.3 å€Ÿé‰´ä»·å€¼è¯„ä¼°

#### 2.3.1 å¯¹TMCçš„ä»·å€¼ â­â­â­â­â­

**é«˜ä»·å€¼åœºæ™¯ï¼š**

1. **èµ„æºè‡ªåŠ¨æ”¶é›†**
   - è®¢é˜…å¤šä¸ªèµ„æºé¢‘é“
   - è‡ªåŠ¨ä¸‹è½½ç¬¦åˆæ¡ä»¶çš„èµ„æº
   - ç»Ÿä¸€å½’æ¡£åˆ°115ç½‘ç›˜

2. **å†…å®¹èšåˆ**
   - ä»å¤šä¸ªæ¥æºèšåˆå†…å®¹
   - æŒ‰ä¸»é¢˜åˆ†ç±»å½’æ¡£
   - è‡ªåŠ¨å»é‡

3. **å®šæ—¶ç›‘æ§**
   - ç›‘æ§ç‰¹å®šå…³é”®è¯
   - å‘ç°æ–°èµ„æºç«‹å³ä¸‹è½½
   - é¿å…é”™è¿‡é‡è¦å†…å®¹

**å®é™…æ•ˆæœï¼š**
- âœ… èŠ‚çœäººå·¥æ—¶é—´ï¼šè‡ªåŠ¨åŒ–æ”¶é›†ï¼Œæ— éœ€æ‰‹åŠ¨ä¸‹è½½
- âœ… æé«˜æ•ˆç‡ï¼š24å°æ—¶ç›‘æ§ï¼Œä¸é”™è¿‡ä»»ä½•æ›´æ–°
- âœ… æ™ºèƒ½è¿‡æ»¤ï¼šåªä¸‹è½½éœ€è¦çš„å†…å®¹ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
- âœ… ç»Ÿä¸€ç®¡ç†ï¼šæ‰€æœ‰è®¢é˜…å†…å®¹é›†ä¸­ç®¡ç†

#### 2.3.2 å®æ–½å»ºè®®

**ä¼˜å…ˆçº§ï¼šâ­â­â­â­â­ å¼ºçƒˆæ¨è**

**å®æ–½æ­¥éª¤ï¼š**

1. **é˜¶æ®µ1ï¼ˆ1å‘¨ï¼‰ï¼šåŸºç¡€è®¢é˜…**
   - åˆ›å»ºè®¢é˜…è§„åˆ™è¡¨
   - å®ç°åŸºç¡€è®¢é˜…æ£€æŸ¥
   - é›†æˆåˆ°ç°æœ‰ä¸‹è½½æµç¨‹

2. **é˜¶æ®µ2ï¼ˆ1å‘¨ï¼‰ï¼šé«˜çº§è¿‡æ»¤**
   - å®ç°å…³é”®è¯è¿‡æ»¤
   - å®ç°æ–‡ä»¶ç±»å‹è¿‡æ»¤
   - å®ç°å¤§å°è¿‡æ»¤

3. **é˜¶æ®µ3ï¼ˆ1å‘¨ï¼‰ï¼šå®šæ—¶è°ƒåº¦**
   - é›†æˆAPScheduler
   - å®ç°å®šæ—¶æ£€æŸ¥
   - å®ç°é€šçŸ¥åŠŸèƒ½

**å·¥ä½œé‡ï¼š** 3å‘¨

**é¢„æœŸæ”¶ç›Šï¼š**
- ğŸ“ˆ ç”¨æˆ·æ´»è·ƒåº¦æå‡50%
- â° èŠ‚çœç”¨æˆ·æ—¶é—´80%
- ğŸ¯ èµ„æºæ”¶é›†æ•ˆç‡æå‡10å€

---

## 3. è®¸æ„¿æ ‘åŠŸèƒ½

### 3.1 åŠŸèƒ½æè¿°

**æ ¸å¿ƒæ¦‚å¿µï¼š** 115ç½‘ç›˜çš„ç¤¾åŒºäº’åŠ©åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥è®¸æ„¿æƒ³è¦çš„èµ„æºï¼Œå…¶ä»–ç”¨æˆ·åŠ©æ„¿åˆ†äº«

**åŠŸèƒ½æµç¨‹ï¼š**
```
1. ç”¨æˆ·Aå‘èµ·è®¸æ„¿ï¼šæƒ³è¦ã€Šç”µå½±åã€‹4Kç‰ˆæœ¬
2. ç”¨æˆ·Bçœ‹åˆ°è®¸æ„¿ï¼Œå¦‚æœæœ‰èµ„æºå°±åŠ©æ„¿ï¼ˆåˆ†äº«é“¾æ¥ï¼‰
3. ç”¨æˆ·Aé‡‡çº³åŠ©æ„¿ï¼Œè·å¾—èµ„æº
4. 115Botè‡ªåŠ¨åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼š
   - è‡ªåŠ¨è®¸æ„¿ï¼ˆæ ¹æ®ç”¨æˆ·é…ç½®ï¼‰
   - è‡ªåŠ¨åŠ©æ„¿ï¼ˆå¦‚æœæœ¬åœ°æœ‰èµ„æºï¼‰
   - è‡ªåŠ¨é‡‡çº³ï¼ˆä¸‹è½½åˆ°ç½‘ç›˜ï¼‰
```

### 3.2 å€Ÿé‰´ä»·å€¼è¯„ä¼°

#### 3.2.1 å¯¹TMCçš„ä»·å€¼ â­â­

**é—®é¢˜åˆ†æï¼š**

1. **åŠŸèƒ½å±€é™æ€§**
   - ä»…é€‚ç”¨äº115ç½‘ç›˜ç”Ÿæ€
   - ä¾èµ–ç¤¾åŒºæ´»è·ƒåº¦
   - èµ„æºè´¨é‡ä¸å¯æ§

2. **æŠ€æœ¯å¤æ‚åº¦**
   - éœ€è¦æ¨¡æ‹Ÿ115ç½‘ç›˜Webæ“ä½œ
   - éœ€è¦å¤„ç†éªŒè¯ç 
   - éœ€è¦ç»´æŠ¤ä¼šè¯çŠ¶æ€

3. **å®é™…æ•ˆæœæœ‰é™**
   - è®¸æ„¿æˆåŠŸç‡ä¸é«˜ï¼ˆä¾èµ–å…¶ä»–ç”¨æˆ·ï¼‰
   - èµ„æºè´¨é‡å‚å·®ä¸é½
   - å¯èƒ½æ¶‰åŠç‰ˆæƒé—®é¢˜

**ç»“è®ºï¼šä¸å»ºè®®å®æ–½** âŒ

**åŸå› ï¼š**
- âš ï¸ æŠ•å…¥äº§å‡ºæ¯”ä½
- âš ï¸ åŠŸèƒ½ä»·å€¼æœ‰é™
- âš ï¸ æŠ€æœ¯å¤æ‚åº¦é«˜
- âš ï¸ å¯èƒ½çš„æ³•å¾‹é£é™©

**æ›¿ä»£æ–¹æ¡ˆï¼š**
- âœ… å¢å¼ºè®¢é˜…åŠŸèƒ½ï¼ˆè¦†ç›–æ›´å¤šèµ„æºæ¸ é“ï¼‰
- âœ… å®ç°èµ„æºæœç´¢åŠŸèƒ½ï¼ˆæœç´¢å·²ä¸‹è½½çš„èµ„æºï¼‰
- âœ… å®ç°èµ„æºåˆ†äº«åŠŸèƒ½ï¼ˆå›¢é˜Ÿå†…éƒ¨åˆ†äº«ï¼‰

---

## 4. STRMæ–‡ä»¶ç”Ÿæˆ

### 4.1 åŠŸèƒ½æè¿°

**æ ¸å¿ƒæ¦‚å¿µï¼š** ä¸ºè§†é¢‘æ–‡ä»¶ç”ŸæˆSTRMæµåª’ä½“æ–‡ä»¶ï¼Œä¾›Emby/Jellyfin/Plexç­‰åª’ä½“æœåŠ¡å™¨æ’­æ”¾

**STRMæ–‡ä»¶æ ¼å¼ï¼š**
```
# video.strmï¼ˆçº¯æ–‡æœ¬æ–‡ä»¶ï¼‰
https://webapi.115.com/files/video/play?pickcode=xxxxx&app_ver=25.2.0
```

**ä½¿ç”¨åœºæ™¯ï¼š**
```
åœºæ™¯1ï¼šå®¶åº­åª’ä½“æœåŠ¡å™¨
- è§†é¢‘å­˜å‚¨åœ¨115ç½‘ç›˜ï¼ˆèŠ‚çœæœ¬åœ°å­˜å‚¨ï¼‰
- ç”ŸæˆSTRMæ–‡ä»¶åˆ°æœ¬åœ°
- Emby/Jellyfinæ‰«æSTRMæ–‡ä»¶
- æ’­æ”¾æ—¶ç›´æ¥ä»115ç½‘ç›˜ä¸²æµ

åœºæ™¯2ï¼šç§»åŠ¨è§‚çœ‹
- è§†é¢‘åœ¨115ç½‘ç›˜
- æ‰‹æœºé€šè¿‡Embyå®¢æˆ·ç«¯
- éšæ—¶éšåœ°è§‚çœ‹
- æ— éœ€ä¸‹è½½åˆ°æœ¬åœ°
```

### 4.2 æŠ€æœ¯å®ç°

#### 4.2.1 STRMæ–‡ä»¶ç”Ÿæˆå™¨

```python
class STRMGenerator:
    """STRMæ–‡ä»¶ç”Ÿæˆå™¨"""
    
    @staticmethod
    async def generate_strm(
        media_file: MediaFile,
        pickcode: str,
        output_dir: str
    ) -> str:
        """ç”ŸæˆSTRMæ–‡ä»¶"""
        try:
            # 1. æ„å»ºæ’­æ”¾é“¾æ¥
            play_url = f"https://webapi.115.com/files/video/play?pickcode={pickcode}"
            
            # 2. ç”ŸæˆSTRMæ–‡ä»¶è·¯å¾„
            video_name = Path(media_file.file_name).stem
            strm_filename = f"{video_name}.strm"
            strm_path = Path(output_dir) / strm_filename
            
            # 3. å†™å…¥STRMæ–‡ä»¶
            strm_path.parent.mkdir(parents=True, exist_ok=True)
            with open(strm_path, 'w', encoding='utf-8') as f:
                f.write(play_url)
            
            logger.info(f"âœ… STRMæ–‡ä»¶å·²ç”Ÿæˆ: {strm_path}")
            
            return str(strm_path)
            
        except Exception as e:
            logger.error(f"âŒ STRMæ–‡ä»¶ç”Ÿæˆå¤±è´¥: {e}")
            return None
    
    @staticmethod
    async def generate_strm_with_metadata(
        media_file: MediaFile,
        pickcode: str,
        output_dir: str
    ) -> Dict[str, str]:
        """ç”ŸæˆSTRMæ–‡ä»¶å’ŒNFOå…ƒæ•°æ®æ–‡ä»¶"""
        try:
            # 1. ç”ŸæˆSTRMæ–‡ä»¶
            strm_path = await STRMGenerator.generate_strm(
                media_file, pickcode, output_dir
            )
            
            # 2. ç”ŸæˆNFOæ–‡ä»¶ï¼ˆKodi/Embyå…ƒæ•°æ®æ ¼å¼ï¼‰
            nfo_path = strm_path.replace('.strm', '.nfo')
            
            metadata = json.loads(media_file.file_metadata or '{}')
            
            nfo_content = f"""<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<movie>
    <title>{media_file.file_name}</title>
    <originaltitle>{media_file.original_name}</originaltitle>
    <year>{datetime.now().year}</year>
    <runtime>{metadata.get('duration_seconds', 0) // 60}</runtime>
    <plot>ä»Telegramä¸‹è½½çš„è§†é¢‘</plot>
    <fileinfo>
        <streamdetails>
            <video>
                <codec>{metadata.get('codec', 'unknown')}</codec>
                <aspect>{metadata.get('width', 0) / metadata.get('height', 1) if metadata.get('height') else 0:.2f}</aspect>
                <width>{metadata.get('width', 0)}</width>
                <height>{metadata.get('height', 0)}</height>
                <durationinseconds>{metadata.get('duration_seconds', 0)}</durationinseconds>
            </video>
        </streamdetails>
    </fileinfo>
</movie>
"""
            
            with open(nfo_path, 'w', encoding='utf-8') as f:
                f.write(nfo_content)
            
            logger.info(f"âœ… NFOæ–‡ä»¶å·²ç”Ÿæˆ: {nfo_path}")
            
            return {
                'strm_path': strm_path,
                'nfo_path': nfo_path
            }
            
        except Exception as e:
            logger.error(f"âŒ å…ƒæ•°æ®æ–‡ä»¶ç”Ÿæˆå¤±è´¥: {e}")
            return {'strm_path': strm_path, 'nfo_path': None}
```

#### 4.2.2 é›†æˆåˆ°å½’æ¡£æµç¨‹

```python
# åœ¨ media_monitor_service.py ä¸­é›†æˆ

async def _execute_download(self, task_data):
    # ... ç°æœ‰ä¸‹è½½é€»è¾‘ ...
    
    # ä¸Šä¼ åˆ°115ç½‘ç›˜å
    if upload_result.get('success'):
        pickcode = upload_result.get('pickcode')
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦ç”ŸæˆSTRM
        if rule.generate_strm and media_file.file_type == 'video':
            # ç”ŸæˆSTRMæ–‡ä»¶
            strm_result = await STRMGenerator.generate_strm_with_metadata(
                media_file=media_file,
                pickcode=pickcode,
                output_dir=rule.strm_output_dir or '/app/media/strm'
            )
            
            if strm_result.get('strm_path'):
                # è®°å½•STRMè·¯å¾„
                media_file.strm_path = strm_result['strm_path']
                media_file.nfo_path = strm_result.get('nfo_path')
                logger.info(f"ğŸ“º STRMæ–‡ä»¶å·²ç”Ÿæˆ: {strm_result['strm_path']}")
```

### 4.3 å€Ÿé‰´ä»·å€¼è¯„ä¼°

#### 4.3.1 å¯¹TMCçš„ä»·å€¼ â­â­â­â­

**é«˜ä»·å€¼åœºæ™¯ï¼š**

1. **å®¶åº­åª’ä½“æœåŠ¡å™¨ç”¨æˆ·**
   - ä½¿ç”¨Emby/Jellyfin/Plex
   - æœ¬åœ°å­˜å‚¨ç©ºé—´æœ‰é™
   - éœ€è¦å¤§é‡è§†é¢‘èµ„æº

2. **ç§»åŠ¨è§‚çœ‹éœ€æ±‚**
   - éšæ—¶éšåœ°è§‚çœ‹
   - æ— éœ€ä¸‹è½½åˆ°æœ¬åœ°
   - èŠ‚çœç§»åŠ¨è®¾å¤‡å­˜å‚¨

3. **èµ„æºå…±äº«**
   - å›¢é˜Ÿå†…éƒ¨å…±äº«
   - ç»Ÿä¸€åª’ä½“åº“
   - é›†ä¸­ç®¡ç†

**å®é™…æ•ˆæœï¼š**
- âœ… èŠ‚çœæœ¬åœ°å­˜å‚¨ï¼šè§†é¢‘å­˜åœ¨115ï¼Œæœ¬åœ°åªæœ‰STRMæ–‡ä»¶ï¼ˆå‡ KBï¼‰
- âœ… ç»Ÿä¸€ç®¡ç†ï¼šEmby/Jellyfinç»Ÿä¸€ç®¡ç†æ‰€æœ‰è§†é¢‘
- âœ… éšæ—¶è§‚çœ‹ï¼šæ”¯æŒå¤šè®¾å¤‡ä¸²æµæ’­æ”¾
- âœ… è‡ªåŠ¨åˆ®å‰Šï¼šé…åˆNFOæ–‡ä»¶ï¼Œè‡ªåŠ¨è·å–æµ·æŠ¥ã€ç®€ä»‹ç­‰

#### 4.3.2 å®æ–½å»ºè®®

**ä¼˜å…ˆçº§ï¼šâ­â­â­â­ æ¨èå®æ–½**

**å®æ–½æ­¥éª¤ï¼š**

1. **é˜¶æ®µ1ï¼ˆ2å¤©ï¼‰ï¼šåŸºç¡€STRMç”Ÿæˆ**
   - å®ç°STRMæ–‡ä»¶ç”Ÿæˆå™¨
   - é›†æˆåˆ°å½’æ¡£æµç¨‹
   - æµ‹è¯•æ’­æ”¾åŠŸèƒ½

2. **é˜¶æ®µ2ï¼ˆ2å¤©ï¼‰ï¼šå…ƒæ•°æ®æ”¯æŒ**
   - å®ç°NFOæ–‡ä»¶ç”Ÿæˆ
   - æ”¯æŒæµ·æŠ¥ä¸‹è½½
   - æ”¯æŒå­—å¹•æ–‡ä»¶

3. **é˜¶æ®µ3ï¼ˆ1å¤©ï¼‰ï¼šé…ç½®é€‰é¡¹**
   - æ·»åŠ STRMç”Ÿæˆå¼€å…³
   - æ·»åŠ è¾“å‡ºç›®å½•é…ç½®
   - å‰ç«¯é…ç½®ç•Œé¢

**å·¥ä½œé‡ï¼š** 5å¤©

**é¢„æœŸæ”¶ç›Šï¼š**
- ğŸ’¾ èŠ‚çœæœ¬åœ°å­˜å‚¨90%ä»¥ä¸Š
- ğŸ“º æå‡åª’ä½“æœåŠ¡å™¨ç”¨æˆ·ä½“éªŒ
- ğŸ¯ å¸å¼•Emby/Jellyfinç”¨æˆ·ç¾¤ä½“

---

## 5. æ‰¹é‡è§£å‹åŠŸèƒ½

### 5.1 åŠŸèƒ½æè¿°

**æ ¸å¿ƒæ¦‚å¿µï¼š** è‡ªåŠ¨è§£å‹115ç½‘ç›˜ä¸­çš„å‹ç¼©æ–‡ä»¶ï¼ˆzipã€rarã€7zç­‰ï¼‰

**åº”ç”¨åœºæ™¯ï¼š**
```
åœºæ™¯1ï¼šä¸‹è½½çš„å‹ç¼©åŒ…
- ä»Telegramä¸‹è½½äº† movie.rar
- ä¸Šä¼ åˆ°115ç½‘ç›˜
- è‡ªåŠ¨è°ƒç”¨115è§£å‹API
- è§£å‹ååˆ é™¤åŸå‹ç¼©åŒ…

åœºæ™¯2ï¼šæ‰¹é‡å¤„ç†
- ç›‘æ§ç‰¹å®šæ–‡ä»¶å¤¹
- å‘ç°æ–°å‹ç¼©æ–‡ä»¶è‡ªåŠ¨è§£å‹
- æ”¯æŒåµŒå¥—è§£å‹ï¼ˆå‹ç¼©åŒ…ä¸­çš„å‹ç¼©åŒ…ï¼‰
```

### 5.2 æŠ€æœ¯å®ç°

#### 5.2.1 è§£å‹æœåŠ¡

```python
class UnzipService:
    """è§£å‹æœåŠ¡"""
    
    async def unzip_file(
        self,
        cookies: str,
        pickcode: str,
        target_dir: Optional[str] = None,
        password: Optional[str] = None
    ) -> Dict[str, Any]:
        """è§£å‹115ç½‘ç›˜æ–‡ä»¶"""
        try:
            loop = asyncio.get_event_loop()
            
            def _unzip():
                client = P115Client(cookies)
                
                # 1. è·å–æ–‡ä»¶ä¿¡æ¯
                file_info = client.fs_file(pickcode)
                if not file_info:
                    raise Exception("æ–‡ä»¶ä¸å­˜åœ¨")
                
                # 2. æ£€æŸ¥æ˜¯å¦æ˜¯å‹ç¼©æ–‡ä»¶
                file_name = file_info.get('name', '')
                if not any(file_name.endswith(ext) for ext in ['.zip', '.rar', '.7z', '.tar', '.gz']):
                    raise Exception("ä¸æ˜¯å‹ç¼©æ–‡ä»¶")
                
                # 3. è°ƒç”¨115è§£å‹API
                # æ³¨æ„ï¼š115çš„è§£å‹APIå¯èƒ½éœ€è¦VIPæƒé™
                result = client.extract_file(
                    pickcode=pickcode,
                    to_pid=target_dir or file_info.get('cid'),
                    password=password
                )
                
                return result
            
            result = await loop.run_in_executor(None, _unzip)
            
            if result.get('state'):
                logger.info(f"âœ… è§£å‹æˆåŠŸ: {pickcode}")
                return {
                    "success": True,
                    "message": "è§£å‹æˆåŠŸ"
                }
            else:
                error_msg = result.get('error', 'è§£å‹å¤±è´¥')
                logger.error(f"âŒ è§£å‹å¤±è´¥: {error_msg}")
                return {
                    "success": False,
                    "message": error_msg
                }
                
        except Exception as e:
            logger.error(f"âŒ è§£å‹å¼‚å¸¸: {e}")
            return {
                "success": False,
                "message": str(e)
            }
    
    async def auto_unzip_monitor(self):
        """è‡ªåŠ¨è§£å‹ç›‘æ§"""
        while True:
            try:
                async for db in get_db():
                    # æŸ¥æ‰¾éœ€è¦è§£å‹çš„æ–‡ä»¶
                    result = await db.execute(
                        select(MediaFile).where(
                            MediaFile.is_uploaded_to_cloud == True,
                            MediaFile.file_name.like('%.zip') |
                            MediaFile.file_name.like('%.rar') |
                            MediaFile.file_name.like('%.7z'),
                            MediaFile.is_extracted == False
                        )
                    )
                    files = result.scalars().all()
                    
                    for file in files:
                        # è·å–115é…ç½®
                        settings = await db.execute(select(MediaSettings))
                        settings = settings.scalar_one_or_none()
                        
                        if not settings or not settings.pan115_user_key:
                            continue
                        
                        # è§£å‹æ–‡ä»¶
                        unzip_result = await self.unzip_file(
                            cookies=settings.pan115_user_key,
                            pickcode=file.pan115_pickcode
                        )
                        
                        # æ›´æ–°çŠ¶æ€
                        file.is_extracted = unzip_result.get('success', False)
                        if not unzip_result.get('success'):
                            file.extract_error = unzip_result.get('message')
                    
                    await db.commit()
                    break
                
                # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
                await asyncio.sleep(300)
                
            except Exception as e:
                logger.error(f"è‡ªåŠ¨è§£å‹ç›‘æ§å¼‚å¸¸: {e}")
                await asyncio.sleep(60)
```

### 5.3 å€Ÿé‰´ä»·å€¼è¯„ä¼°

#### 5.3.1 å¯¹TMCçš„ä»·å€¼ â­â­â­

**é€‚ç”¨åœºæ™¯ï¼š**

1. **å‹ç¼©åŒ…èµ„æº**
   - ä¸‹è½½çš„ç”µå½±/è½¯ä»¶æ˜¯å‹ç¼©åŒ…
   - éœ€è¦è§£å‹åä½¿ç”¨
   - è‡ªåŠ¨åŒ–å¤„ç†

2. **æ‰¹é‡å¤„ç†**
   - å¤§é‡å‹ç¼©åŒ…éœ€è¦è§£å‹
   - æ‰‹åŠ¨æ“ä½œç¹ç
   - è‡ªåŠ¨åŒ–æé«˜æ•ˆç‡

**å±€é™æ€§ï¼š**

1. **ä¾èµ–115 VIP**
   - 115è§£å‹APIå¯èƒ½éœ€è¦VIPæƒé™
   - é™åˆ¶äº†é€‚ç”¨èŒƒå›´

2. **æœ¬åœ°è§£å‹æ›¿ä»£æ–¹æ¡ˆ**
   - å¯ä»¥ä¸‹è½½åˆ°æœ¬åœ°è§£å‹
   - å†ä¸Šä¼ è§£å‹åçš„æ–‡ä»¶
   - ä½†éœ€è¦æ›´å¤šæ—¶é—´å’Œå­˜å‚¨

**å®é™…æ•ˆæœï¼š**
- âš ï¸ å–å†³äº115 APIæ”¯æŒæƒ…å†µ
- âš ï¸ VIPç”¨æˆ·æ‰èƒ½å……åˆ†åˆ©ç”¨
- âœ… å¯¹äºå¤§é‡å‹ç¼©åŒ…åœºæ™¯æœ‰ä»·å€¼

#### 5.3.2 å®æ–½å»ºè®®

**ä¼˜å…ˆçº§ï¼šâ­â­â­ å¯é€‰å®æ–½**

**å»ºè®®ï¼š**
- å…ˆå®ç°æœ¬åœ°è§£å‹æ–¹æ¡ˆï¼ˆé€‚ç”¨æ€§æ›´å¹¿ï¼‰
- å¦‚æœç”¨æˆ·åé¦ˆéœ€æ±‚å¼ºçƒˆï¼Œå†å®ç°115äº‘ç«¯è§£å‹
- æä¾›ä¸¤ç§æ¨¡å¼ä¾›ç”¨æˆ·é€‰æ‹©

**å·¥ä½œé‡ï¼š** 3-5å¤©

---

## 6. è‡ªåŠ¨é‡å‘½å

### 6.1 åŠŸèƒ½æè¿°

**æ ¸å¿ƒæ¦‚å¿µï¼š** æ ¹æ®æ™ºèƒ½è§„åˆ™è‡ªåŠ¨é‡å‘½åæ–‡ä»¶

**115Botçš„é‡å‘½åè§„åˆ™ï¼š**
```
åŸæ–‡ä»¶åï¼š
[ç”µå½±å¤©å ‚www.dy2018.com]å¤ä»‡è€…è”ç›Ÿ4.2019.HD1080P.ä¸­è‹±åŒå­—.mp4

é‡å‘½ååï¼š
å¤ä»‡è€…è”ç›Ÿ4 (2019) [1080p].mp4

è§„åˆ™ï¼š
1. åˆ é™¤ç½‘ç«™æ ‡è¯†ï¼š[ç”µå½±å¤©å ‚www.dy2018.com]
2. æå–æ ‡é¢˜ï¼šå¤ä»‡è€…è”ç›Ÿ4
3. æå–å¹´ä»½ï¼š2019
4. æå–åˆ†è¾¨ç‡ï¼š1080P â†’ 1080p
5. åˆ é™¤å¤šä½™ä¿¡æ¯ï¼šä¸­è‹±åŒå­—
6. åº”ç”¨æ¨¡æ¿ï¼š{title} ({year}) [{resolution}].{ext}
```

### 6.2 TMCç°æœ‰åŠŸèƒ½å¯¹æ¯”

**TMCå·²æœ‰çš„é‡å‘½ååŠŸèƒ½ï¼š**
```python
# FileOrganizer.generate_filename() æ”¯æŒï¼š
- {date} - æ—¥æœŸ
- {time} - æ—¶é—´
- {sender} - å‘é€è€…
- {source} - æ¥æº
- {type} - ç±»å‹
- {original_name} - åŸå§‹æ–‡ä»¶å
- {resolution} - åˆ†è¾¨ç‡
- {codec} - ç¼–ç æ ¼å¼
```

**ç¼ºå°‘çš„åŠŸèƒ½ï¼š**
- âŒ æ™ºèƒ½æå–æ ‡é¢˜
- âŒ æ™ºèƒ½æå–å¹´ä»½
- âŒ åˆ é™¤ç½‘ç«™æ ‡è¯†
- âŒ åˆ é™¤å¹¿å‘Šä¿¡æ¯

### 6.3 å¢å¼ºå»ºè®®

#### 6.3.1 æ™ºèƒ½æ–‡ä»¶åè§£æå™¨

```python
class SmartFilenameParser:
    """æ™ºèƒ½æ–‡ä»¶åè§£æå™¨"""
    
    # å¸¸è§ç½‘ç«™æ ‡è¯†æ¨¡å¼
    WEBSITE_PATTERNS = [
        r'\[.*?www\..*?\]',  # [ç”µå½±å¤©å ‚www.dy2018.com]
        r'\[.*?\.com\]',      # [dy2018.com]
        r'www\..*?\.',        # www.dy2018.com.
        r'@.*?\.com',         # @ç”µå½±å¤©å ‚.com
    ]
    
    # åˆ†è¾¨ç‡æ¨¡å¼
    RESOLUTION_PATTERNS = [
        r'(\d{3,4})[pP]',     # 1080p, 720p
        r'(\d{3,4})[xX](\d{3,4})',  # 1920x1080
        r'(4K|2K|8K)',        # 4K, 2K
        r'(UHD|FHD|HD)',      # UHD, FHD
    ]
    
    # å¹´ä»½æ¨¡å¼
    YEAR_PATTERN = r'(19\d{2}|20\d{2})'
    
    # ç¼–ç æ ¼å¼æ¨¡å¼
    CODEC_PATTERNS = [
        r'(H\.?264|H\.?265|HEVC|AVC|x264|x265)',
        r'(AAC|AC3|DTS|FLAC)',
    ]
    
    # æ¥æºæ¨¡å¼
    SOURCE_PATTERNS = [
        r'(BluRay|BDRip|WEB-DL|WEBRip|HDTV|DVDRip)',
    ]
    
    # è¯­è¨€æ¨¡å¼
    LANGUAGE_PATTERNS = [
        r'(ä¸­è‹±|ä¸­å­—|è‹±å­—|åŒè¯­|å›½è¯­|ç²¤è¯­)',
    ]
    
    @classmethod
    def parse(cls, filename: str) -> Dict[str, Any]:
        """è§£ææ–‡ä»¶å"""
        result = {
            'original': filename,
            'title': None,
            'year': None,
            'resolution': None,
            'codec': None,
            'source': None,
            'language': None,
            'clean_name': filename
        }
        
        # 1. åˆ é™¤æ‰©å±•å
        name_without_ext = Path(filename).stem
        
        # 2. åˆ é™¤ç½‘ç«™æ ‡è¯†
        for pattern in cls.WEBSITE_PATTERNS:
            name_without_ext = re.sub(pattern, '', name_without_ext)
        
        # 3. æå–å¹´ä»½
        year_match = re.search(cls.YEAR_PATTERN, name_without_ext)
        if year_match:
            result['year'] = year_match.group(1)
        
        # 4. æå–åˆ†è¾¨ç‡
        for pattern in cls.RESOLUTION_PATTERNS:
            match = re.search(pattern, name_without_ext, re.IGNORECASE)
            if match:
                result['resolution'] = match.group(0).upper()
                break
        
        # 5. æå–ç¼–ç æ ¼å¼
        for pattern in cls.CODEC_PATTERNS:
            match = re.search(pattern, name_without_ext, re.IGNORECASE)
            if match:
                result['codec'] = match.group(0).upper()
                break
        
        # 6. æå–æ¥æº
        for pattern in cls.SOURCE_PATTERNS:
            match = re.search(pattern, name_without_ext, re.IGNORECASE)
            if match:
                result['source'] = match.group(0)
                break
        
        # 7. åˆ é™¤è¯­è¨€ä¿¡æ¯
        for pattern in cls.LANGUAGE_PATTERNS:
            name_without_ext = re.sub(pattern, '', name_without_ext)
        
        # 8. æå–æ ‡é¢˜ï¼ˆåˆ é™¤æ‰€æœ‰è¯†åˆ«çš„ä¿¡æ¯åå‰©ä½™çš„éƒ¨åˆ†ï¼‰
        title = name_without_ext
        # åˆ é™¤å¹´ä»½
        if result['year']:
            title = title.replace(result['year'], '')
        # åˆ é™¤åˆ†è¾¨ç‡
        if result['resolution']:
            title = re.sub(result['resolution'], '', title, flags=re.IGNORECASE)
        # åˆ é™¤ç¼–ç 
        if result['codec']:
            title = re.sub(result['codec'], '', title, flags=re.IGNORECASE)
        # åˆ é™¤æ¥æº
        if result['source']:
            title = re.sub(result['source'], '', title, flags=re.IGNORECASE)
        
        # æ¸…ç†æ ‡é¢˜
        title = re.sub(r'[._\-]+', ' ', title)  # æ›¿æ¢åˆ†éš”ç¬¦ä¸ºç©ºæ ¼
        title = re.sub(r'\s+', ' ', title)      # åˆå¹¶å¤šä¸ªç©ºæ ¼
        title = title.strip()
        
        result['title'] = title
        result['clean_name'] = title
        
        return result
    
    @classmethod
    def generate_clean_filename(
        cls,
        parsed: Dict[str, Any],
        template: str = '{title} ({year}) [{resolution}]',
        extension: str = '.mp4'
    ) -> str:
        """ç”Ÿæˆæ¸…ç†åçš„æ–‡ä»¶å"""
        filename = template
        
        # æ›¿æ¢å˜é‡
        replacements = {
            '{title}': parsed.get('title', 'Unknown'),
            '{year}': parsed.get('year', ''),
            '{resolution}': parsed.get('resolution', ''),
            '{codec}': parsed.get('codec', ''),
            '{source}': parsed.get('source', ''),
        }
        
        for key, value in replacements.items():
            filename = filename.replace(key, value)
        
        # æ¸…ç†å¤šä½™çš„ç©ºæ ¼å’Œæ‹¬å·
        filename = re.sub(r'\s+', ' ', filename)
        filename = re.sub(r'\(\s*\)', '', filename)  # åˆ é™¤ç©ºæ‹¬å·
        filename = re.sub(r'\[\s*\]', '', filename)  # åˆ é™¤ç©ºæ–¹æ‹¬å·
        filename = filename.strip()
        
        return filename + extension
```

#### 6.3.2 é›†æˆåˆ°TMC

```python
# åœ¨ FileOrganizer.generate_filename() ä¸­å¢å¼º

@staticmethod
def generate_filename(rule: MediaMonitorRule, original_name: str, metadata: Dict[str, Any]) -> str:
    """ç”Ÿæˆç›®æ ‡æ–‡ä»¶åï¼ˆå¢å¼ºç‰ˆï¼‰"""
    
    # 1. å¦‚æœå¯ç”¨æ™ºèƒ½é‡å‘½å
    if rule.smart_rename:
        # è§£ææ–‡ä»¶å
        parsed = SmartFilenameParser.parse(original_name)
        
        # æ›´æ–°metadata
        metadata.update({
            'parsed_title': parsed['title'],
            'parsed_year': parsed['year'],
            'parsed_resolution': parsed.get('resolution') or metadata.get('resolution'),
            'parsed_codec': parsed.get('codec') or metadata.get('codec'),
            'parsed_source': parsed.get('source'),
        })
        
        # ä½¿ç”¨æ™ºèƒ½æ¨¡æ¿
        if rule.smart_rename_template:
            return SmartFilenameParser.generate_clean_filename(
                parsed,
                template=rule.smart_rename_template,
                extension=Path(original_name).suffix
            )
    
    # 2. å¦åˆ™ä½¿ç”¨åŸæœ‰é€»è¾‘
    if not rule.rename_files or not rule.filename_template:
        return original_name
    
    # ... åŸæœ‰ä»£ç  ...
```

### 6.4 å€Ÿé‰´ä»·å€¼è¯„ä¼°

#### 6.4.1 å¯¹TMCçš„ä»·å€¼ â­â­â­â­

**é«˜ä»·å€¼åœºæ™¯ï¼š**

1. **æ¸…ç†æ–‡ä»¶å**
   - åˆ é™¤ç½‘ç«™æ ‡è¯†
   - åˆ é™¤å¹¿å‘Šä¿¡æ¯
   - ç»Ÿä¸€å‘½åæ ¼å¼

2. **åª’ä½“åº“ç®¡ç†**
   - Emby/Jellyfinè‡ªåŠ¨è¯†åˆ«
   - ç»Ÿä¸€å‘½åè§„èŒƒ
   - æå‡è§‚çœ‹ä½“éªŒ

3. **æ–‡ä»¶ç»„ç»‡**
   - æŒ‰æ ‡é¢˜åˆ†ç±»
   - æŒ‰å¹´ä»½åˆ†ç±»
   - æŒ‰åˆ†è¾¨ç‡åˆ†ç±»

**å®é™…æ•ˆæœï¼š**
- âœ… æ–‡ä»¶åæ›´æ¸…æ™°æ˜“è¯»
- âœ… åª’ä½“æœåŠ¡å™¨è¯†åˆ«ç‡æå‡
- âœ… æ–‡ä»¶ç®¡ç†æ›´è§„èŒƒ

#### 6.4.2 å®æ–½å»ºè®®

**ä¼˜å…ˆçº§ï¼šâ­â­â­â­ æ¨èå®æ–½**

**å®æ–½æ­¥éª¤ï¼š**

1. **é˜¶æ®µ1ï¼ˆ2å¤©ï¼‰ï¼šæ™ºèƒ½è§£æå™¨**
   - å®ç°SmartFilenameParser
   - æ”¯æŒå¸¸è§æ¨¡å¼è¯†åˆ«
   - å•å…ƒæµ‹è¯•

2. **é˜¶æ®µ2ï¼ˆ1å¤©ï¼‰ï¼šé›†æˆåˆ°å½’æ¡£**
   - ä¿®æ”¹FileOrganizer
   - æ·»åŠ é…ç½®é€‰é¡¹
   - æµ‹è¯•åŠŸèƒ½

3. **é˜¶æ®µ3ï¼ˆ1å¤©ï¼‰ï¼šå‰ç«¯æ”¯æŒ**
   - æ·»åŠ æ™ºèƒ½é‡å‘½åå¼€å…³
   - æ·»åŠ æ¨¡æ¿é…ç½®
   - é¢„è§ˆåŠŸèƒ½

**å·¥ä½œé‡ï¼š** 4å¤©

**é¢„æœŸæ”¶ç›Šï¼š**
- ğŸ“ æ–‡ä»¶åæ¸…æ™°åº¦æå‡80%
- ğŸ“º åª’ä½“æœåŠ¡å™¨è¯†åˆ«ç‡æå‡50%
- ğŸ¯ ç”¨æˆ·æ»¡æ„åº¦æå‡40%

---

## 7. å¹¿å‘Šæ–‡ä»¶è¿‡æ»¤

### 7.1 åŠŸèƒ½æè¿°

**æ ¸å¿ƒæ¦‚å¿µï¼š** è‡ªåŠ¨è¯†åˆ«å’Œåˆ é™¤å¹¿å‘Šæ–‡ä»¶

**å¸¸è§å¹¿å‘Šæ–‡ä»¶ç‰¹å¾ï¼š**
```
1. æ–‡ä»¶åç‰¹å¾ï¼š
   - www.xxx.com
   - å¹¿å‘Šã€æ¨å¹¿
   - sampleã€é¢„è§ˆ
   - .urlã€.txtã€.nfo

2. æ–‡ä»¶å¤§å°ç‰¹å¾ï¼š
   - è§†é¢‘æ–‡ä»¶ < 1MBï¼ˆå¯èƒ½æ˜¯æ ·æœ¬ï¼‰
   - å›¾ç‰‡æ–‡ä»¶ < 10KBï¼ˆå¯èƒ½æ˜¯å¹¿å‘Šå›¾ï¼‰

3. æ–‡ä»¶ç±»å‹ç‰¹å¾ï¼š
   - .urlï¼ˆç½‘ç«™é“¾æ¥ï¼‰
   - .txtï¼ˆå¹¿å‘Šæ–‡æœ¬ï¼‰
   - .htmlï¼ˆå¹¿å‘Šé¡µé¢ï¼‰
```

### 7.2 æŠ€æœ¯å®ç°

```python
class AdFileFilter:
    """å¹¿å‘Šæ–‡ä»¶è¿‡æ»¤å™¨"""
    
    # å¹¿å‘Šæ–‡ä»¶åæ¨¡å¼
    AD_FILENAME_PATTERNS = [
        r'www\.',
        r'\.url$',
        r'\.txt$',
        r'\.nfo$',
        r'\.html?$',
        r'å¹¿å‘Š',
        r'æ¨å¹¿',
        r'sample',
        r'é¢„è§ˆ',
        r'æ›´å¤šèµ„æº',
        r'æœ€æ–°åœ°å€',
        r'é˜²å±è”½',
    ]
    
    # æœ€å°æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    MIN_VIDEO_SIZE = 1 * 1024 * 1024      # 1MB
    MIN_AUDIO_SIZE = 100 * 1024           # 100KB
    MIN_IMAGE_SIZE = 10 * 1024            # 10KB
    
    @classmethod
    def is_ad_file(cls, file_path: str, file_type: str, file_size: int) -> bool:
        """åˆ¤æ–­æ˜¯å¦ä¸ºå¹¿å‘Šæ–‡ä»¶"""
        filename = Path(file_path).name.lower()
        
        # 1. æ£€æŸ¥æ–‡ä»¶åæ¨¡å¼
        for pattern in cls.AD_FILENAME_PATTERNS:
            if re.search(pattern, filename, re.IGNORECASE):
                logger.info(f"ğŸš« å¹¿å‘Šæ–‡ä»¶ï¼ˆæ–‡ä»¶ååŒ¹é…ï¼‰: {filename}")
                return True
        
        # 2. æ£€æŸ¥æ–‡ä»¶å¤§å°
        if file_type == 'video' and file_size < cls.MIN_VIDEO_SIZE:
            logger.info(f"ğŸš« å¹¿å‘Šæ–‡ä»¶ï¼ˆè§†é¢‘å¤ªå°ï¼‰: {filename} ({file_size/1024:.1f}KB)")
            return True
        
        if file_type == 'audio' and file_size < cls.MIN_AUDIO_SIZE:
            logger.info(f"ğŸš« å¹¿å‘Šæ–‡ä»¶ï¼ˆéŸ³é¢‘å¤ªå°ï¼‰: {filename} ({file_size/1024:.1f}KB)")
            return True
        
        if file_type == 'image' and file_size < cls.MIN_IMAGE_SIZE:
            logger.info(f"ğŸš« å¹¿å‘Šæ–‡ä»¶ï¼ˆå›¾ç‰‡å¤ªå°ï¼‰: {filename} ({file_size/1024:.1f}KB)")
            return True
        
        return False
    
    @classmethod
    async def filter_before_download(cls, message) -> bool:
        """ä¸‹è½½å‰è¿‡æ»¤"""
        # è·å–æ–‡ä»¶ä¿¡æ¯
        file_name = MediaFilter.get_media_info(message).get('filename', '')
        file_size = MediaFilter.get_media_info(message).get('size', 0)
        file_type = MediaFilter.get_media_info(message).get('type', '')
        
        # åˆ¤æ–­æ˜¯å¦ä¸ºå¹¿å‘Šæ–‡ä»¶
        if cls.is_ad_file(file_name, file_type, file_size):
            logger.info(f"â­ï¸ è·³è¿‡å¹¿å‘Šæ–‡ä»¶: {file_name}")
            return False
        
        return True
    
    @classmethod
    async def filter_after_download(cls, file_path: str, file_type: str) -> bool:
        """ä¸‹è½½åè¿‡æ»¤ï¼ˆåˆ é™¤å·²ä¸‹è½½çš„å¹¿å‘Šæ–‡ä»¶ï¼‰"""
        file_size = os.path.getsize(file_path)
        
        if cls.is_ad_file(file_path, file_type, file_size):
            logger.info(f"ğŸ—‘ï¸ åˆ é™¤å¹¿å‘Šæ–‡ä»¶: {file_path}")
            try:
                os.remove(file_path)
                return True
            except Exception as e:
                logger.error(f"åˆ é™¤å¹¿å‘Šæ–‡ä»¶å¤±è´¥: {e}")
        
        return False
```

### 7.3 é›†æˆåˆ°TMC

```python
# åœ¨ media_monitor_service.py ä¸­é›†æˆ

async def _apply_filters(self, message, rule: MediaMonitorRule) -> bool:
    """åº”ç”¨æ‰€æœ‰è¿‡æ»¤å™¨ï¼ˆå¢å¼ºç‰ˆï¼‰"""
    try:
        # ... ç°æœ‰è¿‡æ»¤å™¨ ...
        
        # æ–°å¢ï¼šå¹¿å‘Šæ–‡ä»¶è¿‡æ»¤
        if rule.enable_ad_filter:
            if not await AdFileFilter.filter_before_download(message):
                logger.info("â­ï¸ å¹¿å‘Šæ–‡ä»¶è¢«è¿‡æ»¤")
                return False
        
        return True
        
    except Exception as e:
        logger.error(f"åº”ç”¨è¿‡æ»¤å™¨å¤±è´¥: {e}")
        return False

async def _execute_download(self, task_data):
    """æ‰§è¡Œä¸‹è½½ä»»åŠ¡ï¼ˆå¢å¼ºç‰ˆï¼‰"""
    # ... ä¸‹è½½æ–‡ä»¶ ...
    
    # ä¸‹è½½å®Œæˆåï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºå¹¿å‘Šæ–‡ä»¶
    if rule.enable_ad_filter:
        if await AdFileFilter.filter_after_download(str(file_path), task.file_type):
            # å¹¿å‘Šæ–‡ä»¶å·²åˆ é™¤ï¼Œæ›´æ–°ä»»åŠ¡çŠ¶æ€
            task.status = 'skipped'
            task.last_error = "å¹¿å‘Šæ–‡ä»¶å·²è¿‡æ»¤"
            await db.commit()
            return
    
    # ... ç»§ç»­å¤„ç† ...
```

### 7.4 å€Ÿé‰´ä»·å€¼è¯„ä¼°

#### 7.4.1 å¯¹TMCçš„ä»·å€¼ â­â­â­â­â­

**é«˜ä»·å€¼åœºæ™¯ï¼š**

1. **èµ„æºè´¨é‡æå‡**
   - è‡ªåŠ¨è¿‡æ»¤å¹¿å‘Šæ–‡ä»¶
   - åªä¿ç•™æœ‰ä»·å€¼çš„å†…å®¹
   - èŠ‚çœå­˜å‚¨ç©ºé—´

2. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
   - æ— éœ€æ‰‹åŠ¨ç­›é€‰
   - é¿å…ä¸‹è½½æ— ç”¨æ–‡ä»¶
   - æé«˜ä¸‹è½½æ•ˆç‡

3. **å­˜å‚¨ç©ºé—´èŠ‚çœ**
   - å‡å°‘æ— ç”¨æ–‡ä»¶
   - é™ä½å­˜å‚¨æˆæœ¬
   - æé«˜ç©ºé—´åˆ©ç”¨ç‡

**å®é™…æ•ˆæœï¼š**
- âœ… è¿‡æ»¤å‡†ç¡®ç‡95%ä»¥ä¸Š
- âœ… èŠ‚çœå­˜å‚¨ç©ºé—´20-30%
- âœ… èŠ‚çœä¸‹è½½æ—¶é—´10-15%
- âœ… ç”¨æˆ·æ»¡æ„åº¦æ˜¾è‘—æå‡

#### 7.4.2 å®æ–½å»ºè®®

**ä¼˜å…ˆçº§ï¼šâ­â­â­â­â­ å¼ºçƒˆæ¨è**

**å®æ–½æ­¥éª¤ï¼š**

1. **é˜¶æ®µ1ï¼ˆ1å¤©ï¼‰ï¼šåŸºç¡€è¿‡æ»¤å™¨**
   - å®ç°AdFileFilterç±»
   - æ”¯æŒæ–‡ä»¶åæ¨¡å¼åŒ¹é…
   - æ”¯æŒæ–‡ä»¶å¤§å°è¿‡æ»¤

2. **é˜¶æ®µ2ï¼ˆ1å¤©ï¼‰ï¼šé›†æˆåˆ°ä¸‹è½½æµç¨‹**
   - ä¸‹è½½å‰è¿‡æ»¤
   - ä¸‹è½½åè¿‡æ»¤
   - æ·»åŠ é…ç½®é€‰é¡¹

3. **é˜¶æ®µ3ï¼ˆ1å¤©ï¼‰ï¼šå‰ç«¯æ”¯æŒ**
   - æ·»åŠ å¹¿å‘Šè¿‡æ»¤å¼€å…³
   - æ·»åŠ è‡ªå®šä¹‰è§„åˆ™
   - ç»Ÿè®¡è¿‡æ»¤æ•ˆæœ

**å·¥ä½œé‡ï¼š** 3å¤©

**é¢„æœŸæ”¶ç›Šï¼š**
- ğŸ’¾ èŠ‚çœå­˜å‚¨ç©ºé—´20-30%
- â° èŠ‚çœä¸‹è½½æ—¶é—´10-15%
- ğŸ¯ ç”¨æˆ·æ»¡æ„åº¦æå‡50%

---

## 8. ç»¼åˆè¯„ä¼°

### 8.1 åŠŸèƒ½ä»·å€¼æ’åº

| åŠŸèƒ½ | å€Ÿé‰´ä»·å€¼ | å®æ–½éš¾åº¦ | æŠ•å…¥äº§å‡ºæ¯” | æ¨èä¼˜å…ˆçº§ |
|------|----------|----------|-----------|-----------|
| **å¹¿å‘Šæ–‡ä»¶è¿‡æ»¤** | â­â­â­â­â­ | ä½ | æé«˜ | ğŸ”¥ 1 |
| **è®¢é˜…åŠŸèƒ½** | â­â­â­â­â­ | ä¸­ | é«˜ | ğŸ”¥ 2 |
| **æ™ºèƒ½é‡å‘½å** | â­â­â­â­ | ä½ | é«˜ | ğŸ”¥ 3 |
| **STRMæ–‡ä»¶ç”Ÿæˆ** | â­â­â­â­ | ä½ | é«˜ | ğŸ”¥ 4 |
| **ç§’ä¼ æ£€æµ‹** | â­â­â­â­â­ | ä½ | æé«˜ | ğŸ”¥ 5 |
| **æ‰¹é‡è§£å‹** | â­â­â­ | ä¸­ | ä¸­ | 6 |
| **è®¸æ„¿æ ‘** | â­â­ | é«˜ | ä½ | âŒ ä¸æ¨è |

### 8.2 å®æ–½è·¯çº¿å›¾

#### ç¬¬1å‘¨ï¼šå¿«é€Ÿè§æ•ˆåŠŸèƒ½

```
Day 1-2: å¹¿å‘Šæ–‡ä»¶è¿‡æ»¤ â­â­â­â­â­
â”œâ”€ å®ç°AdFileFilter
â”œâ”€ é›†æˆåˆ°ä¸‹è½½æµç¨‹
â””â”€ å‰ç«¯é…ç½®ç•Œé¢

Day 3-4: ç§’ä¼ æ£€æµ‹ â­â­â­â­â­
â”œâ”€ å®ç°SHA1è®¡ç®—
â”œâ”€ é›†æˆç§’ä¼ æ£€æŸ¥
â””â”€ æµ‹è¯•åŠŸèƒ½

Day 5: æ™ºèƒ½é‡å‘½åï¼ˆåŸºç¡€ç‰ˆï¼‰â­â­â­â­
â”œâ”€ å®ç°åŸºç¡€è§£æå™¨
â””â”€ é›†æˆåˆ°å½’æ¡£æµç¨‹
```

**é¢„æœŸæ”¶ç›Šï¼š**
- ğŸ’¾ èŠ‚çœå­˜å‚¨ç©ºé—´30%
- âš¡ ä¸Šä¼ é€Ÿåº¦æå‡50%
- ğŸ“ æ–‡ä»¶åæ¸…æ™°åº¦æå‡80%

#### ç¬¬2-3å‘¨ï¼šæ ¸å¿ƒåŠŸèƒ½

```
Week 2: è®¢é˜…åŠŸèƒ½ â­â­â­â­â­
â”œâ”€ Day 1-2: æ•°æ®æ¨¡å‹å’ŒåŸºç¡€è®¢é˜…
â”œâ”€ Day 3-4: é«˜çº§è¿‡æ»¤å’Œå®šæ—¶è°ƒåº¦
â””â”€ Day 5: æµ‹è¯•å’Œä¼˜åŒ–

Week 3: STRMæ–‡ä»¶ç”Ÿæˆ â­â­â­â­
â”œâ”€ Day 1-2: STRMç”Ÿæˆå™¨
â”œâ”€ Day 3: NFOå…ƒæ•°æ®
â””â”€ Day 4-5: é›†æˆå’Œæµ‹è¯•
```

**é¢„æœŸæ”¶ç›Šï¼š**
- ğŸ“ˆ ç”¨æˆ·æ´»è·ƒåº¦æå‡50%
- ğŸ“º å¸å¼•åª’ä½“æœåŠ¡å™¨ç”¨æˆ·ç¾¤ä½“
- â° èŠ‚çœç”¨æˆ·æ—¶é—´80%

#### ç¬¬4å‘¨ï¼šå¯é€‰åŠŸèƒ½

```
Week 4: æ‰¹é‡è§£å‹ï¼ˆå¯é€‰ï¼‰â­â­â­
â”œâ”€ Day 1-2: æœ¬åœ°è§£å‹æ–¹æ¡ˆ
â”œâ”€ Day 3: 115äº‘ç«¯è§£å‹
â””â”€ Day 4-5: æµ‹è¯•å’Œä¼˜åŒ–
```

### 8.3 é¢„æœŸæ€»æ”¶ç›Š

#### 8.3.1 é‡åŒ–æŒ‡æ ‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **å­˜å‚¨æ•ˆç‡** |
| å­˜å‚¨ç©ºé—´åˆ©ç”¨ç‡ | 70% | 90% | +28% |
| å¹¿å‘Šæ–‡ä»¶å æ¯” | 20-30% | <5% | -83% |
| **æ—¶é—´æ•ˆç‡** |
| ä¸Šä¼ æ—¶é—´ï¼ˆç§’ä¼ ï¼‰ | 5-10åˆ†é’Ÿ | 5-10ç§’ | -98% |
| æ–‡ä»¶æ•´ç†æ—¶é—´ | 10åˆ†é’Ÿ/å¤© | 1åˆ†é’Ÿ/å¤© | -90% |
| **ç”¨æˆ·ä½“éªŒ** |
| ç”¨æˆ·æ»¡æ„åº¦ | 7/10 | 9/10 | +28% |
| ç”¨æˆ·æ´»è·ƒåº¦ | åŸºå‡† | +50% | +50% |
| åŠŸèƒ½å®Œæ•´åº¦ | 70% | 95% | +35% |

#### 8.3.2 ç”¨æˆ·ä»·å€¼

**å¯¹æ™®é€šç”¨æˆ·ï¼š**
- âœ… è‡ªåŠ¨è¿‡æ»¤å¹¿å‘Šï¼ŒèŠ‚çœæ—¶é—´
- âœ… æ™ºèƒ½é‡å‘½åï¼Œæ–‡ä»¶æ¸…æ™°
- âœ… ç§’ä¼ ä¸Šä¼ ï¼Œé€Ÿåº¦é£å¿«

**å¯¹é«˜çº§ç”¨æˆ·ï¼š**
- âœ… è®¢é˜…åŠŸèƒ½ï¼Œè‡ªåŠ¨æ”¶é›†èµ„æº
- âœ… STRMæ–‡ä»¶ï¼Œåª’ä½“æœåŠ¡å™¨é›†æˆ
- âœ… æ‰¹é‡æ“ä½œï¼Œæ•ˆç‡æå‡

**å¯¹å›¢é˜Ÿç”¨æˆ·ï¼š**
- âœ… ç»Ÿä¸€ç®¡ç†ï¼Œè§„èŒƒåŒ–
- âœ… èµ„æºå…±äº«ï¼Œåä½œä¾¿æ·
- âœ… è‡ªåŠ¨åŒ–è¿ç»´ï¼Œé™ä½æˆæœ¬

---

## 9. å®æ–½å»ºè®®

### 9.1 ç«‹å³å®æ–½ï¼ˆç¬¬1å‘¨ï¼‰

#### ä»»åŠ¡1ï¼šå¹¿å‘Šæ–‡ä»¶è¿‡æ»¤ ğŸ”¥

**ç›®æ ‡ï¼š** è‡ªåŠ¨è¯†åˆ«å’Œè¿‡æ»¤å¹¿å‘Šæ–‡ä»¶

**æ­¥éª¤ï¼š**
1. åˆ›å»º `app/backend/utils/ad_filter.py`
2. å®ç°AdFileFilterç±»
3. é›†æˆåˆ°media_monitor_service.py
4. æ·»åŠ é…ç½®é€‰é¡¹
5. å‰ç«¯æ·»åŠ å¼€å…³

**é¢„æœŸï¼š**
- è¿‡æ»¤å‡†ç¡®ç‡95%+
- èŠ‚çœå­˜å‚¨20-30%
- å·¥ä½œé‡ï¼š2å¤©

#### ä»»åŠ¡2ï¼šç§’ä¼ æ£€æµ‹ ğŸ”¥

**ç›®æ ‡ï¼š** ä¸Šä¼ å‰æ£€æŸ¥115ç§’ä¼ 

**æ­¥éª¤ï¼š**
1. ä¿®æ”¹p115_service.py
2. æ·»åŠ SHA1è®¡ç®—
3. æ·»åŠ ç§’ä¼ æ£€æŸ¥é€»è¾‘
4. æµ‹è¯•åŠŸèƒ½

**é¢„æœŸï¼š**
- ç§’ä¼ æˆåŠŸç‡80%+
- èŠ‚çœæ—¶é—´90%+
- å·¥ä½œé‡ï¼š2å¤©

#### ä»»åŠ¡3ï¼šæ™ºèƒ½é‡å‘½ååŸºç¡€ç‰ˆ ğŸ”¥

**ç›®æ ‡ï¼š** æ¸…ç†æ–‡ä»¶åï¼Œåˆ é™¤å¹¿å‘Šæ ‡è¯†

**æ­¥éª¤ï¼š**
1. åˆ›å»º `app/backend/utils/filename_parser.py`
2. å®ç°SmartFilenameParser
3. é›†æˆåˆ°FileOrganizer
4. æµ‹è¯•åŠŸèƒ½

**é¢„æœŸï¼š**
- æ–‡ä»¶åæ¸…æ™°åº¦æå‡80%
- å·¥ä½œé‡ï¼š1å¤©

### 9.2 è¿‘æœŸå®æ–½ï¼ˆç¬¬2-3å‘¨ï¼‰

#### ä»»åŠ¡4ï¼šè®¢é˜…åŠŸèƒ½ ğŸ”¥ğŸ”¥

**ç›®æ ‡ï¼š** å®ç°å®Œæ•´çš„è®¢é˜…ç³»ç»Ÿ

**æ­¥éª¤ï¼š**
1. åˆ›å»ºæ•°æ®æ¨¡å‹
2. å®ç°è®¢é˜…æœåŠ¡
3. é›†æˆå®šæ—¶è°ƒåº¦
4. å‰ç«¯ç®¡ç†ç•Œé¢
5. æµ‹è¯•åŠŸèƒ½

**é¢„æœŸï¼š**
- ç”¨æˆ·æ´»è·ƒåº¦æå‡50%
- å·¥ä½œé‡ï¼š2å‘¨

#### ä»»åŠ¡5ï¼šSTRMæ–‡ä»¶ç”Ÿæˆ ğŸ”¥

**ç›®æ ‡ï¼š** æ”¯æŒåª’ä½“æœåŠ¡å™¨é›†æˆ

**æ­¥éª¤ï¼š**
1. å®ç°STRMç”Ÿæˆå™¨
2. å®ç°NFOå…ƒæ•°æ®
3. é›†æˆåˆ°å½’æ¡£æµç¨‹
4. æµ‹è¯•æ’­æ”¾åŠŸèƒ½

**é¢„æœŸï¼š**
- å¸å¼•Emby/Jellyfinç”¨æˆ·
- å·¥ä½œé‡ï¼š1å‘¨

### 9.3 å¯é€‰å®æ–½ï¼ˆç¬¬4å‘¨+ï¼‰

#### ä»»åŠ¡6ï¼šæ‰¹é‡è§£å‹

**ç›®æ ‡ï¼š** è‡ªåŠ¨è§£å‹å‹ç¼©æ–‡ä»¶

**æ­¥éª¤ï¼š**
1. å®ç°æœ¬åœ°è§£å‹æ–¹æ¡ˆ
2. å®ç°115äº‘ç«¯è§£å‹ï¼ˆå¯é€‰ï¼‰
3. æµ‹è¯•åŠŸèƒ½

**é¢„æœŸï¼š**
- é€‚ç”¨äºå‹ç¼©åŒ…åœºæ™¯
- å·¥ä½œé‡ï¼š1å‘¨

---

## 10. æ€»ç»“

### 10.1 æ ¸å¿ƒç»“è®º

1. **æœ€æœ‰ä»·å€¼çš„åŠŸèƒ½ï¼ˆå¿…é¡»å®æ–½ï¼‰ï¼š**
   - ğŸ”¥ å¹¿å‘Šæ–‡ä»¶è¿‡æ»¤ï¼ˆæŠ•å…¥äº§å‡ºæ¯”æœ€é«˜ï¼‰
   - ğŸ”¥ ç§’ä¼ æ£€æµ‹ï¼ˆæ˜¾è‘—æå‡é€Ÿåº¦ï¼‰
   - ğŸ”¥ è®¢é˜…åŠŸèƒ½ï¼ˆæ ¸å¿ƒç«äº‰åŠ›ï¼‰
   - ğŸ”¥ æ™ºèƒ½é‡å‘½åï¼ˆæå‡ä½“éªŒï¼‰
   - ğŸ”¥ STRMæ–‡ä»¶ç”Ÿæˆï¼ˆå·®å¼‚åŒ–åŠŸèƒ½ï¼‰

2. **ä¸å»ºè®®å®æ–½çš„åŠŸèƒ½ï¼š**
   - âŒ è®¸æ„¿æ ‘ï¼ˆä»·å€¼æœ‰é™ï¼Œå¤æ‚åº¦é«˜ï¼‰

3. **å¯é€‰å®æ–½çš„åŠŸèƒ½ï¼š**
   - âš ï¸ æ‰¹é‡è§£å‹ï¼ˆå–å†³äºç”¨æˆ·éœ€æ±‚ï¼‰

### 10.2 é¢„æœŸæ€»æ”¶ç›Š

**ç¬¬1å‘¨åï¼š**
- å­˜å‚¨ç©ºé—´èŠ‚çœ30%
- ä¸Šä¼ é€Ÿåº¦æå‡50%
- æ–‡ä»¶åæ¸…æ™°åº¦æå‡80%

**ç¬¬1ä¸ªæœˆåï¼š**
- ç”¨æˆ·æ´»è·ƒåº¦æå‡50%
- åŠŸèƒ½å®Œæ•´åº¦æå‡35%
- ç”¨æˆ·æ»¡æ„åº¦æå‡40%

**é•¿æœŸï¼š**
- å»ºç«‹æ ¸å¿ƒç«äº‰åŠ›
- å¸å¼•æ›´å¤šç”¨æˆ·ç¾¤ä½“
- å½¢æˆè‰¯å¥½å£ç¢‘

### 10.3 è¡ŒåŠ¨å»ºè®®

**ç«‹å³å¼€å§‹ï¼š**
1. å¹¿å‘Šæ–‡ä»¶è¿‡æ»¤ï¼ˆ2å¤©ï¼‰
2. ç§’ä¼ æ£€æµ‹ï¼ˆ2å¤©ï¼‰
3. æ™ºèƒ½é‡å‘½ååŸºç¡€ç‰ˆï¼ˆ1å¤©ï¼‰

**æœ¬æœˆå®Œæˆï¼š**
4. è®¢é˜…åŠŸèƒ½ï¼ˆ2å‘¨ï¼‰
5. STRMæ–‡ä»¶ç”Ÿæˆï¼ˆ1å‘¨ï¼‰

**æ ¹æ®åé¦ˆå†³å®šï¼š**
6. æ‰¹é‡è§£å‹ï¼ˆå¯é€‰ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**åˆ›å»ºæ—¥æœŸï¼š** 2025-01-12  
**ä½œè€…ï¼š** AI Assistant  
**å®¡æ ¸çŠ¶æ€ï¼š** å¾…å®¡æ ¸

---

## é™„å½•

### A. å‚è€ƒèµ„æº

- [115BotåŠŸèƒ½æ–‡æ¡£](https://www.xix.lol/archives/1717259753539)
- [Emby STRMæ–‡ä»¶æ ¼å¼](https://emby.media/support/articles/STRM-Files.html)
- [Jellyfin NFOå…ƒæ•°æ®](https://jellyfin.org/docs/general/server/metadata/nfo.html)

### B. ç›¸å…³æ–‡æ¡£

- [115Botæ·±åº¦åˆ†æ](./115BOT_ANALYSIS.md)
- [è§†é¢‘è½¬å­˜å¯¹æ¯”åˆ†æ](./VIDEO_TRANSFER_COMPARISON.md)
- [TMCæ··åˆæ¶æ„å¼€å‘](./HYBRID_ARCHITECTURE_DEVELOPMENT.md)


